
<!doctype html><head>
    <title>Windows Command Line Persistence? - SANS Internet Storm Center </title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta http-equiv="Cache-control" content="no-cache" />
    <meta property="og:site_name" content="SANS Internet Storm Center" />
    <meta property="og:locale" content="en_US" />
    <meta name="DESCRIPTION" content="SANS Internet Storm Center - A global cooperative cyber threat / internet security monitor and alert system. Featuring daily handler diaries with summarizing and analyzing new threats to networks and internet security events."/>
    <meta name="AUTHOR" content="SANS Internet Storm Center"/>
    <meta name="KEYWORDS" content="isc, sans, internet, security, threat, worm, virus, phishing, hacking, vulnerability"/>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="shortcut icon" href="/iscfavicon.ico" />
    <link rel="canonical" href="https://isc.sans.edu%2Fforums%2Findex.html" />
    <link type="text/css" rel="stylesheet" href="/css/screen.css" /><!-- this is not the comment you are looking for a6cb7499ae94e2a4f76 -->
</head><body class="isc">
<div id="container">
  <div id="topWrapper">
    <div class="g">
      <span class="threatLevel">
        Threat Level: <a href="/infocon.html">green</a>
      </span>
      <span class="currentHandler">
        Handler on Duty: <a title="Brad Duncan" href="/handler_list.html#brad-duncan">Brad Duncan</a>
      </span>
    </div>

  </div>
	<h1>
    <a href="/">SANS ISC: Windows Command Line Persistence? - SANS Internet Storm Center  <span></span></a>
    <ul class="site-selector">
      <li class="site-switcher"><a href="#"><span class="hidden">SANS Site Network</span></a>
        <ul class="sites">
          <li class="current-site">Current Site</li>
          <li class="isc"><a href="https://isc.sans.edu">
            <span></span>
            Internet Storm Center
          </a></li>
          <li class="selector-help">Other SANS Sites
            <a href="https://www.sans.org/help/site-network"><span class="hidden">Help</span></a>
          </li>
          <li class="sti"><a href="http://www.sans.edu">
            <span></span>
            Graduate Degree Programs
          </a></li>
          <li class="sans"><a href="http://www.sans.org">
            <span></span>
            Security Training
          </a></li>
          <li class="giac"><a href="http://www.giac.org">
            <span></span>
            Security Certification
          </a></li>
          <li class="awareness"><a href="http://www.securingthehuman.org">
            <span></span>
            Security Awareness Training
          </a></li>
          <li class="pentest"><a href="http://pen-testing.sans.org">
            <span></span>
            Penetration Testing
          </a></li>
          <li class="ics"><a href="http://ics.sans.org">
            <span></span>
            Industrial Control Systems
          </a></li>
          <li class="cyber-defense"><a href="http://cyber-defense.sans.org">
            <span></span>
            Cyber Defense Foundations
          </a></li>
          <li class="forensics"><a href="http://computer-forensics.sans.org">
            <span></span>
            Computer Forensics
          </a></li>
          <li class="ssi"><a href="http://software-security.sans.org">
            <span></span>
            Software Security
          </a></li>
          <li class="sic"><a href="http://sic.sans.org">
            <span></span>
            Government OnSite Training
          </a></li>
        </ul>
      </li>
    </ul>
    SANS ISC InfoSec Forums
	</h1>
	<form id="headerSearch" name="searchform" action="/search.html" method="post">
        <input type="text" name="q" placeholder="Keyword, Domain, Port, IP or Header" />
        <input type="submit" value="Search" />
	</form>
    <form id="headerLogin" method="post" action="/login.html" name="loginform">
        <input type="hidden" name="token" value="dea921df6a0f3cae1c57c0c1de8735651e8acf85" />
        <input type="text" name="email" placeholder="Email" />
        <input type="password" name="pw" autocomplete="off" placeholder="Password" />
        <input type="submit" value="Log In" /><br />
        <a href="/register.html">Sign Up for Free!</a> &nbsp; <a href="/resetpassword.html">Forgot Password?</a>
	</form>
	<div id="smallHeaderLogin">
	    <a href="/login.html">Log In</a> or <a href="/register.html">Sign Up for Free</a>!
	</div>
	<div id="content">
		<div class="wrapper">
                                <div class="beforeForumWrapper">
                                    <ul class="threadNav">
                                        <li><a href="/forums/diary/Oracle+critical+updates+released/20965/">&larr; Next Thread</a></li>
                                        <li><a href="/forums/diary/Retefe+is+back+in+town/20957/">Previous Thread &rarr;</a></li>
                                    </ul>
                                </div>
                                <table class="postList">
                                <caption>Windows Command Line Persistence?</caption>
                                        <tr class="postWrapper">
                                            <td class="content">
                                                <div class="ss-container">
                                                    <ul class="ss-share">
                                                        <li class="ss-share-item">
                                                            <a class="ss-share-link ico-facebook" title="Share on Facebook" href="http://www.facebook.com/sharer.php?u=https%3A%2F%2Fisc.sans.edu%2Fforums%2Fdiary%2F20949" rel="nofollow" target="_blank"></a>
                                                        </li>
                                                        <li class="ss-share-item">
                                                            <a class="ss-share-link ico-twitter" title="Share on Twitter" href="http://twitter.com/share?text=Windows%20Command%20Line%20Persistence%3F&amp;url=https%3A%2F%2Fisc.sans.edu%2Fforums%2Fdiary%2F20949&amp;via=SANS_ISC" rel="nofollow" target="_blank"></a>
                                                        </li>
                                                        <li class="ss-share-item">
                                                            <a class="ss-share-link ico-google" title="Share on Google+" href="http://plus.google.com/share?url=https%3A%2F%2Fisc.sans.edu%2Fforums%2Fdiary%2F20949" rel="nofollow" target="_blank"></a>
                                                        </li>
                                                    </ul>
                                                </div>
                                                <div><p>A few weeks ago, I wrote a <a href="https://isc.sans.edu/forums/diary/Improving+Bash+Forensics+Capabilities/20887/">diary</a>&nbsp;about forensics and the bash UNIX shell and last week, I attended the training FOR408 (&quot;Windows Forensics Analysis&quot;) in Amsterdam. The training was great and covered&nbsp;many ways to collect artifact&nbsp;in a Microsoft Windows environment but there was nothing about the Windows command line (&quot;cmd.exe&quot; or &quot;powershell.exe&quot;) which are common tools used by attackers or insiders. In fact, the memory analysis is covered in the training FOR508.&nbsp;To make thinks clear, the good old cmd.exe does not provide any logging facilities at all. When the process is running, it is possible to use the in-memory&nbsp;history to scroll across the previously executed commands but this is not persistent. The command doskey (this will maybe remind the good old times of MS-DOS to some of you) is still available and can be used to display the current history in the current cmd.exe:</p>

<pre style="border: 1px solid rgb(204, 204, 204); padding: 5px 10px; background: rgb(238, 238, 238);">
C:\&gt; doskey /h</pre>

<p>But how to get the history? My first idea was to check into the process memory:</p>

<pre style="border: 1px solid rgb(204, 204, 204); padding: 5px 10px; background: rgb(238, 238, 238);">
C:\&gt; procdump.exe -accepteula -ma cmd.exe cmd.dump</pre>

<p>And then search for interesting strings. Nothing! After some Google searches, I found a <a href="https://www.dfrws.org/2010/proceedings/stevens.pdf">paper</a> written in 2010 which explains how command history is managed into the computer memory. Hopefully, <a href="http://www.volatilityfoundation.org/">volatility</a> has a module which helps to&nbsp;extract&nbsp;this kind of information from a memory image:</p>

<pre style="border: 1px solid rgb(204, 204, 204); padding: 5px 10px; background: rgb(238, 238, 238);">
# ./vol.py -f laptop.dump consoles&#10;**************************************************&#10;ConsoleProcess: conhost.exe Pid: 7336&#10;Console: 0xff1c6200 CommandHistorySize: 50&#10;HistoryBufferCount: 1 HistoryBufferMax: 4&#10;OriginalTitle: %SystemRoot%\system32\cmd.exe&#10;Title: C:\WINDOWS\system32\cmd.exe&#10;AttachedProcess: cmd.exe Pid: 7308 Handle: 0x6c&#10;----&#10;CommandHistory: 0x39eab0 Application: cmd.exe Flags: Allocated, Reset&#10;CommandCount: 42 LastAdded: 41 LastDisplayed: 41&#10;FirstCommand: 0 CommandCountMax: 50&#10;ProcessHandle: 0x6c&#10;Cmd #0 at 0x3774b0: cd /&#10;Cmd #1 at 0x399e90: cd users/xmertens&#10;Cmd #2 at 0x399ec0: type secret.txt&#10;Cmd #3 at 0x3774d0: history&#10;Cmd #4 at 0x39e2a0: h&#10;Cmd #5 at 0x39e2b0: dir&#10;Cmd #6 at 0x399ef0: type secret.txt&#10;Cmd #7 at 0x39e2c0: f:&#10;Cmd #8 at 0x39e2d0: dir&#10;Cmd #9 at 0x3774f0: md cases&#10;Cmd #10 at 0x39e2e0: e:&#10;Cmd #11 at 0x39e2f0: dir&#10;Cmd #12 at 0x377510: cd tools&#10;Cmd #13 at 0x39e300: ls&#10;Cmd #14 at 0x39e310: dir&#10;Cmd #15 at 0x377530: cd PSTools&#10;Cmd #16 at 0x39e320: dir&#10;Cmd #17 at 0x377550: cd ..&#10;Cmd #18 at 0x39e330: dir&#10;Cmd #19 at 0x377570: cd ..&#10;Cmd #20 at 0x39e340: dir&#10;...&#10;&#8203;...</pre>

<p>This plugin scans for CONSOLE_INFORMATION and prints the entire screen buffer (including input and output - the type commands and results).&nbsp;But to use volatility, we need to make a copy of the target system image, this can be slow, difficult to perform. How to get an &quot;real time&quot; history of the commands?</p>

<p>The first idea is to re-use the doskey command and create macro that will dump the commands when the user exits cmd.exe. To achieve this, cmd.exe can be executed from a shortcut like this:</p>

<div style="background:#eee;border:1px solid #ccc;padding:5px 10px;">%windir%\system32\cmd.exe /k c:\scripts\cmdhist.bat</div>

<p>The .bat file will contain this line:</p>

<pre style="border: 1px solid rgb(204, 204, 204); padding: 5px 10px; background: rgb(238, 238, 238);">
@echo off&#10;&#8203;doskey exit=doskey /h $g$g &quot;%USERPROFILE%\cmd.log&quot;$t exit $*</pre>

<p>This will dump the cmd.exe history to the file cmd.log every&nbsp;time the user closes the session with &quot;exit&quot; (but&nbsp;not by closing the windows!)</p>

<pre style="border: 1px solid rgb(204, 204, 204); padding: 5px 10px; background: rgb(238, 238, 238);">
C:\&gt; cmd /k c:\scripts\cmdhist.bat&#10;C:\&gt; whoami&#10;win10vm\xavier&#10;C:\&gt; exit&#10;C:\&gt; type %USERPROFILE%/cmd.log&#10;whoami&#10;C:\&gt;</pre>

<p>This technique has many limitations but, at least, data is written on disk (and data deleted from the disk can easily be recovered if the user erases the file!).</p>

<p>Another approach is to extend the existing cmd.exe features with a more powerful&nbsp;tool like <a href="http://mridgers.github.io/clink/">Clink</a> which describes itself as&nbsp;&quot;a powerful bash-style command line editing for cmd.exe&quot;. Besides many interesting features to improve the command line, it saves the commands history by default.&nbsp;Once installed, it can be executed automatically when a cmd.exe is launched and the user&#39;s history is saved to &quot;%USERPROFILE%\AppData\Local\clink\.history&quot;. Like in a UNIX bash shell, the behavior of the history can be configured with environment variables:</p>

<ul>
	<li>history_dupe_mode</li>
	<li>history_expand_mode</li>
	<li>history_file_lines</li>
	<li>history_ignore_space</li>
	<li>history_io</li>
</ul>

<p>And what about PowerShell? Like cmd.exe, it does not have a persistent mechanism to store the commands history. Clink is reported to be compatible with PowerShell (since the latest release) but it does not work for me. An alternative is to use the PSReadLine module. I found a <a href="https://software.intel.com/en-us/blogs/2014/06/17/giving-powershell-a-persistent-history-of-commands">blog</a> post which explains how to implement history persistence in PowerShell.</p>

<p>Xavier Mertens<br />
ISC Handler - Freelance Security Consultant<br />
<a href="https://pgp.mit.edu/pks/lookup?op=get&amp;search=0x881F7C8E873FCB38">PGP Key</a></p>

<p>&nbsp;</p>
</div>
                                                <div>Tags: cmdexe, command line, history, powershell, windows</div>
                                            </td><td class="user">
                                            Xme<br />
                                                <img src="/gravatar_cache/cache/isc/a7cc8e162752a120d82325fbbf3b5e79" /><br />
                                                <span>144 Posts</span><br /><span>ISC Handler</span></td>
                                        </tr>
                                        <tr class="postFooter">
                                            <td class="actions">
                                                <a href="/forums/diary/reply/20949/">Reply</a>
                                        <a href="/forums/diary/subscribe/20949/">Subscribe</a>
                                            </td>
                                            <td class="time">
                                                2 weeks  ago
                                            </td>
                                        </tr>
                                    <tr class="postWrapper" id="36971">
                                        <td class="content">
                                            <div>A friend of mine once found the following script:<br />
@echo off<br />
setlocal EnableDelayedExpansion<br />
:getCommand<br />
set command=<br />
set /P command=%cd%^&gt;<br />
echo(!command!&gt;&gt; D:\test\1.txt<br />
call %command%<br />
goto getCommand<br />
<br />
The CMD will look the same, but it will record all commands to a file.<br />
You can put this script in the CMD.exe autorun regkey (HKCU\Software\Microsoft\Command Processor:AutoRun).</div>
                                        </td>
                                        <td class="user">
                                            Anonymous<br />
                                            <img src="/gravatar_cache/cache/isc/4d65fdc460c22554644b09789220af5a" /><br />
                                            <span>2 Posts</span></td>
                                    </tr>
                                    <tr class="postFooter">
                                        <td class="actions">
                                            <a href="/forums/diary/reply/20949/">Reply</a>
                                            <a href="/forums/diary/quote/36971">Quote</a>
                                        </td>
                                        <td class="time">
                                            2 weeks  ago
                                        </td>
                                    </tr>
                                    <tr class="postWrapper" id="36973">
                                        <td class="content">
                                            <div>Great!<br />
<br />
This can be combined with command-line Windows event creation:<br />
http://stackoverflow.com/questions/446691/how-to-create-windows-eventlog-source-from-command-line<br />
and Windows event collection/forwarding:<br />
https://msdn.microsoft.com/en-us/library/cc748890.aspx<br />
<br />
in order to get logs out of the machine, safe even if it gets compromised... :)</div>
                                        </td>
                                        <td class="user">
                                            David Andre aka Elhoim<br />
                                            <img src="/gravatar_cache/cache/isc/25a53a120c95aae19b1bf3d01e178dd4" /><br />
                                            <span>4 Posts</span></td>
                                    </tr>
                                    <tr class="postFooter">
                                        <td class="actions">
                                            <a href="/forums/diary/reply/20949/">Reply</a>
                                            <a href="/forums/diary/quote/36973">Quote</a>
                                        </td>
                                        <td class="time">
                                            2 weeks  ago
                                        </td>
                                    </tr>
                                    <tr class="postWrapper" id="36979">
                                        <td class="content">
                                            <div>If you're looking for an enterprise means to capture Powershell history, you can look into Powershell transcripts with GPO. It's not bulletproof, but it's built-in.<br />
<br />
Computer Policy: Computer Configuration &gt; Administrative Templates &gt; Windows Components &gt; Windows PowerShell &gt; Turn on PowerShell Transcription <br />
User Policy: User Configuration &gt; Administrative Templates &gt; Windows Components &gt; Windows PowerShell &gt; Turn on PowerShell Transcription<br />
<br />
If you plan to use a network share to centralize the transcripts, ensure the user has the correct rights to write data but not read it or delete it.</div>
                                        </td>
                                        <td class="user">
                                            Lucas<br />
                                            <img src="/gravatar_cache/cache/isc/83c764efc1f094de31f9474358dd8755" /><br />
                                            <span>2 Posts</span></td>
                                    </tr>
                                    <tr class="postFooter">
                                        <td class="actions">
                                            <a href="/forums/diary/reply/20949/">Reply</a>
                                            <a href="/forums/diary/quote/36979">Quote</a>
                                        </td>
                                        <td class="time">
                                            2 weeks  ago
                                        </td>
                                    </tr>
                                    <tr class="postWrapper" id="36983">
                                        <td class="content">
                                            <div>My method for capturing cmd line activity is a little more simple.<br />
<br />
In Adv Audit policy - enable 'new process creation' which kicks off a very noisy event ID 4688.  With this I am able to capture the cmd.exe process within the event.<br />
<br />
Now, within the win admin templates we enable &lsquo;Include command line in process creation events&rsquo; which provides us with the process plus the cmd input like so:<br />
<br />
cmd.exe<br />
ping 1.1.1.1 (or any other command)<br />
<br />
This capability is also available in powershell since the introduction of enhanced auditing features in ps-v5.<br />
<br />
This event can now be captured within splunk as part of your behavioural and suspicious activity analytics.  A watch-list can be created by utilising splunk lookups for suspicious ps cmdlets or other shell commands of interest that go towards your library of IOCs.<br />
<br />
And thanks to Xaviers previous post on Bash forensics &ndash; I now have a plan to implement this technique across my nix boxes &ndash; thanks Xavier.</div>
                                        </td>
                                        <td class="user">
                                            Anonymous<br />
                                            <img src="/gravatar_cache/cache/isc/331bcbb98c863aa2bf08fb2bdda80d59" /><br />
                                            <span>1 Posts</span></td>
                                    </tr>
                                    <tr class="postFooter">
                                        <td class="actions">
                                            <a href="/forums/diary/reply/20949/">Reply</a>
                                            <a href="/forums/diary/quote/36983">Quote</a>
                                        </td>
                                        <td class="time">
                                            2 weeks  ago
                                        </td>
                                    </tr>
                                </table>
                                <div class="afterForumWrapper">
                                    <ul class="threadNav">
                                        <li><a href="/forums/diary/Oracle+critical+updates+released/20965/">&larr; Next Thread</a></li>
                                        <li><a href="/forums/diary/Retefe+is+back+in+town/20957/">Previous Thread &rarr;</a></li>
                                    </ul>
                                </div><p><a href="/register.html">Sign Up for Free</a> or <a href="/login.html">Log In</a> to start participating in the conversation!</p>
        </div>
    </div>
    <div id="navigation">
        <ul>
            <li><a href="/contact.html">Contact Us</a>
                <ul>
                    <li class="first"><a href="/about.html">About Us</a></li>
                    <li><a href="/handler_list.html">Handlers</a></li>
                    <li><a href="/events">Events</a></li>
                </ul>
            </li>
            <li><a href="/diaryarchive.html">Diary</a></li>
            <li><a href="/podcast.html">Podcasts</a></li>
            <li><a href="/jobs">Jobs</a></li>
            <li><a href="/newssummary.html">News</a></li>
            <li><a href="/tools/">Tools</a>
                <ul>
                    <li class="first"><a href="/howto.html">DShield Sensor</a></li>
                    <li><a href="/404project/">404Project</a></li>
                    <li><a href="/glossary.html">InfoSec Glossary</a></li>
                    <li><a href="/webhoneypot/index.html">Webhoneypot</a></li>
                    <li><a href="/fightback.html">Fightback</a></li>
                </ul>
            </li>
            <li><a href="/reports.html">Data</a>
                <ul>
                    <li><a href="/ssh.html">SSH Scanning Activity</a></li>
                    <li><a href="/crls.html">SSL CRL Activity</a></li>
                    <li><a href="/port.html">TCP/UDP Port Activity</a></li>
                    <li><a href="/httpheaders/">HTTP Header Activity</a></li>
                    <li><a href="/threatfeed.html">Threat Feeds Activity</a></li>
                    <li><a href="/threatmap.html">Threat Feeds Map</a></li>
                    <li><a href="/suspicious_domains.html">Suspicious Domains</a></li>
                    <li><a href="/presentations/">Presentations &amp; Papers</a></li>
                    <li><a href="/links.html">Useful InfoSec Links</a></li>
                    <li><a href="/poll.html">InfoSec Poll Results</a></li>
                </ul>
            </li>
            <li class="active"><a href="/forums/">Forums</a>
                <ul>
                    <li><a href="/forums/Auditing/">Auditing</a></li>
                    <li><a href="/forums/Diary+Discussions/">Diary Discussions</a></li>
                    <li><a href="/forums/Forensics/">Forensics</a></li>
                    <li><a href="/forums/General+Discussion/">General Discussions</a></li>
                    <li><a href="/forums/Industry+News/">Industry News</a></li>
                    <li><a href="/forums/Network+Security/">Network Security</a></li>
                    <li><a href="/forums/Penetration+Testing/">Penetration Testing</a></li>
                    <li><a href="/forums/Software+Security/">Software Security</a></li>
                </ul>
            </li>
        </ul>
    </div>
    <div id="sidebar">
        <p>Subscribe to the Internet Storm Center <a href="https://www.youtube.com/channel/UCfbOsqPmWg1H_34hTjKEW2A">YouTube Channel</a></p>
        <iframe width="160" height="600" src="https://www.sans.org/banners/isc_ss.php" frameborder="0" scrolling="no" marginheight="0" marginwidth="0"></iframe>
	</div>
</div>
<div id="footer">
	<ul id="socialIconsFoot">
        <li><a href="https://www.youtube.com/channel/UCfbOsqPmWg1H_34hTjKEW2A">YouTube<span></span></a></li>
        <li class="twitter"><a href="http://twitter.com/sans_isc">Twitter<span></span></a></li>
        <li class="linkedin"><a href="http://www.linkedin.com/groups?gid=35470">LinkedIn<span></span></a></li>
        <li class="rss"><a href="/xml.html">ISC Feed<span></span></a></li>
	</ul>
	<a class="sans" href="https://www.sans.edu/"><span></span></a>
	<ul id="footLinks">
        <li><a href="http://www.cafepress.com/stormcenter">Shop</a></li>
        <li><a href="/linkback.html">Link To Us</a></li>
        <li><a href="/about.html">About Us</a></li>
        <li><a href="/handler_list.html">Handlers</a></li>
        <li><a href="/privacy.html">Privacy Policy</a></li>
        <li><a href="#top">Back To Top</a></li>
	</ul>
	<strong>Developers:</strong> We have an <a href="/api/">API</a> for you! &nbsp; <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img alt="Creative Commons License" src="/images/cc.png" /></a>
</div>
</body></html>