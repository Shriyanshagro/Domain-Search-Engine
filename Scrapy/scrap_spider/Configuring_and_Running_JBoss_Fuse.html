<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html><html xmlns="http://www.w3.org/1999/xhtml" class="chrometwo"><head><title>19.6. Patching a Fabric Container with a Rollup Patch</title><meta name="generator" content="publican v4.3.2"/><meta name="description" content="Follow the procedures described in this section to patch a Fabric container with a rollup patch."/><meta name="keywords" content="fabric container, fabric, profile, container, profile version, version, management console"/><meta name="keywords" content="patching"/><meta name="keywords" content="ESB, Apache ServiceMix, Open Source, open source, integration, OSGi, enterprise service bus, Apache ServiceMix documentation, Apache Karaf, Red Hat JBoss Fuse, Red Hat JBoss Fuse documentation"/><link rel="prev" href="ESBRuntimeCustomAssembly.html" title="19.5. Patching a Custom Assembly"/><link rel="next" href="ESBRuntimePatchFabric.html" title="19.7. Patching a Fabric Container with an Incremental Patch"/><link rel="copyright" href="tmdisclaim.html" title="Trademark Disclaimer"/><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/><link rel="stylesheet" type="text/css" href="../../../../../chrome.css"/><link rel="stylesheet" type="text/css" href="../../../../../db5.css"/><link rel="stylesheet" type="text/css" href="../../../../../RedHat-db5-201405/en-US/css/brand.css"/><link rel="stylesheet" type="text/css" href="../../../../../print.css" media="print"/><link rel="stylesheet" type="text/css" href="../../../../../site_overrides.css"/><script type="text/javascript" src="../../../../labels.js"> </script><link rel="stylesheet" href="https://access.redhat.com/chrome_themes/umbra/s/chrometwo.css"/><script type="text/javascript" src="../../../../../common-db5/en-US/scripts/highlight.js/highlight.pack.js"> </script><script src="https://access.redhat.com/webassets/avalon/j/lib/require.js"> </script><script type="text/javascript" src="../../../../../toc.js"> </script><script type="text/javascript" src="../../../../../common-db5/en-US/scripts/utils.js"> </script></head><body class="chrometwo "><div id="chrometwo"><div id="main"><ul class="docnav top"><li class="previous"><a accesskey="p" href="ESBRuntimeCustomAssembly.html"><strong>Prev</strong></a></li><li class="next"><a accesskey="n" href="ESBRuntimePatchFabric.html"><strong>Next</strong></a></li></ul><div id="navigation"> </div><section class="section" id="ESBRuntimePatchFabricRollup"><div class="titlepage"><div><div><h2 class="title">19.6. Patching a Fabric Container with a Rollup Patch</h2></div><div><div class="abstract"><p class="title"><strong>Abstract</strong></p><div class="para">
						Follow the procedures described in this section to patch a Fabric container with a <span class="emphasis"><em>rollup patch</em></span>.
					</div></div></div></div></div><section class="simplesect" id="idp23963136"><div class="titlepage"><div><div><h3 class="title">Overview</h3></div></div></div><div class="para">
				A rollup patch updates <span class="emphasis"><em>bundle JARs</em></span>, other <span class="emphasis"><em>Maven artifacts</em></span>, <span class="emphasis"><em>libraries</em></span>, and <span class="emphasis"><em>static files</em></span> in a Fabric. The following aspects of the fabric are affected:
			</div><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><div class="para">
						Distribution of patched artifacts through Maven proxy
					</div></li><li class="listitem"><div class="para">
						Profiles
					</div></li><li class="listitem"><div class="para">
						Configuration of the underlying container
					</div></li></ul></div><div class="admonition important"><div class="admonition_header">Important</div><div><div class="para">
					The instructions in this section apply only to JBoss Fuse versions 6.2.1 and later, which support the new patching mechanism.
				</div></div></div></section><section class="simplesect" id="idp23967296"><div class="titlepage"><div><div><h3 class="title">Distribution of patched artifacts through Maven proxy</h3></div></div></div><div class="para">
				When you install the incremental patch on your local container, the patch artifacts are installed into the local <code class="code">system/</code> directory, whose directory structure is laid out like a Maven repository. The local container distributes these patch artifacts to remote containers by behaving as a Maven proxy, enabling remote containers to upload bundle JARs as needed (this process is managed by the Fabric agent running on each Fabric container). For more details, see <a class="link" href="https://access.redhat.com/documentation/en-US/Red_Hat_JBoss_Fuse/6.2.1/html/Fabric_Guide/FabricMavenProxy.html">chapter "Fabric Maven Proxies" in "Fabric Guide"</a>.
			</div></section><section class="simplesect" id="idp23856696"><div class="titlepage"><div><div><h3 class="title">Profiles</h3></div></div></div><div class="para">
				The rollup patching process updates all of the standard profiles, so that they reference the patched dependencies. Any custom profiles that you created yourself remain unaffected by these updates. However, in cases where you have already made some changes directly to the <span class="emphasis"><em>standard profiles</em></span> (such as <code class="code">default</code>, <code class="code">fabric</code>, <code class="code">karaf</code>, and so on), the patching mechanism attempts to merge your changes with the changes introduced by the patch.
			</div><div class="admonition important"><div class="admonition_header">Important</div><div><div class="para">
					In the case where you have modified standard profiles, it is recommended that you verify your custom changes are preserved after patching. This is particularly important with respect to any changes made to the location of Maven repositories (which are usually configured in the <code class="code">default</code> profile).
				</div></div></div></section><section class="simplesect" id="idp23859768"><div class="titlepage"><div><div><h3 class="title">Configuration of the underlying container</h3></div></div></div><div class="para">
				If required, the rollup patching mechanism is capable of patching the underlying container (that is, files located under <code class="code">etc/</code>, <code class="code">lib/</code>, and so on). When a Fabric container is upgraded to a patched version (for example, using the <code class="code">fabric:container-upgrade</code> command), the container's Fabric agent checks whether the underlying container must be patched. If yes, the Fabric agent triggers the patching mechanism to update the underlying container. Moreover, if certain critical files are updated (for example, <code class="code">lib/karaf.jar</code>), the container status changes to <code class="code">requires full restart</code> after the container is upgraded. This status indicates that a full <span class="emphasis"><em>manual</em></span> restart is required (an automatic restart is not possible in this case).
			</div></section><section class="simplesect" id="idp23862568"><div class="titlepage"><div><div><h3 class="title">io.fabric.version in the default profile</h3></div></div></div><div class="para">
				The <code class="code">io.fabric.version</code> resource in the <code class="code">default</code> profile plays a key role in the patching mechanism. This resource defines the version and build of JBoss Fuse and of all of its main components. When upgrading (or rolling back) a Fabric container to a new version, the Fabric agent checks the version and build of JBoss Fuse as defined in the <code class="code">io.fabric.version</code> resource. If the JBoss Fuse version changes between the original profile version and the upgraded profile version, the Fabric agent knows that an upgrade of the underlying container is required when upgrading to this profile version.
			</div></section><section class="simplesect" id="idp23864608"><div class="titlepage"><div><div><h3 class="title">Applying a rollup patch</h3></div></div></div><a id="idp23865024" class="indexterm"></a><a id="idp19089304" class="indexterm"></a><div class="para">
				To apply a rollup patch to a Fabric container:
			</div><div class="procedure"><ol class="procedure" type="1"><li class="step"><div class="para">
						Add the patch to the container's environment using the <span class="command"><strong>patch:add</strong></span> command. For example, to add the <code class="code"><em class="replaceable">patch</em>.zip</code> patch file:
					</div><pre class="programlisting">JBossFuse:karaf@root&gt; patch:add file://<em class="replaceable">patch</em>.zip
[name]            [installed] [description]                   
<em class="replaceable">PatchID</em>         false       <em class="replaceable">Description</em></pre></li><li class="step"><div class="para">
						Create a new version, using the <code class="code">fabric:version-create</code> command:
					</div><pre class="programlisting">JBossFuse:karaf@root&gt; fabric:version-create 1.1
Created version: 1.1 as copy of: 1.0</pre><div class="admonition important"><div class="admonition_header">Important</div><div><div class="para">
							The version name must be a pure <span class="emphasis"><em>numeric</em></span> string, such as <code class="code">1.1</code>, <code class="code">1.2</code>, <code class="code">2.1</code>, or <code class="code">2.2</code>. You cannot incorporate alphabetic characters in the version name (such as <code class="code">1.0.patch</code>).
						</div></div></div></li><li class="step"><div class="para">
						Apply the patch to the new version, using the <code class="code">patch:fabric-install</code> command. Note that in order to run this command you <span class="emphasis"><em>must</em></span> provide the credentials, <code class="code"><em class="replaceable">Username</em></code> and <code class="code"><em class="replaceable">Password</em></code>, of a user with <code class="code">Administrator</code> privileges. For example, to apply the <code class="code"><em class="replaceable">PatchID</em></code> patch to version <code class="code">1.1</code>:
					</div><pre class="programlisting">patch:fabric-install --username <em class="replaceable">Username</em> --password <em class="replaceable">Password</em> --upload --version 1.1 <em class="replaceable">PatchID</em></pre></li><li class="step"><div class="para">
						Synchronize the patch information across the fabric, to ensure that the profile changes in version <code class="code">1.1</code> are propagated to all containers in the fabric (particularly remote SSH containers). Enter the following console command:
					</div><pre class="programlisting">patch:fabric-synchronize</pre></li><li class="step"><div class="para">
						Upgrade each existing container in the fabric using the <code class="code">fabric:container-upgrade</code> command (but leaving the root container, where you installed the patch, until last). For example, to upgrade a container named <code class="code">remote</code>, enter the following command:
					</div><pre class="programlisting">JBossFuse:karaf@root&gt; fabric:container-upgrade 1.1 remote
Upgraded container remote from version 1.0 to 1.1</pre><div class="para">
						At this point, not only does the Fabric agent download and install the patched bundles into the specified container, but <span class="emphasis"><em>the agent also applies the patch to the underlying container</em></span> (updating any static files in the container, if necessary). If necessary, the agent will then restart the target container automatically or set the container status to <code class="code">requires full restart</code> (if an automatic restart is not possible), so that any changes made to the static files are applied to the running container.
					</div><div class="admonition important"><div class="admonition_header">Important</div><div><div class="para">
							It is recommended that you upgrade only one or two containers to the patched profile version, to ensure that the patch does not introduce any new issues.
						</div></div></div></li><li class="step"><div class="para">
						If the current status of the upgraded container is <code class="code">requires full restart</code>, you must now use one of the standard mechanisms to stop and restart the container manually. In some cases, it will be possible to do this using Fabric commands from the console of the root container.
					</div><div class="para">
						For example, you could stop the <code class="code">remote</code> container as follows:
					</div><pre class="programlisting">fabric:container-stop remote</pre><div class="para">
						And restart the <code class="code">remote</code> container as follows:
					</div><pre class="programlisting">fabric:container-start remote</pre><div class="para">
						For more details, see <a class="xref" href="ESBRuntimeFabricShutDown.html" title="Chapter 7. Shutting Down a Fabric">Chapter 7, <em>Shutting Down a Fabric</em></a>.
					</div></li><li class="step"><div class="para">
						Upgrade the root container last (that is, the container that you originally installed the patch on):
					</div><pre class="programlisting">fabric:container-upgrade 1.1 root</pre></li></ol></div></section><section class="simplesect" id="idp21516040"><div class="titlepage"><div><div><h3 class="title">Rolling back a rollup patch</h3></div></div></div><div class="para">
				To roll back a rollup patch on a Fabric container, use the <code class="code">fabric:container-rollback</code> command. For example, assuming that <code class="code">1.0</code> is an unpatched profile version, you can roll the <code class="code">remote</code> container back to the unpatched version <code class="code">1.0</code> as follows:
			</div><pre class="programlisting">fabric:container-rollback 1.0 remote</pre><div class="para">
				At this point, not only does the Fabric agent roll back the installed profiles to an earlier version, but <span class="emphasis"><em>the agent also rolls back the patch on the underlying container</em></span> (restoring any static files to the state they were in before the patch was applied, if necessary). If necessary, the agent will then restart the target container automatically or set the container status to <code class="code">requires full restart</code> (if an automatic restart is not possible), so that any changes made to the static files are applied to the running container.
			</div><div class="admonition warning"><div class="admonition_header">Warning</div><div><div class="para">
					Rolling back the patch level from version 6.2.1 to 6.2.0 is <span class="emphasis"><em>not supported</em></span> in JBoss Fuse Fabric. This is a special case, because the version 6.2.0 Fabric agent does not support the new patching mechanism.
				</div></div></div></section></section><ul class="docnav bottom"><li class="previous"><a accesskey="p" href="ESBRuntimeCustomAssembly.html"><strong>Prev</strong></a></li><li class="next"><a accesskey="n" href="ESBRuntimePatchFabric.html"><strong>Next</strong></a></li></ul></div></div><script type="text/javascript">
                        current_book = 'Configuring_and_Running_JBoss_Fuse';
                        current_version = '6.2.1';
                        current_product = 'Red_Hat_JBoss_Fuse';
                    

                        docs.init('../../../..', current_product, current_version, current_book);
                    </script></body></html>
