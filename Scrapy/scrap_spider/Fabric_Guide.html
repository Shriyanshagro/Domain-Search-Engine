<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html><html xmlns="http://www.w3.org/1999/xhtml" class="chrometwo"><head><title>Fabric Guide</title><meta name="generator" content="publican v4.3.2"/><meta name="description" content="Fabric enables you to install, start up, and provision remote containers across a network with support for centralized, highly available container configuration, based on Apache Zookeeper."/><meta name="keywords" content="ESB, Apache ServiceMix, Open Source, open source, integration, OSGi, enterprise service bus, Apache ServiceMix documentation, Apache Karaf, Red Hat JBoss Fuse, Red Hat JBoss Fuse documentation"/><meta name="keywords" content="Red Hat JBoss Fuse, OSGi"/><link rel="next" href="#PartBasic" title="Part I. Basic Fabric Deployment"/><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/><link rel="stylesheet" type="text/css" href="../../../../../chrome.css"/><link rel="stylesheet" type="text/css" href="../../../../../db5.css"/><link rel="stylesheet" type="text/css" href="../../../../../RedHat-db5-201405/en-US/css/brand.css"/><link rel="stylesheet" type="text/css" href="../../../../../print.css" media="print"/><link rel="stylesheet" type="text/css" href="../../../../../site_overrides.css"/><script type="text/javascript" src="../../../../labels.js"> </script><link rel="stylesheet" href="https://access.redhat.com/chrome_themes/umbra/s/chrometwo.css"/><script type="text/javascript" src="../../../../../common-db5/en-US/scripts/highlight.js/highlight.pack.js"> </script><script src="https://access.redhat.com/webassets/avalon/j/lib/require.js"> </script><script type="text/javascript" src="../../../../../toc.js"> </script><script type="text/javascript" src="../../../../../common-db5/en-US/scripts/utils.js"> </script></head><body class="chrometwo "><div id="chrometwo"><div id="main"><div id="navigation"> </div><div xml:lang="en-US" class="book" id="Fabric"><div class="titlepage"><div><div class="producttitle"><span class="productname">Red Hat JBoss Fuse</span> </div><div><h1 class="title">Fabric Guide</h1></div><div><h2 class="subtitle">A system for provisioning containers deployed across a network</h2></div><div><div class="author"><h3 class="author">Red Hat</h3></div></div><div><div class="releaseinfo">Version 6.2</div></div><div><p class="copyright">Copyright © 2011-2015 Red Hat, Inc. and/or its affiliates.</p></div><div><div class="legalnotice" id="tmdisclaim"><h1 class="legalnotice">Legal Notice</h1><p class="legalnotice-title"><strong>Trademark Disclaimer</strong></p><div class="para">
				The text of and illustrations in this document are licensed by Red Hat under a Creative Commons Attribution–Share Alike 3.0 Unported license ("CC-BY-SA"). An explanation of CC-BY-SA is available at <a class="link" href="http://creativecommons.org/licenses/by-sa/3.0/">http://creativecommons.org/licenses/by-sa/3.0/</a>. In accordance with CC-BY-SA, if you distribute this document or an adaptation of it, you must provide the URL for the original version.
			</div><div class="para">
				Red Hat, as the licensor of this document, waives the right to enforce, and agrees not to assert, Section 4d of CC-BY-SA to the fullest extent permitted by applicable law.
			</div><div class="para">
				Red Hat, Red Hat Enterprise Linux, the Shadowman logo, JBoss, MetaMatrix, Fedora, the Infinity Logo, and RHCE are trademarks of Red Hat, Inc., registered in the United States and other countries.
			</div><div class="para">
				Apache, ServiceMix, Camel, CXF, and ActiveMQ are trademarks of Apache Software Foundation. Any other names contained herein may be trademarks of their respective owners.
			</div></div></div><div><div class="pubdate">12 Nov 2015</div></div><div><div class="abstract"><p class="title"><strong>Abstract</strong></p><div class="para">
				Fabric enables you to install, start up, and provision remote containers across a network with support for centralized, highly available container configuration, based on Apache Zookeeper.
			</div></div></div></div><hr/></div><div class="toc"><ul class="toc"><li><span class="part"><a href="#PartBasic">I. Basic Fabric Deployment</a></span><ul><li><span class="chapter"><a href="#GetStart">1. Getting Started with Fuse Fabric</a></span><ul><li><span class="section"><a href="#Deploy-Fabric-Create">1.1. Create a Fabric</a></span></li><li><span class="section"><a href="#Deploy-Fabric-DeployProfile">1.2. Deploy a Profile</a></span></li><li><span class="section"><a href="#Deploy-Fabric-UpdateProfile">1.3. Update a Profile</a></span></li><li><span class="section"><a href="#idp19152208">1.4. Shutting Down the Containers</a></span></li></ul></li><li><span class="chapter"><a href="#ESBRuntimeFabricCreate">2. Creating a New Fabric</a></span></li><li><span class="chapter"><a href="#Chapter-Fabric_Container">3. Fabric Containers</a></span><ul><li><span class="section"><a href="#ContChild">3.1. Child Containers</a></span></li><li><span class="section"><a href="#ContSSH">3.2. SSH Containers</a></span></li><li><span class="section"><a href="#ContWin">3.3. Fabric Containers on Windows</a></span></li><li><span class="section"><a href="#ContCloud">3.4. Cloud Containers</a></span><ul><li><span class="section"><a href="#ContCloud-Prepare">3.4.1. Preparing to use Fabric in the Cloud</a></span></li><li><span class="section"><a href="#ContCloud-Admin">3.4.2. Administering Cloud Containers</a></span></li></ul></li></ul></li><li><span class="chapter"><a href="#Profiles">4. Fabric Profiles</a></span><ul><li><span class="section"><a href="#Profiles-Intro">4.1. Introduction to Profiles</a></span></li><li><span class="section"><a href="#Profiles-Working">4.2. Working with Profiles</a></span></li><li><span class="section"><a href="#Profiles-Versions">4.3. Profile Versions</a></span></li></ul></li><li><span class="chapter"><a href="#F8Plugin">5. Fabric8 Maven Plug-In</a></span><ul><li><span class="section"><a href="#F8Plugin-Prepare">5.1. Preparing to Use the Plug-In</a></span></li><li><span class="section"><a href="#F8Plugin-Using">5.2. Using the Plug-In to Deploy a Maven Project</a></span></li><li><span class="section"><a href="#F8Plugin-Config">5.3. Configuring the Plug-In</a></span></li><li><span class="section"><a href="#F8Plugin-Props">5.4. Configuration Properties</a></span></li></ul></li><li><span class="chapter"><a href="#MQ">6. ActiveMQ Brokers and Clusters</a></span><ul><li><span class="section"><a href="#MQ-Creating">6.1. Creating a Standalone Broker Instance</a></span></li><li><span class="section"><a href="#MQ-Connecting">6.2. Connecting to a Broker</a></span></li><li><span class="section"><a href="#MQ-Topol">6.3. Topologies</a></span><ul><li><span class="section"><a href="#MQ-Topol-LoadBal">6.3.1. Load-Balancing Cluster</a></span></li><li><span class="section"><a href="#MQ-Topol-MasterSlave">6.3.2. Master-Slave Cluster</a></span></li><li><span class="section"><a href="#MQ-Topol-BrokerNetworks">6.3.3. Broker Networks</a></span></li></ul></li><li><span class="section"><a href="#MQ-BrokerConfig">6.4. Broker Configuration</a></span></li></ul></li></ul></li><li><span class="part"><a href="#PartProd">II. Fabric in Production</a></span><ul><li><span class="chapter"><a href="#Ensemble">7. Fabric Ensemble and Registry</a></span><ul><li><span class="section"><a href="#Ensemble-Registry">7.1. Fabric Registry</a></span></li><li><span class="section"><a href="#Ensemble-Admin">7.2. Administering a Fabric Ensemble</a></span></li></ul></li><li><span class="chapter"><a href="#Agents">8. Fabric Agents</a></span><ul><li><span class="section"><a href="#Agents-Intro">8.1. Introduction</a></span></li><li><span class="section"><a href="#Agents-ConfigAdmin">8.2. The Configuration Admin Bridge</a></span></li><li><span class="section"><a href="#Agents-Deploy">8.3. The Deployment Agent</a></span></li></ul></li><li><span class="chapter"><a href="#Ports">9. Allocating Ports</a></span><ul><li><span class="section"><a href="#Ports-Service">9.1. The Port Service</a></span></li><li><span class="section"><a href="#Ports-Using">9.2. Using the Port Service</a></span></li></ul></li><li><span class="chapter"><a href="#Gateway">10. Gateway</a></span><ul><li><span class="section"><a href="#Gateway-Arch">10.1. Gateway Architecture</a></span></li><li><span class="section"><a href="#Gateway-Running">10.2. Running the Gateway</a></span></li><li><span class="section"><a href="#Gateway-Config">10.3. Configuring the Gateway</a></span></li><li><span class="section"><a href="#Gateway-Version">10.4. Versioning</a></span></li><li><span class="section"><a href="#Gateway-URITempl">10.5. URI Template Expressions</a></span></li></ul></li><li><span class="chapter"><a href="#FMCManageAuthentication">11. Securing Fabric Containers</a></span></li><li><span class="chapter"><a href="#FESBFabricMavenProxyConfig">12. Configuring a Fabric's Maven Proxy</a></span></li><li><span class="chapter"><a href="#Offline">13. Offline Repositories</a></span><ul><li><span class="section"><a href="#Offline-Profile">13.1. Offline Repository for a Profile</a></span></li><li><span class="section"><a href="#Offline-Version">13.2. Offline Repository for a Version</a></span></li><li><span class="section"><a href="#Offline-Maven">13.3. Offline Repository for a Maven Project</a></span></li></ul></li><li><span class="chapter"><a href="#Git">14. Configuring with Git</a></span><ul><li><span class="section"><a href="#Git-HowItWorks">14.1. How Git Works inside Fabric</a></span></li><li><span class="section"><a href="#Git-Cluster">14.2. Using a Git Cluster</a></span></li><li><span class="section"><a href="#Git-Proxy">14.3. Using a Git HTTP Proxy</a></span></li><li><span class="section"><a href="#Git-External">14.4. Using an External Git Repository</a></span></li><li><span class="section"><a href="#Git_HTTP-proxy">14.5. Using an HTTP Proxy with a Git Cluster</a></span></li></ul></li><li><span class="chapter"><a href="#Patching">15. Patching</a></span><ul><li><span class="section"><a href="#ESBRuntimePatchFabric">15.1. Patching a Container in a Fabric</a></span></li></ul></li></ul></li><li><span class="appendix"><a href="#ProfileEdit">A. Editing Profiles with the Built-In Text Editor</a></span><ul><li><span class="section"><a href="#ProfileEdit-AgentProps">A.1. Editing Agent Properties</a></span></li><li><span class="section"><a href="#ProfileEdit-PIDProps">A.2. Editing OSGi Config Admin Properties</a></span></li><li><span class="section"><a href="#ProfileEdit-OtherResources">A.3. Editing Other Resources</a></span></li><li><span class="section"><a href="#ProfileEdit-Attributes">A.4. Profile Attributes</a></span></li></ul></li><li><span class="appendix"><a href="#UrlHandlers">B. Fabric URL Handlers</a></span><ul><li><span class="section"><a href="#topic-32429">B.1. Profile URL handler</a></span></li><li><span class="section"><a href="#topic-32430">B.2. Zk URL handler</a></span></li><li><span class="section"><a href="#UrlHandlers-Vars-Blueprint">B.3. Blueprint URL handler</a></span></li><li><span class="section"><a href="#UrlHandlers-Vars-Spring">B.4. Spring URL handler</a></span></li></ul></li><li><span class="appendix"><a href="#Resolvers">C. Profile Property Resolvers</a></span><ul><li><span class="section"><a href="#idm4490800">C.1. Substituting system properties</a></span></li><li><span class="section"><a href="#idp13339088">C.2. Substituting environment variables</a></span></li><li><span class="section"><a href="#idp11800224">C.3. Substituting container attributes</a></span></li><li><span class="section"><a href="#idp53213952">C.4. Substituting PID properties</a></span></li><li><span class="section"><a href="#idp10776320">C.5. Substituting ZooKeeper node contents</a></span></li><li><span class="section"><a href="#idp8698432">C.6. Checksum property resolver</a></span></li><li><span class="section"><a href="#idp59537760">C.7. Port property resolver</a></span></li></ul></li></ul></div><div class="part" id="PartBasic"><div class="titlepage"><div><div><h1 class="title">Part I. Basic Fabric Deployment</h1></div><div><div class="abstract"><p class="title"><strong>Abstract</strong></p><div class="para">
					Get started with Fuse Fabric and learn how to perform basic administration tasks.
				</div></div></div></div></div><div class="toc"><p><strong>Table of Contents</strong></p><ul class="toc"><li><span class="chapter"><a href="#GetStart">1. Getting Started with Fuse Fabric</a></span><ul><li><span class="section"><a href="#Deploy-Fabric-Create">1.1. Create a Fabric</a></span></li><li><span class="section"><a href="#Deploy-Fabric-DeployProfile">1.2. Deploy a Profile</a></span></li><li><span class="section"><a href="#Deploy-Fabric-UpdateProfile">1.3. Update a Profile</a></span></li><li><span class="section"><a href="#idp19152208">1.4. Shutting Down the Containers</a></span></li></ul></li><li><span class="chapter"><a href="#ESBRuntimeFabricCreate">2. Creating a New Fabric</a></span></li><li><span class="chapter"><a href="#Chapter-Fabric_Container">3. Fabric Containers</a></span><ul><li><span class="section"><a href="#ContChild">3.1. Child Containers</a></span></li><li><span class="section"><a href="#ContSSH">3.2. SSH Containers</a></span></li><li><span class="section"><a href="#ContWin">3.3. Fabric Containers on Windows</a></span></li><li><span class="section"><a href="#ContCloud">3.4. Cloud Containers</a></span><ul><li><span class="section"><a href="#ContCloud-Prepare">3.4.1. Preparing to use Fabric in the Cloud</a></span></li><li><span class="section"><a href="#ContCloud-Admin">3.4.2. Administering Cloud Containers</a></span></li></ul></li></ul></li><li><span class="chapter"><a href="#Profiles">4. Fabric Profiles</a></span><ul><li><span class="section"><a href="#Profiles-Intro">4.1. Introduction to Profiles</a></span></li><li><span class="section"><a href="#Profiles-Working">4.2. Working with Profiles</a></span></li><li><span class="section"><a href="#Profiles-Versions">4.3. Profile Versions</a></span></li></ul></li><li><span class="chapter"><a href="#F8Plugin">5. Fabric8 Maven Plug-In</a></span><ul><li><span class="section"><a href="#F8Plugin-Prepare">5.1. Preparing to Use the Plug-In</a></span></li><li><span class="section"><a href="#F8Plugin-Using">5.2. Using the Plug-In to Deploy a Maven Project</a></span></li><li><span class="section"><a href="#F8Plugin-Config">5.3. Configuring the Plug-In</a></span></li><li><span class="section"><a href="#F8Plugin-Props">5.4. Configuration Properties</a></span></li></ul></li><li><span class="chapter"><a href="#MQ">6. ActiveMQ Brokers and Clusters</a></span><ul><li><span class="section"><a href="#MQ-Creating">6.1. Creating a Standalone Broker Instance</a></span></li><li><span class="section"><a href="#MQ-Connecting">6.2. Connecting to a Broker</a></span></li><li><span class="section"><a href="#MQ-Topol">6.3. Topologies</a></span><ul><li><span class="section"><a href="#MQ-Topol-LoadBal">6.3.1. Load-Balancing Cluster</a></span></li><li><span class="section"><a href="#MQ-Topol-MasterSlave">6.3.2. Master-Slave Cluster</a></span></li><li><span class="section"><a href="#MQ-Topol-BrokerNetworks">6.3.3. Broker Networks</a></span></li></ul></li><li><span class="section"><a href="#MQ-BrokerConfig">6.4. Broker Configuration</a></span></li></ul></li></ul></div><section class="chapter" id="GetStart"><div class="titlepage"><div><div><h2 class="title">Chapter 1. Getting Started with Fuse Fabric</h2></div><div><div class="abstract"><p class="title"><strong>Abstract</strong></p><div class="para">
						This tutorial provides basic information and explains how to set up the simplest Fabric system, by creating some containers that run on your local machine and then deploying an example profile to a child container.
					</div><div class="para">
						Additional information on setting up a Fabric is covered in more detail in both <a class="xref" href="#ESBRuntimeFabricCreate" title="Chapter 2. Creating a New Fabric">Chapter 2, <em>Creating a New Fabric</em></a> and <a class="xref" href="#ContChild" title="3.1. Child Containers">Section 3.1, “Child Containers”</a>.
					</div></div></div></div></div><section class="section" id="Deploy-Fabric-Create"><div class="titlepage"><div><div><h2 class="title">1.1. Create a Fabric</h2></div></div></div><section class="simplesect" id="topic-32518"><div class="titlepage"><div><div><h3 class="title">Overview</h3></div></div></div><div class="para">
					<a class="xref" href="#Deploy-Fabric-FigASFCC" title="Figure 1.1. A Sample Fabric with Child Containers">Figure 1.1</a> shows an overview of a sample fabric that you will create. The Fabric Ensemble consists of just one Fabric Server (making this fabric suitable only for experimental use) and two managed child containers.
				</div><div class="figure" id="Deploy-Fabric-FigASFCC"><p class="title"><strong>Figure 1.1. A Sample Fabric with Child Containers</strong></p><div class="figure-contents"><div style="text-align: center; " class="mediaobject"><img style="text-align: middle" src="images/get_start_01.jpg" width="319" alt="A Sample Fabric with Child Containers"/></div></div></div></section><section class="simplesect" id="topic-32522"><div class="titlepage"><div><div><h3 class="title">Steps to create the fabric</h3></div></div></div><div class="para">
					To create the simple fabric shown in <a class="xref" href="#Deploy-Fabric-FigASFCC" title="Figure 1.1. A Sample Fabric with Child Containers">Figure 1.1, “A Sample Fabric with Child Containers”</a>, follow these steps:
				</div><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><div class="para">
							To create the first fabric container, which acts as the seed for the new fabric, enter this console command:
						</div><pre class="programlisting">JBossFuse:karaf@root&gt; fabric:create --new-user <em class="replaceable">AdminUser</em> --new-user-password <em class="replaceable">AdminPass</em> --new-user-role Administrator --zookeeper-password <em class="replaceable">ZooPass</em> --resolver manualip --manual-ip 127.0.0.1 --wait-for-provisioning</pre><div class="para">
							The current container, named <code class="code">root</code> by default, becomes a Fabric Server with a registry service installed. Initially, this is the only container in the fabric. The <code class="code">--new-user</code>, <code class="code">--new-user-password</code>, and <code class="code">--new-user-role</code> options specify the credentials for a new <code class="code">Administrator</code> user. The Zookeeper password is used to protect sensitive data in the Fabric registry service (all of the nodes under <code class="code">/fabric</code>). The <code class="code">--manual-ip</code> option specifies the loopback address, <code class="code">127.0.0.1</code>, as the Fabric Server's IP address.
						</div><div class="admonition note"><div class="admonition_header">Note</div><div><div class="para">
								A Fabric Server requires a static IP address. For simple trials and tests, you can use the loopback address, <code class="code">127.0.0.1</code>, to work around this requirement. But if you are deploying a fabric in production or if you want to create a distributed ensemble, you <span class="emphasis"><em>must</em></span> assign a static IP address to the each of the Fabric Server hosts.
							</div></div></div><div class="admonition note"><div class="admonition_header">Note</div><div><div class="para">
								Most of the time, you are not prompted to enter the Zookeeper password when accessing the registry service, because it is cached in the current session. When you <span class="emphasis"><em>join a container to a fabric</em></span>, however, you must provide the fabric's Zookeeper password.
							</div></div></div></li><li class="listitem"><div class="para">
							Create a child container. Assuming that your root container is named <code class="code">root</code>, enter this console command:
						</div><pre class="programlisting">JBossFuse:karaf@root&gt; fabric:container-create-child root child
The following containers have been created successfully:
	Container: child.</pre></li><li class="listitem"><div class="para">
							Invoke the following command to monitor the status of the child container, as it is being provisioned:
						</div><div class="informalexample"><pre class="programlisting">JBossFuse:karaf@root&gt; shell:watch container-list</pre></div><div class="para">
							After the deployment of the <code class="code">child</code> has completed, you should see a listing something like this:
						</div><pre class="programlisting">JBossFuse:karaf@root&gt; shell:watch container-list
[id]                           [version] [alive] [profiles]                     [provision status]
root                           1.0       true    fabric, fabric-ensemble-0000-1, fuse-esb-full success
  child                        1.0       true    default                        success</pre><div class="para">
							Type the <code class="code">Return</code> key to get back to the JBoss Fuse console prompt.
						</div></li></ol></div></section></section><section class="section" id="Deploy-Fabric-DeployProfile"><div class="titlepage"><div><div><h2 class="title">1.2. Deploy a Profile</h2></div></div></div><section class="simplesect" id="topic-32523"><div class="titlepage"><div><div><h3 class="title">Deploy a profile to the child container</h3></div></div></div><div class="para">
					Having created the child container, as described in <a class="xref" href="#Deploy-Fabric-Create" title="1.1. Create a Fabric">Section 1.1, “Create a Fabric”</a>, you can now deploy the a profile to it. To do so, follow these steps:
				</div><div class="procedure"><ol class="procedure" type="1"><li class="step"><div class="para">
							Deploy the <code class="code">quickstarts-beginner-camel.log</code> profile into the <code class="code">child</code> container by entering this console command:
						</div><pre class="programlisting">JBossFuse:karaf@root&gt; fabric:container-change-profile child quickstarts-beginner-camel.log</pre></li><li class="step"><div class="para">
							Verify that the <code class="code">quickstarts-beginner-camel.log</code> profile deploys successfully to the <code class="code">child</code> container, using the <code class="code">fabric:container-list</code> command. Enter the following command to monitor the container status:
						</div><div class="informalexample"><pre class="programlisting">JBossFuse:karaf@root&gt; shell:watch container-list</pre></div><div class="para">
							And wait until the <code class="code">child</code> container status changes to <code class="code">success</code>.
						</div></li></ol></div></section><section class="simplesect" id="topic-32524"><div class="titlepage"><div><div><h3 class="title">View the sample output</h3></div></div></div><div class="para">
					When it is running, the <code class="code">quickstarts-beginner-camel.log</code> profile writes a message to the container's log every five seconds. To verify that the profile is running properly, you can look for these messages in the child container's log, as follows:
				</div><div class="procedure"><ol class="procedure" type="1"><li class="step"><div class="para">
							Connect to the <code class="code">child</code> container, by entering the following console command:
						</div><div class="informalexample"><pre class="programlisting">JBossFuse:karaf@root&gt; container-connect child</pre></div></li><li class="step"><div class="para">
							After logging on to the <code class="code">child</code> container, view the <code class="code">child</code> container's log using the <code class="code">log:tail</code> command, as follows:
						</div><div class="informalexample"><pre class="programlisting">JBossFuse:karaf@root&gt; log:tail</pre></div><div class="para">
							You should see some output like the following:
						</div><div class="informalexample"><pre class="programlisting">2015-06-16 11:47:51,012 | INFO  | #2 - timer://foo | log-route
    | ? ? | 153 - org.apache.camel.camel-core - 2.15.1.redhat-620123
    | &gt;&gt;&gt; Hello from Fabric based Camel route! : child
2015-06-16 11:47:56,011 | INFO  | #2 - timer://foo | log-route
    | ? ? | 153 - org.apache.camel.camel-core - 2.15.1.redhat-620123
    | &gt;&gt;&gt; Hello from Fabric based Camel route! : child</pre></div></li><li class="step"><div class="para">
							Type Ctrl-C to exit the log view and get back to the child container's console prompt.
						</div></li><li class="step"><div class="para">
							Type Ctrl-D to exit the child container's console, which brings you back to the root container console.
						</div></li></ol></div></section></section><section class="section" id="Deploy-Fabric-UpdateProfile"><div class="titlepage"><div><div><h2 class="title">1.3. Update a Profile</h2></div></div></div><section class="simplesect" id="topic-32525"><div class="titlepage"><div><div><h3 class="title">Atomic container upgrades </h3></div></div></div><div class="para">
					Normally, when you edit a profile that is already deployed in a container, <span class="emphasis"><em>the modification takes effect immediately</em></span>. This is because the Fabric Agent in the affected container (or containers) actively monitors the fabric registry in real time.
				</div><div class="para">
					In practice, however, immediate propagation of profile modifications is often undesirable. In a production system, you typically want to roll out changes incrementally: for example, initially trying out the change on just one container to check for problems, before you make changes globally to all containers. Moreover, sometimes several edits must be made together to reconfigure an application in a consistent way.
				</div></section><section class="simplesect" id="topic-32526"><div class="titlepage"><div><div><h3 class="title">Profile versioning</h3></div></div></div><div class="para">
					For quality assurance and consistency, it is typically best to modify profiles <span class="emphasis"><em>atomically</em></span>, where several modifications are applied simultaneously. To support atomic updates, fabric implements profile versioning. Initially, the container points at version 1.0 of a profile. When you create a new profile version (for example, version 1.1), the changes are invisible to the container until you upgrade it. After you are finished editing the new profile, you can apply all of the modifications simultaneously by upgrading the container to use the new version 1.1 of the profile.
				</div></section><section class="simplesect" id="topic-32527"><div class="titlepage"><div><div><h3 class="title">Upgrade to a new profile</h3></div></div></div><div class="para">
					For example, to modify the <code class="code">quickstarts-beginner-camel.log</code> profile, when it is deployed and running in a container, follow the recommended procedure:
				</div><div class="procedure"><ol class="procedure" type="1"><li class="step"><div class="para">
							Create a new version, 1.1, to hold the pending changes by entering this console command:
						</div><pre class="programlisting">JBossFuse:karaf@root&gt; fabric:version-create
Created version: 1.1 as copy of: 1.0</pre><div class="para">
							The new version is initialised with a copy of all of the profiles from version 1.0.
						</div></li><li class="step"><div class="para">
							Use the <code class="code">fabric:profile-edit</code> command to change the message that is written to the container log by the Camel route. Enter the following <code class="code">profile-edit</code> command to edit the <code class="code">camel.xml</code> resource:
						</div><pre class="programlisting">JBossFuse:karaf@root&gt; fabric:profile-edit --resource camel.xml quickstarts-beginner-camel.log 1.1</pre><div class="para">
							This opens the built-in text editor for editing profile resources (see <a class="xref" href="#ProfileEdit" title="Appendix A. Editing Profiles with the Built-In Text Editor">Appendix A, <em>Editing Profiles with the Built-In Text Editor</em></a>).

						</div><div class="para">
							Remember to specify version <code class="code">1.1</code> to the <code class="code">fabric:profile-edit</code> command, so that the modifications are applied to version 1.1 of the <code class="code">quickstarts-beginner-camel.log</code> profile.
						</div><div class="para">
							When you are finished editing, type Ctrl-S to save your changes and then type Ctrl-X to quit the text editor and get back to the console prompt.
						</div></li><li class="step"><div class="para">
							Upgrade the <code class="code">child</code> container to version <code class="code">1.1</code> by entering this console command:
						</div><pre class="programlisting">JBossFuse:karaf@root&gt; fabric:container-upgrade 1.1 child</pre></li></ol></div></section><section class="simplesect" id="topic-32528"><div class="titlepage"><div><div><h3 class="title">Roll back to an old profile</h3></div></div></div><div class="para">
					You can easily roll back to the old version of the <code class="code">quickstarts-beginner-camel.log</code> profile, using the <code class="code">fabric:container-rollback</code> command like this:
				</div><pre class="programlisting">JBossFuse:karaf@root&gt; fabric:container-rollback 1.0 child</pre></section></section><section class="section" id="idp19152208"><div class="titlepage"><div><div><h2 class="title">1.4. Shutting Down the Containers</h2></div></div></div><section class="simplesect" id="topic-32529"><div class="titlepage"><div><div><h3 class="title">Shutting down the containers</h3></div></div></div><div class="para">
					Because the child containers run in their own JVMs, they do <span class="emphasis"><em>not</em></span> automatically stop when you shut down the root container. To shut down a container and its children, first stop its children using the <code class="code">fabric:container-stop</code> command. For example, to shut down the current fabric completely, enter these console commands:
				</div><pre class="programlisting">JBossFuse:karaf@root&gt; fabric:container-stop child
JBossFuse:karaf@root&gt; shutdown -f</pre><div class="para">
					After you restart the root container, you must explicitly restart the children using the <code class="code">fabric:container-start</code> console command.
				</div></section></section></section><section class="chapter" id="ESBRuntimeFabricCreate"><div class="titlepage"><div><div><h2 class="title">Chapter 2. Creating a New Fabric</h2></div><div><div class="abstract"><p class="title"><strong>Abstract</strong></p><div class="para">
						When there are no existing fabric's to join, or you want to start a new fabric, you can create a new one from a standalone container.
					</div></div></div></div></div><section class="simplesect" id="ESBRuntimeFabricCreate-StaticIP"><div class="titlepage"><div><div><h2 class="title">Static IP address required for Fabric Server</h2></div></div></div><div class="para">
				The IP address and hostname associated with the Fabric Servers in the Fabric ensemble are of critical importance to the fabric. Because these IP addresses and hostnames are used for configuration and service discovery (through the Zookeeper registry), they <span class="emphasis"><em>must not change</em></span> during the lifetime of the fabric.
			</div><div class="para">
				You can take either of the following approaches to specifying the IP address:
			</div><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><div class="para">
						For simple examples and tests (with a single Fabric Server) you can work around the static IP requirement by using the loopback address, <code class="code">127.0.0.1</code>.
					</div></li><li class="listitem"><div class="para">
						For distributed tests (multiple Fabric Servers) and production deployments, you <span class="emphasis"><em>must</em></span> assign a static IP address to each of the Fabric Server hosts.
					</div></li></ul></div><div class="admonition warning"><div class="admonition_header">Warning</div><div><div class="para">
					Beware of volatile IP addresses resulting from VPN connections, WiFi connections, and even LAN connections. If a Fabric Server binds to one of these volatile IP addresses, it will cease to function after the IP address has gone away. It is recommended that you always use the <code class="code">--resolver manualip --manual-ip <em class="replaceable">StaticIPAddress</em></code> options to specify the static IP address explicitly, when creating a new Fabric Server.
				</div></div></div></section><section class="simplesect" id="topic-32481"><div class="titlepage"><div><div><h2 class="title">Procedure</h2></div></div></div><div class="para">
				To create a new fabric:
			</div><div class="procedure"><ol class="procedure" type="1"><li class="step"><div class="para">
						<span class="emphasis"><em>(Optional)</em></span> Customise the name of the root container by editing the <code class="code"><em class="replaceable">InstallDir</em>/etc/system.properties</code> file and specifying a different name for this property:
					</div><pre class="programlisting">karaf.name=root</pre><div class="admonition note"><div class="admonition_header">Note</div><div><div class="para">
							For the first container in your fabric, this step is optional. But at some later stage, if you want to join a root container to the fabric, you might need to customise the container's name to prevent it from clashing with any existing root containers in the fabric.
						</div></div></div></li><li class="step"><div class="para">
						Any existing users in the <code class="code"><em class="replaceable">InstallDir</em>/etc/users.properties</code> file are automatically used to initialize the fabric's user data, when you create the fabric. You can populate the <code class="code">users.properties</code> file, by adding one or more lines of the following form:
					</div><pre class="programlisting"><em class="replaceable">Username</em>=<em class="replaceable">Password</em>[,<em class="replaceable">RoleA</em>][,<em class="replaceable">RoleB</em>]...</pre><div class="para">
						But there must <span class="emphasis"><em>not</em></span> be any users in this file that have administrator privileges (<code class="code">Administrator</code>, <code class="code">SuperUser</code>, or <code class="code">admin</code> roles). If the <code class="code"><em class="replaceable">InstallDir</em>/etc/users.properties</code> already contains users with administrator privileges, you should <span class="emphasis"><em>delete those users</em></span> before creating the fabric.
					</div><div class="admonition warning"><div class="admonition_header">Warning</div><div><div class="para">
							If you leave some administrator credentials in the <code class="code">users.properties</code> file, this represents a security risk because the file could potentially be accessed by other containers in the fabric.
						</div></div></div><div class="admonition note"><div class="admonition_header">Note</div><div><div class="para">
							The initialization of user data from <code class="code">users.properties</code> happens only once, at the time the fabric is created. After the fabric has been created, any changes you make to <code class="code">users.properties</code> will have <span class="emphasis"><em>no effect</em></span> on the fabric's user data.
						</div></div></div></li><li class="step"><div class="para">
						If you use a VPN (virtual private network) on your local machine, it is advisable to log off VPN <span class="emphasis"><em>before</em></span> you create the fabric and to <span class="emphasis"><em>stay logged off</em></span> while you are using the local container.
					</div><div class="admonition note"><div class="admonition_header">Note</div><div><div class="para">
							A local Fabric Server is permanently associated with a fixed IP address or hostname. If VPN is enabled when you create the fabric, the underlying Java runtime is liable to detect and use the VPN hostname instead of your permanent local hostname. This can also be an issue with multi-homed machines.
						</div></div></div></li><li class="step"><div class="para">
						Start up your local container.
					</div><div class="para">
						In JBoss Fuse, start the local container as follows:
					</div><pre class="programlisting">cd <em class="replaceable">InstallDir</em>/bin
./fuse</pre></li><li class="step"><div class="para">
						Create a new fabric by entering the following command:
					</div><pre class="programlisting">JBossFuse:karaf@root&gt; fabric:create --new-user <em class="replaceable">AdminUser</em> --new-user-password <em class="replaceable">AdminPass</em> --new-user-role Administrator --zookeeper-password <em class="replaceable">ZooPass</em> --resolver manualip --manual-ip <em class="replaceable">StaticIPAddress</em> --wait-for-provisioning</pre><div class="para">
						The current container, named <code class="code">root</code> by default, becomes a Fabric Server with a registry service installed. Initially, this is the only container in the fabric. The <code class="code">--new-user</code>, <code class="code">--new-user-password</code>, and <code class="code">--new-user-role</code> options specify the credentials for a new <code class="code">Administrator</code> user. The Zookeeper password is used to protect sensitive data in the Fabric registry service (all of the nodes under <code class="code">/fabric</code>). The <code class="code">--manual-ip</code> option specifies the Fabric Server's static IP address <code class="code"><em class="replaceable">StaticIPAddress</em></code> (see <a class="xref" href="#ESBRuntimeFabricCreate-StaticIP" title="Static IP address required for Fabric Server">the section called “Static IP address required for Fabric Server”</a>).
					</div><div class="para">
						For more details on <span class="command"><strong>fabric:create</strong></span> see <a class="link" href="https://access.redhat.com/documentation/en-US/Red_Hat_JBoss_Fuse/6.2/html/Console_Reference/ConsoleFabricCreate.html">section "fabric:create" in "Console Reference"</a>.
					</div><div class="para">
						For more details about resolver policies, see <a class="link" href="https://access.redhat.com/documentation/en-US/Red_Hat_JBoss_Fuse/6.2/html/Console_Reference/ConsoleFabricContainerResolverList.html">section "fabric:container-resolver-list" in "Console Reference"</a> and <a class="link" href="https://access.redhat.com/documentation/en-US/Red_Hat_JBoss_Fuse/6.2/html/Console_Reference/ConsoleFabricContainerResolverSet.html">section "fabric:container-resolver-set" in "Console Reference"</a>.
					</div></li></ol></div></section><section class="simplesect" id="topic-32483"><div class="titlepage"><div><div><h2 class="title">Fabric creation process</h2></div></div></div><div class="para">
				Several things happen when a fabric is created from a standalone container:
			</div><div class="procedure"><ol class="procedure" type="1"><li class="step"><div class="para">
						The container installs the requisite OSGi bundles to become a Fabric Server.
					</div></li><li class="step"><div class="para">
						The Fabric Server starts a registry service, which listens on TCP port 2181 (which makes fabric configuration data available to all of the containers in the fabric).
					</div><div class="admonition note"><div class="admonition_header">Note</div><div><div class="para">
							You can customize the value of the registry service port by specifying the <code class="code">--zookeeper-server-port</code> option.
						</div></div></div></li><li class="step"><div class="para">
						The Fabric Server installs a new JAAS realm (based on the ZooKeeper login module), which overrides the default JAAS realm and stores its user data in the ZooKeeper registry.
					</div></li><li class="step"><div class="para">
						The new Fabric Ensemble consists of a <span class="emphasis"><em>single</em></span> Fabric Server (the current container).
					</div></li><li class="step"><div class="para">
						A default set of profiles is imported from <code class="filename"><em class="replaceable">InstallDir</em>/fabric/import</code> (can optionally be overridden).
					</div></li><li class="step"><div class="para">
						After the standalone container is converted into a Fabric Server, the previously installed OSGi bundles and Karaf features are completely cleared away and replaced by the default Fabric Server configuration. For example, some of the shell command sets that were available in the standalone container are no longer available in the Fabric Server.
					</div></li></ol></div></section><section class="simplesect" id="topic-32460"><div class="titlepage"><div><div><h2 class="title">Expanding a Fabric</h2></div></div></div><div class="para">
				You can expand a fabric by creating new managed containers. Fabric supports the <em class="firstterm">container provider</em> plug-in mechanism, which makes it possible to define how to create new containers in different contexts. Currently, Fabric makes container providers available for the following kinds of container:
			</div><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><div class="para">
						<em class="firstterm">Child container</em>, created on the local machine as a child process in its own JVM.
					</div><div class="para">
						Instructions on creating a child container are found in <a class="link" href="#ContChild" title="3.1. Child Containers">Child Containers</a>.
					</div></li><li class="listitem"><div class="para">
						<em class="firstterm">SSH container</em>, created on any remote machine for which you have <code class="code">ssh</code> access.
					</div><div class="para">
						Instructions on creating a SSH container are found in <a class="link" href="#ContSSH" title="3.2. SSH Containers">SSH Containers</a>.
					</div></li><li class="listitem"><div class="para">
						<em class="firstterm">Cloud container</em>, created on compute instance in the cloud.
					</div><div class="para">
						Instructions on creating a cloud container are found in <a class="link" href="#ContCloud" title="3.4. Cloud Containers">Cloud Containers</a>.
					</div></li></ul></div><div class="para">
				Fabric provides container creation commands that make it easy to create new containers. Using these commands, Fabric can automatically install JBoss Fuse on a remote host (uploading whatever dependencies are needed), start up the remote container process, and join the container to the existing fabric, so that it becomes a fully-fledged managed container in the fabric.
			</div></section></section><section class="chapter" id="Chapter-Fabric_Container"><div class="titlepage"><div><div><h2 class="title">Chapter 3. Fabric Containers</h2></div></div></div><section class="section" id="ContChild"><div class="titlepage"><div><div><h2 class="title">3.1. Child Containers</h2></div><div><div class="abstract"><p class="title"><strong>Abstract</strong></p><div class="para">
							Child containers are the easiest kind of container to create. They are created on the same host as an existing container and are piggybacked on the same JBoss Fuse installation.
						</div></div></div></div></div><section class="simplesect" id="topic-32383"><div class="titlepage"><div><div><h3 class="title">Overview</h3></div></div></div><div class="para">
					If you want to run multiple JBoss Fuse containers on a single physical host, typically the best approach is to create child containers. A child container is a relatively lightweight way to create a new container, because it re-uses most of the files in a JBoss Fuse installation. It is also convenient for administration, because the children are defined to have a parent container, so that the containers form an orderly hierarchy.
				</div></section><section class="simplesect" id="topic-32384"><div class="titlepage"><div><div><h3 class="title">One container or many?</h3></div></div></div><div class="para">
					In principle, a single OSGi container can host multiple applications (even applications with different dependencies). So, why might you need to define extra child containers on the same host? One reason for using child containers is simply to provide a degree of isolation between applications or between components of an application. A child container runs in its own JVM process, so it is well insulated from other containers running on the same host. Using child containers also gives your application a coarse-grained structure that can be useful for managing the system (for example, each child container can be independently stopped and started).
				</div></section><section class="simplesect" id="topic-32385"><div class="titlepage"><div><div><h3 class="title">Creating a child container</h3></div></div></div><div class="para">
					To create a new child container, invoke the <code class="code">fabric:container-create-child</code> command, specifying the parent container name and the name of the new child container. For example, to create the new child container, <code class="code">onlychild</code>, with <code class="code">root</code> as its parent, enter the following command:
				</div><pre class="programlisting">fabric:container-create-child root onlychild</pre><div class="para">
					If you want to create multiple child containers, an easy way to do this is to add an extra parameter, which specifies the number of new children. For example, to create three new child containers, enter a command like the following:
				</div><pre class="programlisting">fabric:container-create-child root child 3</pre><div class="para">
					The preceding command would create the following new child containers:
				</div><pre class="programlisting">child1
child2
child3</pre></section><section class="simplesect" id="topic-32386"><div class="titlepage"><div><div><h3 class="title">Stopping and starting a child container</h3></div></div></div><div class="para">
					Because each child container runs as a separate process, its lifecycle is independent of the parent container. That is, when you shut down a parent container, it does <span class="emphasis"><em>not</em></span> automatically shut down the children. To shut down a child container, you must explicitly invoke the <code class="code">fabric:container-stop</code> command. For example, to shut down the <code class="code">child1</code> container:
				</div><pre class="programlisting">fabric:container-stop child1</pre><div class="para">
					To restart a stopped child container, invoke the <code class="code">fabric:container-start</code> command, as follows:
				</div><pre class="programlisting">fabric:container-start child1</pre><div class="admonition note"><div class="admonition_header">Note</div><div><div class="para">
						You can also stop a child container using the standard UNIX process management utilities, <code class="code">ps</code> and <code class="code">kill</code>.
					</div></div></div></section><section class="simplesect" id="topic-32387"><div class="titlepage"><div><div><h3 class="title">Deleting a child container</h3></div></div></div><div class="para">
					To delete a child container (that is, permanently removing all trace of the container from the fabric, including Fabric registry entries, and data stored in the local filesystem), invoke the <code class="code">fabric:container-delete</code> command, as follows:
				</div><pre class="programlisting">fabric:container-delete child1</pre></section></section><section class="section" id="ContSSH"><div class="titlepage"><div><div><h2 class="title">3.2. SSH Containers</h2></div><div><div class="abstract"><p class="title"><strong>Abstract</strong></p><div class="para">
							Fabric allows you to install containers in a local network using SSH. Fabric installs the container from scratch and configures the container to join the Fabric cluster automatically.
						</div></div></div></div></div><section class="simplesect" id="topic-32422"><div class="titlepage"><div><div><h3 class="title">Overview</h3></div></div></div><div class="para">
					An SSH container is just a Fabric container that is running on a remote host on your local network, where that host is accessible through the SSH protocol. This section describes some basic administration tasks for these SSH containers.
				</div></section><section class="simplesect" id="topic-32423"><div class="titlepage"><div><div><h3 class="title">Prerequisites</h3></div></div></div><div class="para">
					The requirements for creating an SSH container on a remote host are:
				</div><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><div class="para">
							Linux or UNIX operating system,
						</div></li><li class="listitem"><div class="para">
							SSHD running on the target host and:
						</div><div class="itemizedlist"><ul class="itemizedlist" type="circle"><li class="listitem"><div class="para">
									A valid account credentials, or
								</div></li><li class="listitem"><div class="para">
									Configured public key authentication
								</div></li></ul></div></li><li class="listitem"><div class="para">
							Java 1.7 installed.
						</div></li><li class="listitem"><div class="para">
							Curl installed.
						</div></li><li class="listitem"><div class="para">
							GNU tar installed.
						</div></li><li class="listitem"><div class="para">
							Telnet installed.
						</div></li></ul></div></section><section class="simplesect" id="topic-32424"><div class="titlepage"><div><div><h3 class="title">Creating an SSH container</h3></div></div></div><div class="para">
					Fabric provides the <code class="code">fabric:container-create-ssh</code> console command, for creating SSH containers.
				</div><div class="para">
					Given the host, <code class="code">myhost</code> (accessible from the local network) with the SSH user account, <code class="code">myuser</code>, and the password, <code class="code">mypassword</code>, your could create an SSH container on <code class="code">myhost</code>, using the following console command:
				</div><pre class="programlisting">fabric:container-create-ssh --host myhost --user myuser --password mypassword myremotecontainername</pre><div class="para">
					If the <code class="code">myuser</code> user on <code class="code">myhost</code> has configured public key authentication for SSH, you can skip the password option:
				</div><pre class="programlisting">fabric:container-create-ssh --host myhost --user myuser myremotecontainername</pre><div class="para">
					Where the preceding command uses the key located in <code class="code">~/.ssh/id_rsa</code> for authentication. If you need to use a different key, you can specify the key location explicitly with the <code class="code">--private-key</code> option:
				</div><pre class="programlisting">fabric:container-create-ssh --host myhost --user myuser --private-key ~/.ssh/fabric_pk myremotecontainername</pre><div class="para">
					The last command also supports the <code class="code">--pass-phrase</code> option, in case your key requires a pass phrase.
				</div></section><section class="simplesect" id="topic-32425"><div class="titlepage"><div><div><h3 class="title">Creating a Fabric server using SSH</h3></div></div></div><div class="para">
					Sometimes you do not have an existing fabric and you want to create one on a remote host. The starting point for any fabric is a Fabric server instance, which can act as a seed for the rest of the fabric. So, to enable you to create a new fabric on a remote host, the <code class="code">fabric:container-create-ssh</code> supports the <code class="code">--ensemble-server</code> option, which can be invoked to create a container which is a Fabric server. For example, the following <code class="code">container-create-ssh</code> command creates a new fabric consisting of one Fabric server on the <code class="code">myhost</code> host:
				</div><pre class="programlisting">fabric:container-create-ssh --host myhost --user myuser --ensemble-server myremotecontainername
fabric:join myhost:2181</pre><div class="para">
					The <code class="code">fabric:join</code> command joins the current container to the new fabric. This has the advantage that it is much easier to administer the new fabric using a container that is joined to the fabric, because the local container then gains access to the connection data stored in the Fabric registry.
				</div><div class="admonition note"><div class="admonition_header">Note</div><div><div class="para">
						The argument to <code class="code">fabric:join</code> is the ZooKeeper server port, <code class="code"><em class="replaceable">Host</em>:<em class="replaceable">Port</em></code>. The port number in this example, <code class="code">2181</code>, is the standard ZooKeeper port number in Fabric.
					</div></div></div><div class="admonition note"><div class="admonition_header">Note</div><div><div class="para">
						After you enter the <code class="code">fabric:join</code> command, you will be prompted to enter the ZooKeeper password for the fabric.
					</div></div></div></section><section class="simplesect" id="topic-32426"><div class="titlepage"><div><div><h3 class="title">Managing remote SSH containers</h3></div></div></div><div class="para">
					Using JBoss Fuse console commands, you can stop, restart or delete (that is, uninstall) a remote container, as follows:
				</div><div class="para">
					To stop an SSH container:
				</div><pre class="programlisting">fabric:container-stop myremotecontainername</pre><div class="para">
					To restart an SSH container:
				</div><pre class="programlisting">fabric:container-start myremotecontainername</pre><div class="para">
					To uninstall an SSH container:
				</div><pre class="programlisting">fabric:container-delete myremotecontainername</pre><div class="para">
					Note that these commands are available only for containers created directly using the current fabric. They are <span class="emphasis"><em>not</em></span> available for containers that were joined to the cluster manually.
				</div></section><section class="simplesect" id="topic-32427"><div class="titlepage"><div><div><h3 class="title">References</h3></div></div></div><div class="para">
					For more details about the SSH container console commands, see the <span class="emphasis"><em>JBoss Fuse Console Reference</em></span>.
				</div></section></section><section class="section" id="ContWin"><div class="titlepage"><div><div><h2 class="title">3.3. Fabric Containers on Windows</h2></div><div><div class="abstract"><p class="title"><strong>Abstract</strong></p><div class="para">
							Fabric supports the deployment of containers on Windows platforms. In this case, however, it is necessary to install the container manually on the target host.
						</div></div></div></div></div><section class="simplesect" id="topic-32401"><div class="titlepage"><div><div><h3 class="title">Overview</h3></div></div></div><div class="para">
					Because Windows does not support the Secure Shell (SSH) protocol, it is not possible to install the container software remotely on to a Windows machine. The installation must be performed manually. But the remote deployment of applications (by assigning profiles to the container) is fully supported.
				</div></section><section class="simplesect" id="topic-32402"><div class="titlepage"><div><div><h3 class="title">Creating a Fabric container on Windows</h3></div></div></div><div class="para">
					Perform the following steps to create a Fabric container on Windows (assuming the container is to join an existing fabric):
				</div><div class="procedure"><ol class="procedure" type="1"><li class="step"><div class="para">
							Following the instructions in the <span class="emphasis"><em>JBoss Fuse Installation Guide</em></span>, manually install the JBoss Fuse product on the Windows target host.
						</div></li><li class="step"><div class="para">
							Open a new command prompt and enter the following commands to start the container on the target host:
						</div><div class="informalexample"><pre class="programlisting">cd <em class="replaceable">InstallDir</em>\bin
fuse.bat</pre></div></li><li class="step"><div class="para">
							If the Fabric servers from the Fabric ensemble are not already running, start them now.
						</div></li><li class="step"><div class="para">
							Join the container to the existing fabric, by entering the following console command:
						</div><div class="informalexample"><pre class="programlisting">JBossFuse:karaf@root&gt; fabric:join --zookeeper-password <em class="replaceable">ZooPass</em> <em class="replaceable">RegistryHost</em></pre></div><div class="para">
							Where <code class="code"><em class="replaceable">ZooPass</em></code> is the ZooKeeper password for the Fabric ensemble (as specified when you originally created the fabric with <code class="code">fabric:create</code>); and <code class="code"><em class="replaceable">RegistryHost</em></code> is the hostname or IP address of one of the hosts where a Fabric server is running.
						</div><div class="admonition note"><div class="admonition_header">Note</div><div><div class="para">
								By default, Fabric uses the default IP port number, <code class="code">2181</code>, to connect to the Fabric server on the <code class="code"><em class="replaceable">RegistryHost</em></code> host. If, for some reason, the ZooKeeper service is listening on a different IP port, you can specify the IP port number explicitly using the syntax, <code class="code"><em class="replaceable">RegistryHost</em>:<em class="replaceable">RegistryIPPort</em></code>.
							</div></div></div></li></ol></div><div class="para">
					After joining the fabric, the container becomes a managed Fabric container and initially has the <code class="code">default</code> profile deployed on it.
				</div></section><section class="simplesect" id="topic-32403"><div class="titlepage"><div><div><h3 class="title">Creating a Fabric server on Windows</h3></div></div></div><div class="para">
					If you don't have an existing fabric, you can create a new fabric on the Windows host. The starting point for any fabric is a Fabric server instance, which can act as a seed for the rest of the fabric. Perform the following steps to create a Fabric server on Windows:
				</div><div class="procedure"><ol class="procedure" type="1"><li class="step"><div class="para">
							Following the instructions in the <span class="emphasis"><em>JBoss Fuse Installation Guide</em></span>, manually install the JBoss Fuse product on the Windows target host.
						</div></li><li class="step"><div class="para">
							To start the container on the target host, open a new command prompt and enter the following commands:
						</div><div class="informalexample"><pre class="programlisting">cd <em class="replaceable">InstallDir</em>\bin
fuse.bat</pre></div></li><li class="step"><div class="para">
							To create a new fabric (thereby turning the current host into a Fabric server), enter the following console command:
						</div><pre class="programlisting">JBossFuse:karaf@root&gt; fabric:create --new-user <em class="replaceable">AdminUser</em> --new-user-password <em class="replaceable">AdminPass</em>
  --new-user-role Administrator --zookeeper-password <em class="replaceable">ZooPass</em>
  --resolver manualip --manual-ip <em class="replaceable">StaticIPAddress</em> --wait-for-provisioning</pre><div class="para">
							The current container, named <code class="code">root</code> by default, becomes a Fabric Server with a registry service installed. Initially, this is the only container in the fabric. The <code class="code">--new-user</code>, <code class="code">--new-user-password</code>, and <code class="code">--new-user-role</code> options specify the credentials for a new <code class="code">Administrator</code> user. The Zookeeper password is used to protect sensitive data in the Fabric registry service (all of the nodes under <code class="code">/fabric</code>). The <code class="code">--manual-ip</code> option specifies the Fabric Server's static IP address <code class="code"><em class="replaceable">StaticIPAddress</em></code> (see <a class="xref" href="#ESBRuntimeFabricCreate-StaticIP" title="Static IP address required for Fabric Server">the section called “Static IP address required for Fabric Server”</a>).
						</div></li></ol></div></section><section class="simplesect" id="topic-32404"><div class="titlepage"><div><div><h3 class="title">Managing remote containers on Windows</h3></div></div></div><div class="para">
					Because a Fabric container on Windows is added to the fabric by joining (that is, using <code class="code">fabric:join</code>), there are certain restrictions on which commands you can use to manage it. In particular, the following commands are <span class="emphasis"><em>not</em></span> supported:
				</div><div class="informalexample"><pre class="programlisting">fabric:container-stop
fabric:container-start
fabric:container-delete</pre></div><div class="para">
					To stop and start a Fabric container running on Windows, you must log on to the Windows host and use the regular Windows system commands to manage the container process (in particular, you could potentially install the container as a Windows service and use the Windows service commands to manage the container lifecycle).
				</div></section></section><section class="section" id="ContCloud"><div class="titlepage"><div><div><h2 class="title">3.4. Cloud Containers</h2></div><div><div class="abstract"><p class="title"><strong>Abstract</strong></p><div class="para">
							Fabric has the capability to create and manage containers running in the cloud. With just a few commands, you can create a complete Fabric, consisting of multiple containers, running in a public or private cloud.
						</div></div></div></div></div><section class="section" id="ContCloud-Prepare"><div class="titlepage"><div><div><h3 class="title">3.4.1. Preparing to use Fabric in the Cloud</h3></div></div></div><section class="simplesect" id="topic-32370"><div class="titlepage"><div><div><h4 class="title">Overview</h4></div></div></div><div class="para">
						Fabric leverages <a class="link" href="http://jclouds.apache.org/">JClouds</a> to enable Fabric to create new containers in public or private clouds. The Fabric cloud container provider enables you to create new compute instances in the cloud provider of your choice, perform firewall configuration, install prerequisites, install the JBoss Fuse container, and automatically register the new container.
					</div></section><section class="simplesect" id="topic-32371"><div class="titlepage"><div><div><h4 class="title">Prerequisites</h4></div></div></div><div class="para">
						The prerequisites for creating a cloud container are as follows:
					</div><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><div class="para">
								A valid account with one of the cloud providers implemented by JClouds. The list of cloud providers can be found at <a class="link" href="http://jclouds.apache.org/reference/providers/">JClouds supported providers</a>.
							</div><div class="admonition note"><div class="admonition_header">Note</div><div><div class="para">
									In the context of JClouds, the term <span class="emphasis"><em>supported provider</em></span> does not imply commercial support for the listed cloud providers. It just indicates that there is an available implementation.
								</div></div></div></li></ul></div></section><section class="simplesect" id="idp19787536"><div class="titlepage"><div><div><h4 class="title">Hybrid clusters</h4></div></div></div><div class="para">
						A <em class="firstterm">hybrid cluster</em> is a cluster composed of containers running both on the premises and on a public cloud provider. This special type of cluster has the additional requirement that <span class="emphasis"><em>all containers must be able to connect to the Fabric registry</em></span>.
					</div><div class="para">
						In order to satisfy this requirement, you need to make sure that one of the following conditions are met:
					</div><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><div class="para">
								Fabric registry is running inside the public cloud.
							</div><div class="para">
								In this case, local containers will have no problem accessing the registry, as long as they are able to connect to the Internet.
							</div></li><li class="listitem"><div class="para">
								Cloud and local containers are part of a Virtual Private Network (VPN).
							</div><div class="para">
								If the Fabric registry is running on the premises, the cloud containers will not be able to access the registry, unless you set up a VPN (or make the registry accessible from the Internet, which is <span class="emphasis"><em>not</em></span> recommended).
							</div></li><li class="listitem"><div class="para">
								Fabric registry is accessible from the Internet <span class="emphasis"><em>(not recommended)</em></span>.
							</div></li></ul></div><div class="para">
						The easiest approach is to host the registry in the cloud and then configure the cloud's firewall, so that it only allows access from the containers on your premises. By default, Fabric will configure the firewall for you.
					</div></section><section class="simplesect" id="idp11805792"><div class="titlepage"><div><div><h4 class="title">Preparation</h4></div></div></div><div class="para">
						Before you can start working with cloud containers, you must convert your local container into a Fabric container, by invoking the <code class="code">fabric:create</code> command. You <span class="emphasis"><em>cannot</em></span> access the requisite cloud console commands until you create a Fabric locally.
					</div><div class="para">
						To create the Fabric container, enter the following console command:
					</div><pre class="programlisting">JBossFuse:karaf@root&gt; fabric:create --new-user <em class="replaceable">AdminUser</em> --new-user-password <em class="replaceable">AdminPass</em>
  --zookeeper-password <em class="replaceable">ZooPass</em> --wait-for-provisioning</pre><div class="para">
						The <code class="code">--new-user</code> and <code class="code">--new-user-password</code> options specify the credentials for a new administrator user. The <code class="code"><em class="replaceable">ZooPass</em></code> password specifies the password that is used to protect the Zookeeper registry.
					</div><div class="admonition note"><div class="admonition_header">Note</div><div><div class="para">
							If you use a VPN (virtual private network) on your local machine, it is advisable to log off VPN <span class="emphasis"><em>before</em></span> you create the fabric and to stay logged off while you are using the local container. A local Fabric Server is permanently associated with a fixed IP address or hostname. If VPN is enabled when you create the fabric, the underlying Java runtime is liable to detect and use the VPN hostname instead of your permanent local hostname. This can also be an issue with multi-homed machines. To be absolutely sure about the hostname, you could specify the IP address explicitly—see <a class="xref" href="#ESBRuntimeFabricCreate" title="Chapter 2. Creating a New Fabric">Chapter 2, <em>Creating a New Fabric</em></a>.
						</div></div></div><div class="para">
						The next step is to install the console commands that will enable you to administer the cloud. You can do this by adding one of the cloud profiles to your local container. The following cloud profiles are available:
					</div><pre class="programlisting">JBossFuse:karaf@root&gt; profile-list
[id]                                     [# containers] [parents]
...
cloud-aws.ec2                            0              cloud-base
...
cloud-openstack                          0              cloud-base
cloud-servers.uk                         0              cloud-base
cloud-servers.us                         0              cloud-base
...</pre><div class="para">
						For example, to install the requisite JClouds commands for interacting with the Amazon EC2 cloud, deploy the <code class="code">cloud-aws.ec2</code> profile, as follows:
					</div><pre class="programlisting">fabric:container-add-profile root cloud-aws.ec2</pre><div class="para">
						Where we have assumed that <code class="code">root</code> is the name of your local container.
					</div></section><section class="simplesect" id="idp1586080"><div class="titlepage"><div><div><h4 class="title">Feature naming convention</h4></div></div></div><div class="para">
						The most important ingredient of the <code class="code">cloud-aws.ec2</code> profile is the <code class="code">jclouds-aws-ec2</code> feature, which provides the necessary bundles for interacting with Amazon EC2:
					</div><pre class="programlisting">JBossFuse:karaf@root&gt; profile-display cloud-aws.ec2 
Profile id: cloud-aws.ec2
Version   : 1.0
...
Container settings
----------------------------
Features : 
	jclouds-aws-ec2
...</pre><div class="para">
						Some commonly used cloud providers can be accessed using the following Karaf features:
					</div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="code">jclouds-aws-ec2</code></span></dt><dd><div class="para">
									Feature for the Amazon EC2 cloud provider.
								</div></dd><dt><span class="term"><code class="code">jclouds-cloudservers-us</code></span></dt><dd><div class="para">
									Feature for the Rackspace cloud provider.
								</div></dd></dl></div><div class="para">
						In general, the naming convention for cloud provider features is: <code class="code">jclouds-<em class="replaceable">ProviderID</em></code>, where <code class="code"><em class="replaceable">ProviderID</em></code> is one of the provider IDs listed in the <a class="link" href="http://www.jclouds.org/documentation/reference/supported-providers">JClouds supported providers</a> page. Or you can list the available JClouds features using the <code class="code">features:list</code> command:
					</div><pre class="programlisting">features:list | grep jclouds</pre><div class="para">
						If you want to add another JClouds feature to your container, add it to a Fabric profile and then deploy the profile to your container (or add the feature to a profile that is already deployed). For example:
					</div><pre class="programlisting">fabric:profile-edit --features jclouds-<em class="replaceable">ProviderID</em> <em class="replaceable">MyProfile</em>
fabric:container-add-profile root <em class="replaceable">MyProfile</em></pre></section><section class="simplesect" id="idp10513248"><div class="titlepage"><div><div><h4 class="title">Registering a cloud provider</h4></div></div></div><div class="para">
						After installing the required cloud features, you need to register the cloud provider with Fabric, using the <code class="code">fabric:cloud-service-add</code> console command (the registration process will store the provider credentials in the Fabric registry, so that they are available from any Fabric container).
					</div><div class="para">
						You need to obtain a valid <em class="firstterm">identity</em> and <em class="firstterm">credential</em> from your cloud provider, which are not necessarily the same thing as the username and password you obtained upon registration with the provider. Usually, they refer to the credentials you get for using the cloud service from an external API. For example, on Amazon EC2 the requisite credentials can be found on the <a class="link" href="https://console.aws.amazon.com/iam/home?#security-credential">security credentials page</a> (to access ths page, you must have an AWS account).
					</div><div class="para">
						For example, to register the Amazon EC2 provider:
					</div><pre class="programlisting">fabric:cloud-service-add --name aws-ec2 --provider aws-ec2
--identity <em class="replaceable">AccessKeyID</em> --credential <em class="replaceable">SecretAccessKey</em></pre><div class="admonition note"><div class="admonition_header">Note</div><div><div class="para">
							The identifier supplied to the <code class="code">--name</code> option is an alias that you use to refer to this registered cloud provider instance. It is possible to register the same cloud provider more than once, with different user accounts. The cloud provider alias thus enables you distinguish between multiple accounts with the same cloud provider.
						</div></div></div></section></section><section class="section" id="ContCloud-Admin"><div class="titlepage"><div><div><h3 class="title">3.4.2. Administering Cloud Containers</h3></div></div></div><section class="simplesect" id="idp6257792"><div class="titlepage"><div><div><h4 class="title">Creating a new fabric in the cloud</h4></div></div></div><div class="para">
						To create a fabric in the cloud, invoke the <code class="code">fabric:container-create-cloud</code> with the <code class="code">--ensemble-server</code> option, which creates a new Fabric server. For example, to create a Fabric server on Amazon EC2:
					</div><pre class="programlisting">fabric:container-create-cloud --ensemble-server --name aws-ec2
--new-user <em class="replaceable">AdminUser</em> --new-user-password <em class="replaceable">AdminPass</em> --zookeeper-password <em class="replaceable">ZooPass</em> mycontainer</pre></section><section class="simplesect" id="idp2069008"><div class="titlepage"><div><div><h4 class="title">Basic security</h4></div></div></div><div class="para">
						When creating a new fabric in the cloud, it is necessary to supply some basic security information to the <code class="code">fabric:container-create-cloud</code> command, to ensure that the new fabric is adequately protected. You need to specify the following security data:
					</div><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><div class="para">
								<span class="emphasis"><em>JAAS credentials</em></span>—the <code class="code">--new-user</code> and <code class="code">--new-user-password</code> options define JAAS credentials for a new user with administrative privileges on the fabric. These credentials can subsequently be used to log on to the JMX port or the SSH port of the newly created Fabric server.
							</div></li><li class="listitem"><div class="para">
								<span class="emphasis"><em>ZooKeeper password</em></span>—is used to protect the data stored in the ZooKeeper registry in the Fabric server. The only time you will be prompted to enter the ZooKeeper password is when you try to join a container to the fabric using the <code class="code">fabric:join</code> command.
							</div></li></ul></div></section><section class="simplesect" id="idp13279152"><div class="titlepage"><div><div><h4 class="title">Joining a standalone container to the fabric</h4></div></div></div><div class="para">
						If you have been using a standalone container (not part of a fabric) to create the fabric in the cloud, it is a good idea to join this container to the newly created fabric, so that you can easily administer the fabric from your local container. To join your local container to the fabric, enter a command like the following:
					</div><pre class="programlisting">fabric:join -n --zookeeper-password <em class="replaceable">ZooPass</em> <em class="replaceable">PublicIPAddress</em></pre><div class="para">
						Where <code class="code"><em class="replaceable">PublicIPAddress</em></code> is the public host name or the public IP address of the compute instance that hosts the Fabric server (you can get this address either from the JBoss Fuse console output or from the Amazon EC2 console).
					</div><div class="para">
						Alternatively, instead of joining your local container to the fabric, you could use the JBoss Fuse client utility to log into the remote Fabric server directly (using the JAAS credentials).
					</div></section><section class="simplesect" id="idm1441696"><div class="titlepage"><div><div><h4 class="title">Creating a cloud container</h4></div></div></div><div class="para">
						After creating the initial Fabric server (which constitutes the Fabric ensemble), you can use the <code class="code">fabric:container-create-cloud</code> command to create new Fabric containers in the cloud. For example to create a container on Amazon EC2:
					</div><pre class="programlisting">fabric:container-create-cloud --name aws-ec2 mycontainer</pre><div class="para">
						Specifying an image is optional. By default, Fabric tries to find an Ubuntu image for you. You can provide options for the operating system and the O/S version. For example, to choose Centos instead of Ubuntu, you could invoke the <code class="code">fabric:container-create-cloud</code> command with the <code class="code">--os-family</code> option as follows:
					</div><pre class="programlisting">fabric:container-create-cloud --name aws-ec2 --os-family centos mycontainer</pre><div class="para">
						Or to be even more specific, you can specify the O/S version as well, using the <code class="code">--os-version</code> option:
					</div><pre class="programlisting">fabric:container-create-cloud --name aws-ec2 --os-family centos --os-version 5 mycontainer</pre><div class="para">
						If you need to specify the exact image, use the <code class="code">--image</code> option.
					</div><pre class="programlisting">fabric:container-create-cloud --name aws-ec2 --image myimageid mycontainer</pre><div class="para">
						After creating the new cloud container, the command displays the creation status and some useful information:
					</div><pre class="programlisting">Looking up for compute service.
Creating 1 nodes in the cloud. Using operating system: ubuntu. It may take a while ...
Node fabric-f674a68f has been created.
Configuring firewall.
Installing fabric agent on container cloud. It may take a while...
Overriding resolver to publichostname.
                  [id] [container]                    [public addresses]             [status]
  us-east-1/i-f674a68f cloud                          [23.20.114.82]                 success</pre></section><section class="simplesect" id="idm2055552"><div class="titlepage"><div><div><h4 class="title">Images</h4></div></div></div><div class="para">
						Regardless of the way that you specify the image (directly or indirectly), the image needs to have some of the following characteristics:
					</div><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><div class="para">
								Linux O/S
							</div></li><li class="listitem"><div class="para">
								RedHat or Debian packaging style
							</div></li><li class="listitem"><div class="para">
								Either no Java installed or Java 1.7+ installed. If there is no Java installed on the image, Fabric will install Java for you. If the wrong Java version is installed, however, the container installation will fail.
							</div></li></ul></div><div class="para">
						If you prefer, you can create your own custom image and use that instead. But this typically requires some additional configuration when you register the cloud provider. For example, on Amazon EC2 you would need to specify the owner ID of the private image when registering the provider:
					</div><pre class="programlisting">fabric:cloud-service-add --name aws-ec2 --provider aws-ec2
--identity <em class="replaceable">AccessKeyID</em> --credential <em class="replaceable">SecretAccessKey</em> --owner myownerid</pre></section><section class="simplesect" id="idm1006032"><div class="titlepage"><div><div><h4 class="title">Locations and hardware</h4></div></div></div><div class="para">
						Most cloud providers will give you the option to create containers on different locations or using different hardware profiles. You may wonder which are the proper values to use for your provider. Even though Fabric provides completion for <span class="bold bold"><strong>all</strong></span> configuration options, you still may want to get a list of them.
					</div><div class="para">
						To list all of the available locations:
					</div><pre class="programlisting">jclouds:location-list</pre><div class="para">
						To list all the available hardware profiles:
					</div><pre class="programlisting">jclouds:hardware-list</pre><div class="para">
						To exploit this information for creating a cloud container, you can specify them as options to the <code class="code">fabric:container-create-cloud</code> command. For example:
					</div><pre class="programlisting">fabric:container-create-cloud --name aws-ec2 --location eu-west-1 --hardware m2.4xlarge mycontainer</pre></section></section></section></section><section class="chapter" id="Profiles"><div class="titlepage"><div><div><h2 class="title">Chapter 4. Fabric Profiles</h2></div><div><div class="abstract"><p class="title"><strong>Abstract</strong></p><div class="para">
						A profile is the basic unit of deployment in a fabric. This chapter describes how to create, edit, and deploy profiles into containers. You can also create different versions of a profile, which makes it possible to support rolling upgrades across the containers in your fabric.
					</div></div></div></div></div><section class="section" id="Profiles-Intro"><div class="titlepage"><div><div><h2 class="title">4.1. Introduction to Profiles</h2></div></div></div><section class="simplesect" id="topic-32296"><div class="titlepage"><div><div><h3 class="title">Overview</h3></div></div></div><div class="para">
					A profile is a description of how to provision a logical group of containers. Each profile can have none, one, or more parents, which allows you to have profile hierarchies. A container can be assigned one or more profiles. Profiles are also versioned, which enables you to maintain different versions of each profile, and then upgrade or roll back containers, by changing the version of the profiles they use.
				</div></section><section class="simplesect" id="topic-32297"><div class="titlepage"><div><div><h3 class="title">What is in a profile?</h3></div></div></div><div class="para">
					A profile can contain one or more of the following resources:
				</div><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><div class="para">
							OSGi bundle URLs
						</div></li><li class="listitem"><div class="para">
							Web ARchive (WAR) URLs
						</div></li><li class="listitem"><div class="para">
							Fuse Application Bundle (FAB) URLs
						</div></li><li class="listitem"><div class="para">
							OSGi Configuration Admin PIDs
						</div></li><li class="listitem"><div class="para">
							Apache Karaf feature repository URLs
						</div></li><li class="listitem"><div class="para">
							Apache Karaf features
						</div></li><li class="listitem"><div class="para">
							Maven artifact repository URLs
						</div></li><li class="listitem"><div class="para">
							Blueprint XML files or Spring XML files (for example, for defining broker configurations or Camel routes)
						</div></li><li class="listitem"><div class="para">
							Any kind of resource that might be needed by an application (for example, Java properties file, JSON file, XML file, YML file)
						</div></li><li class="listitem"><div class="para">
							System properties that affect the Apache Karaf container (analogous to editing <code class="code">etc/config.properties</code>)
						</div></li><li class="listitem"><div class="para">
							System properties that affect installed bundles (analogous to editing <code class="code">etc/system.properties</code>)
						</div></li></ul></div></section><section class="simplesect" id="topic-32298"><div class="titlepage"><div><div><h3 class="title">Profile hierarchies</h3></div></div></div><div class="para">
					Frequently, multiple profiles share a lot of configuration details: such as common frameworks, libraries, and so on. Defining these details separately for each profile would create a considerable maintenance headache. To avoid duplication across profiles, therefore, Fabric uses a hierarchical model for profiles. You can define a generic profile (base profile) containing the common configuration details, and then define child profiles that inherit these generic configuration details.
				</div></section><section class="simplesect" id="topic-32299"><div class="titlepage"><div><div><h3 class="title">Some basic profiles</h3></div></div></div><div class="para">
					Fabric provides a rich set of predefined profiles, which can be used as the basic building blocks for defining your own profiles. Some of the more interesting predefined profiles are:
				</div><div class="variablelist"><dl class="variablelist"><dt><span class="term">[<span class="citation">default</span>]</span></dt><dd><div class="para">
								The <code class="code">default</code> profile defines all of the basic requirements for a Fabric container. For example it specifies the <code class="code">fabric-agent</code> feature, the Fabric registry URL, and the list of Maven repositories from which artifacts can be downloaded.
							</div></dd><dt><span class="term">[<span class="citation">karaf</span>]</span></dt><dd><div class="para">
								Inherits from the <code class="code">default</code> profile and defines the Karaf feature repositories, which makes the Apache Karaf features accessible.
							</div></dd><dt><span class="term">[<span class="citation">feature-camel</span>]</span></dt><dd><div class="para">
								Inherits from <code class="code">karaf</code>, defines the Camel feature repositories, and installs some core Camel features: such as <code class="code">camel-core</code> and <code class="code">camel-blueprint</code>. If you are deploying a Camel application, it is recommended that you inherit from this profile.
							</div></dd><dt><span class="term">[<span class="citation">feature-cxf</span>]</span></dt><dd><div class="para">
								Inherits from <code class="code">karaf</code>, defines the CXF feature repositories, and installs some core CXF features. If you are deploying a CXF application, it is recommended that you inherit from this profile.
							</div></dd><dt><span class="term">[<span class="citation">mq-base</span>]</span></dt><dd><div class="para">
								Inherits from the <code class="code">karaf</code> profile and installs the <code class="code">mq-fabric</code> feature
							</div></dd><dt><span class="term">[<span class="citation">mq-default</span>]</span></dt><dd><div class="para">
								Inherits from the <code class="code">mq-base</code> profile and provides the configuration for an A-MQ broker. Use this profile, if you want to deploy a minimal installation of an ActiveMQ broker.
							</div></dd><dt><span class="term">[<span class="citation">jboss-fuse-full</span>]</span></dt><dd><div class="para">
								Includes all of the features and bundles required for the JBoss Fuse full container.
							</div></dd></dl></div></section></section><section class="section" id="Profiles-Working"><div class="titlepage"><div><div><h2 class="title">4.2. Working with Profiles</h2></div></div></div><section class="simplesect" id="topic-32300"><div class="titlepage"><div><div><h3 class="title">Changing the profiles in a container</h3></div></div></div><div class="para">
					To change the profiles assigned to a Fabric container, invoke the <code class="code">fabric:container-change-profile</code> command as follows:
				</div><pre class="programlisting">fabric:container-change-profile mycontainer myprofile</pre><div class="para">
					Where the preceding command deploys the <code class="code">myprofile</code> profile to the <code class="code">mycontainer</code> container. All profiles previously assigned to the container are removed. You can also deploy multiple profiles to the container, with the following command:
				</div><pre class="programlisting">fabric:container-change-profile mycontainer myprofile myotherprofile</pre></section><section class="simplesect" id="topic-32301"><div class="titlepage"><div><div><h3 class="title">Adding a profile to a container</h3></div></div></div><div class="para">
					The <code class="code">fabric:container-add-profile</code> command gives you a simple way to add profiles to a container, without having to list all of the profiles that were already assigned. For example, to add the <code class="code">example-camel</code> profile to the <code class="code">mycontainer</code> container:
				</div><pre class="programlisting">fabric:container-add-profile mycontainer example-camel</pre></section><section class="simplesect" id="topic-32302"><div class="titlepage"><div><div><h3 class="title">Listing available profiles</h3></div></div></div><div class="para">
					To see the list of available profiles, invoke the <code class="code">fabric:profile-list</code> console command:
				</div><pre class="programlisting">fabric:profile-list</pre><div class="para">
					The command displays all available profiles, showing their parents and the number of containers each profile is deployed into.
				</div></section><section class="simplesect" id="topic-32303"><div class="titlepage"><div><div><h3 class="title">Inspecting profiles</h3></div></div></div><div class="para">
					To see exactly what a profile defines, enter the <code class="code">fabric:profile-display</code> command. For example, to display what is defined in the <code class="code">feature-camel</code> profile, enter the following command:
				</div><pre class="programlisting">fabric:profile-display feature-camel</pre><div class="para">
					Which outputs something like the following to the console window:
				</div><pre class="programlisting">Profile id: feature-camel
Version   : 1.0
Attributes: 
    parents: karaf

Containers: 

Container settings
----------------------------
Repositories : 
    mvn:org.apache.camel.karaf/apache-camel/${version:camel}/xml/features

Features : 
    camel-core
    camel-blueprint
    fabric-camel

Configuration details
----------------------------

Other resources
----------------------------
Resource: org.fusesource.insight.metrics.json</pre><div class="para">
					The preceding output does not take into account the definitions inherited from any parent profiles, however. To see the effective definitions for the <code class="code">feature-camel</code> profile, taking into account all of its ancestors, you must specify the <code class="code">--overlay</code> switch, as follows:
				</div><pre class="programlisting">fabric:profile-display --overlay feature-camel</pre><div class="para">
					Resource files stored in the profile are listed under the heading Other resources. If you want to display the contents of these resource files as well, add the <code class="code">--display-resources</code> switch (or <code class="code">-r</code> for short) to the <code class="code">profile-display</code> command, as follows:
				</div><pre class="programlisting">fabric:profile-display -r feature-camel</pre></section><section class="simplesect" id="topic-32304"><div class="titlepage"><div><div><h3 class="title">Creating a new profile</h3></div></div></div><div class="para">
					To create a new profile for an application, invoke the <code class="code">fabric:profile-create</code> command, as follows:
				</div><pre class="programlisting">fabric:profile-create myprofile</pre><div class="para">
					To specify one ore more parents for the profile when it is being created, add the <code class="code">--parents</code> option to the command:
				</div><pre class="programlisting">fabric:profile-create --parents feature-camel myprofile</pre><div class="para">
					After the profile is created, you can start to modify the profile, providing details of what should be deployed in the profile.
				</div></section><section class="simplesect" id="topic-32305"><div class="titlepage"><div><div><h3 class="title">Adding or removing features</h3></div></div></div><div class="para">
					To edit one of the existing profiles, you can use the <code class="code">fabric:profile-edit</code> command. For example, to add the <code class="code">camel-jclouds</code> feature to the <code class="code">feature-camel</code> profile.
				</div><pre class="programlisting">fabric:profile-edit --feature camel-jclouds feature-camel</pre><div class="para">
					Now invoke the <code class="code">fabric:profile-display</code> command to see what the camel profile looks like now. You should see that the <code class="code">camel-jclouds</code> feature appears in the list of features for the <code class="code">feature-camel</code> profile.
				</div><pre class="programlisting">Features :
        	camel-jclouds
        	camel-blueprint/2.9.0.fuse-7-061
        	camel-core/2.9.0.fuse-7-061
        	fabric-camel/99-master-SNAPSHOT</pre><div class="para">
					If you want to remove a feature from the profile, use the <code class="code">--delete</code> option. For example, if you need to remove the <code class="code">camel-jclouds</code> feature, you could use the following command:
				</div><pre class="programlisting">fabric:profile-edit --delete --feature camel-jclouds feature-camel</pre></section><section class="simplesect" id="topic-32306"><div class="titlepage"><div><div><h3 class="title">Editing PID properties</h3></div></div></div><div class="para">
					An OSGi Config Admin Persistent ID (PID) consists essentially of a list of key-value pairs. You can edit PID properties using either of the following approaches:
				</div><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><div class="para">
							<span class="emphasis"><em>Edit the PID using the built-in text editor</em></span>—the Karaf console has a built-in text editor which you can use to edit profile resources such as PID properties. To start editing a PID using the text editor, enter the following console command:
						</div><pre class="programlisting">fabric:profile-edit --pid <em class="replaceable">PID</em> <em class="replaceable">ProfileName</em></pre><div class="para">
							For more details about the built-in text editor, see <a class="xref" href="#ProfileEdit" title="Appendix A. Editing Profiles with the Built-In Text Editor">Appendix A, <em>Editing Profiles with the Built-In Text Editor</em></a>.
						</div></li><li class="listitem"><div class="para">
							<span class="emphasis"><em>Edit the PID inline, using console commands</em></span>—alternatively, you can edit PIDs directly from the console, using the appropriate form of the <code class="code">fabric:profile-edit</code> command. This approach is particularly useful for scripting. For example, to set a specific key-value pair, <code class="code"><em class="replaceable">Key</em>=<em class="replaceable">Value</em></code>, in a PID, enter the following console command:
						</div><pre class="programlisting">fabric:profile-edit --pid <em class="replaceable">PID</em>/<em class="replaceable">Key</em>=<em class="replaceable">Value</em> <em class="replaceable">ProfileName</em></pre></li></ul></div></section><section class="simplesect" id="topic-32307"><div class="titlepage"><div><div><h3 class="title">Editing a PID inline</h3></div></div></div><div class="para">
					To edit a PID inline, use the following variants of the <code class="code">fabric:profile-edit</code> command:
				</div><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><div class="para">
							Assign a value to a PID property, as follows:
						</div><pre class="programlisting">fabric:profile-edit --pid <em class="replaceable">PID</em>/<em class="replaceable">Key</em>=<em class="replaceable">Value</em> <em class="replaceable">ProfileName</em></pre></li><li class="listitem"><div class="para">
							Append a value to a delimited list (that is, where the property value is a <span class="emphasis"><em>comma-separated list</em></span>), as follows:
						</div><pre class="programlisting">fabric:profile-edit --append --pid <em class="replaceable">PID</em>/<em class="replaceable">Key</em>=<em class="replaceable">ListItem</em> <em class="replaceable">ProfileName</em></pre></li><li class="listitem"><div class="para">
							Remove a value from a delimited list, as follows:
						</div><pre class="programlisting">fabric:profile-edit --remove --pid <em class="replaceable">PID</em>/<em class="replaceable">Key</em>=<em class="replaceable">ListItem</em> <em class="replaceable">ProfileName</em></pre></li><li class="listitem"><div class="para">
							Delete a specific property key, as follows:
						</div><pre class="programlisting">fabric:profile-edit --delete --pid <em class="replaceable">PID</em>/<em class="replaceable">Key</em> <em class="replaceable">ProfileName</em></pre></li><li class="listitem"><div class="para">
							Delete a complete PID, as follows:
						</div><pre class="programlisting">fabric:profile-edit --delete --pid <em class="replaceable">PID</em> <em class="replaceable">ProfileName</em></pre></li></ul></div></section><section class="simplesect" id="topic-32308"><div class="titlepage"><div><div><h3 class="title">Example of editing a PID inline</h3></div></div></div><div class="para">
					In the following example, we modify the <code class="code">io.fabric8.agent</code> PID, changing the Maven repository list setting. The <code class="code">default</code> profile contains a section like this:
				</div><pre class="programlisting">Agent Properties :
        org.ops4j.pax.url.mvn.repositories = 	http://repo1.maven.org/maven2,
            http://repo.fusesource.com/nexus/content/repositories/releases,
            http://repo.fusesource.com/nexus/content/groups/ea,
            http://repository.springsource.com/maven/bundles/release,
            http://repository.springsource.com/maven/bundles/external,
            http://scala-tools.org/repo-releases</pre><div class="para">
					The agent properties section is represented by the <code class="code">io.fabric8.agent</code> PID. So, by modifying the <code class="code">io.fabric8.agent</code> PID, we effectively change the agent properties. You can modify the list of Maven repositories in the agent properties PID as follows:
				</div><pre class="programlisting">fabric:profile-edit --pid io.fabric8.agent/org.ops4j.pax.url.mvn.repositories=http://repositorymanager.mylocalnetwork.net default</pre><div class="para">
					Now when you invoke <code class="code">fabric:profile-display</code> on the <code class="code">default</code> profile, you should see agent properties similar to the following:
				</div><pre class="programlisting">Agent Properties :
        org.ops4j.pax.url.mvn.repositories = http://repositorymanager.mylocalnetwork.net</pre></section><section class="simplesect" id="topic-32309"><div class="titlepage"><div><div><h3 class="title">Setting encrypted PID property values</h3></div></div></div><div class="para">
					In some cases, you might prefer to store PID property values in encrypted format instead of plain text. For example, passwords and other sensitive data should usually be stored in encrypted form. To store a property value in encrypted form, perform the following steps:
				</div><div class="procedure"><ol class="procedure" type="1"><li class="step"><div class="para">
							Use the <code class="code">fabric:encrypt-message</code> command to encrypt the property value, as follows:
						</div><div class="informalexample"><pre class="programlisting">fabric:encrypt-message <em class="replaceable">PropValue</em></pre></div><div class="para">
							This command returns the encrypted property value, <code class="code"><em class="replaceable">EncryptedValue</em></code>.
						</div><div class="admonition note"><div class="admonition_header">Note</div><div><div class="para">
								The default encryption algorithm used by Fabric is <code class="code">PBEWithMD5AndDES</code>.
							</div></div></div></li><li class="step"><div class="para">
							You can now set the property to the encrypted value, <code class="code"><em class="replaceable">EncryptedValue</em></code>, using the following syntax:
						</div><div class="informalexample"><pre class="programlisting">my.sensitive.property = ${crypt:<em class="replaceable">EncryptedValue</em>}</pre></div><div class="para">
							For example, using the <code class="code">fabric:profile-edit</code> command, you can set an encrypted value as follows:
						</div><div class="informalexample"><pre class="programlisting">fabric:profile-edit --pid com.example.my.pid/my.sensitive.property=${crypt:<em class="replaceable">EncryptedValue</em>} <em class="replaceable">Profile</em></pre></div></li></ol></div><div class="admonition warning"><div class="admonition_header">Warning</div><div><div class="para">
						These encrypted values are protected by the master password, which is accessible to anyone who can log on to a Fabric container. To keep these encrypted values safe, you must restrict access to the containers in the fabric.

					</div></div></div></section><section class="simplesect" id="topic-32310"><div class="titlepage"><div><div><h3 class="title">Alternative method for encrypting PID property values</h3></div></div></div><div class="para">
					The underlying encryption mechanism for PID properties is based on the <a class="link" href="http://jasypt.org/">Jasypt</a> encryption toolkit. Consequently, it is also possible to encrypt PID properties directly, using the Jasypt toolkit, as follows:
				</div><div class="procedure"><ol class="procedure" type="1"><li class="step"><div class="para">
							<a class="link" href="http://jasypt.org/download.html">Download and install Jasypt</a>, to gain access to the Jasypt <code class="code">encrypt</code> and <code class="code">decrypt</code> command-line tools.
						</div></li><li class="step"><div class="para">
							Use the Jasypt <code class="code">encrypt</code> command-line tool to encrypt the property value, as follows:
						</div><div class="informalexample"><pre class="programlisting">./encrypt.sh input="Property value to be encrypted" password=<em class="replaceable">ZooPass</em> verbose=false</pre></div><div class="para">
							This command returns the encrypted property value, <code class="code"><em class="replaceable">EncryptedValue</em></code>.
						</div><div class="admonition note"><div class="admonition_header">Note</div><div><div class="para">
								The default encryption algorithm used by Fabric is <code class="code">PBEWithMD5AndDES</code>. You must ensure that the <code class="code">encrypt.sh</code> utility is using the same algorithm as Fabric.
							</div></div></div></li></ol></div></section><section class="simplesect" id="topic-32311"><div class="titlepage"><div><div><h3 class="title">Customizing the PID property encryption mechanism</h3></div></div></div><div class="para">
					You can customize the PID property encryption mechanism, as follows:
				</div><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><div class="para">
							<span class="emphasis"><em>Customize the master password for encryption</em></span>—using the following console command:
						</div><pre class="programlisting">fabric:crypt-password-set <em class="replaceable">MasterPassword</em></pre><div class="para">
							You can retrieve the current master password by entering the <code class="code">fabric:crypt-password-get</code> command. The default value is the ensemble password (as returned by <code class="code">fabric:ensemble-password</code>).
						</div></li><li class="listitem"><div class="para">
							<span class="emphasis"><em>Customize the encryption algorithm</em></span>—using the following console command:
						</div><pre class="programlisting">fabric:crypt-algorithm-set <em class="replaceable">Algorithm</em></pre><div class="para">
							Where the encryption algorithm must be one of the algorithms supported by the underlying <a class="link" href="http://jasypt.org/">Jasypt</a> encryption toolkit. You can retrieve the current encryption algorithm by entering the <code class="code">fabric:crypt-algorithm-get</code> command. The default is <code class="code">PBEWithMD5AndDES</code>.
						</div></li></ul></div></section><section class="simplesect" id="topic-32312"><div class="titlepage"><div><div><h3 class="title">Profile editor</h3></div></div></div><div class="para">
					If you want to make extensive edits to a profile, it is not very convenient to make changes one setting at a time. There is a more convenient approach for making extensive profile edits, and that is to use the console's built-in profile editor, which is a simple screen-based text editor.
				</div><div class="para">
					For example, to open the agent properties resource for editing, simply invoke the <code class="code">fabric:profile-edit</code> command without any options, as follows:
				</div><pre class="programlisting">fabric:profile-edit <em class="replaceable">Profile</em> [<em class="replaceable">Version</em>]</pre><div class="para">
					A simple text editor opens, enabling to edit the configuration settings in the agent properties.
				</div><div class="para">
					For full details of how to edit profiles using the built-in text editor, see <a class="xref" href="#ProfileEdit" title="Appendix A. Editing Profiles with the Built-In Text Editor">Appendix A, <em>Editing Profiles with the Built-In Text Editor</em></a>.
				</div></section><section class="simplesect" id="topic-32313"><div class="titlepage"><div><div><h3 class="title">Editing resources with the profile editor</h3></div></div></div><div class="para">
					A practical way to edit a general profile resource (such as an XML configuration resourct) is to use the build-in text editor. For example, to start editing the <code class="code">broker.xml</code> file in the <code class="code">mq-amq</code> profile, enter the following console command:
				</div><pre class="programlisting">fabric:profile-edit --resource broker.xml mq-amq</pre></section></section><section class="section" id="Profiles-Versions"><div class="titlepage"><div><div><h2 class="title">4.3. Profile Versions</h2></div></div></div><section class="simplesect" id="topic-32314"><div class="titlepage"><div><div><h3 class="title">Overview</h3></div></div></div><div class="para">
					Every profile has at least one version. When assigning a profile to a container, you actually assign both the profile and the version. The <code class="code">fabric-agent</code>, will choose the defined version and retrieve all the information provided by the specific version of the profile.
				</div><div class="para">
					Any change to a profile takes immediate effect. This means that any container using a profile that was just modified will pick up the change immediately. It is recommended that you create a new version of a profile whenever you need to make changes. You can then upgrade containers to use the new version. This enables you to perform atomic updates, test updates on specific containers, and possibly roll back to the previous version, if you encounter any problems.
				</div></section><section class="simplesect" id="topic-32315"><div class="titlepage"><div><div><h3 class="title">Creating a new version</h3></div></div></div><div class="para">
					You can create a new version using the <code class="code">fabric:version-create</code> command (analogous to creating a new branch in the underlying Git repository). The default version is 1.0. To create version 1.1, enter the following command:
				</div><pre class="programlisting">fabric:version-create 1.1</pre><div class="admonition note"><div class="admonition_header">Note</div><div><div class="para">
						To note what is changing in the new version, include the <span class="property">--description</span> argument and enclose the text within double quotes; for example, <code class="code">fabric:version-create --description "expanding all camel routes" 1.1</code>.
					</div></div></div><div class="para">
					After the 1.1 version is created, a new instance of every profile is created for the new version (copied from the previous latest version, which was 1.0). Now you can display or modify the 1.1 version of each profile. For example, enter the following command to display the details of the <code class="code">feature-camel</code> profile:
				</div><pre class="programlisting">fabric:profile-display --version 1.1 feature-camel</pre><div class="para">
					Initially, the output is identical to the 1.0 version of the profile, because we have not yet modified the new version of the profile. But how do you modify a specific version of a profile? All you need to do is to invoke the <code class="code">fabric:profile-edit</code> command, specifying the version right after the profile argument. For example, to add the <code class="code">camel-jclouds</code> feature to version 1.1 of the <code class="code">feature-camel</code> profile, enter the following command:
				</div><pre class="programlisting">fabric:profile-edit --feature camel-jclouds feature-camel 1.1</pre><div class="admonition important"><div class="admonition_header">Important</div><div><div class="para">
						The changes made to version 1.1 of the profile do <span class="emphasis"><em>not</em></span> (yet) affect any of your existing containers. The changes do not take effect until you upgrade your containers to use the 1.1 version.
					</div></div></div></section><section class="simplesect" id="topic-32316"><div class="titlepage"><div><div><h3 class="title">Rolling upgrades and rollbacks</h3></div></div></div><div class="para">
					Fabric provides commands for <em class="firstterm">upgrading</em> (incrementing the effective version) and <em class="firstterm">rolling back</em> (decrementing the effective version) the profiles assigned to a container. For example, to upgrade the <code class="code">mycontainer</code> container to the 1.1 version, invoke the <code class="code">fabric:container-upgrade</code> command as follows:
				</div><pre class="programlisting">fabric:container-upgrade 1.1 mycontainer</pre><div class="para">
					The preceding command makes <code class="code">mycontainer</code> to use version 1.1 of all the profiles currently assigned to it.
				</div><div class="para">
					If for any reason you want to roll back to the previous version, you can invoke the <code class="code">fabric:container-rollback</code> command, as follows:
				</div><pre class="programlisting">fabric:container-rollback 1.0 mycontainer</pre><div class="para">
					It is strongly recommended that you test any profile changes on a <span class="emphasis"><em>single</em></span> container, before applying the changes to the whole cluster. Applying an upgrade to all containers can be achieved by specifying the <code class="code">--all</code> option, as follows:
				</div><pre class="programlisting">fabric:container-upgrade --all 1.1 mycontainer</pre></section></section></section><section class="chapter" id="F8Plugin"><div class="titlepage"><div><div><h2 class="title">Chapter 5. Fabric8 Maven Plug-In</h2></div><div><div class="abstract"><p class="title"><strong>Abstract</strong></p><div class="para">
						This maven plug-in makes it easy to create or update a fabric profile from your Maven project.
					</div></div></div></div></div><section class="section" id="F8Plugin-Prepare"><div class="titlepage"><div><div><h2 class="title">5.1. Preparing to Use the Plug-In</h2></div></div></div><section class="simplesect" id="topic-32434"><div class="titlepage"><div><div><h3 class="title">Edit your Maven settings</h3></div></div></div><div class="para">
					First you will need to edit your <code class="code">~/.m2/settings.xml</code> file to add the fabric server's user and password so that the maven plugin can log in to the fabric. For example, you could add the following <code class="code">server</code> element to your <code class="code">settings.xml</code> file:
				</div><pre class="programlisting">&lt;settings&gt;
  &lt;servers&gt;
    &lt;server&gt;
      &lt;id&gt;fabric8.upload.repo&lt;/id&gt;
      &lt;username&gt;<em class="replaceable">Username</em>&lt;/username&gt;
      &lt;password&gt;<em class="replaceable">Password</em>&lt;/password&gt;
    &lt;/server&gt;
    ...
  &lt;/servers&gt;
&lt;/settings&gt;</pre><div class="para">
					Where <code class="code"><em class="replaceable">Username</em></code> and <code class="code"><em class="replaceable">Password</em></code> are the credentials of a Fabric user with administrative privileges (for example, the credentials you would use to log on to the Management Console).
				</div></section><section class="simplesect" id="topic-32435"><div class="titlepage"><div><div><h3 class="title">Customising the repository ID</h3></div></div></div><div class="para">
					The default Fabric Maven repository ID is <code class="code">fabric8.upload.repo</code>. You can specify additional <code class="code">server</code> elements in your <code class="code">settings.xml</code> file for each of the fabrics you need to work with. To select the relevant credentials, you can set the <code class="code">serverId</code> property in the Fabric8 Maven plug-in <code class="code">configuration</code> section (see <a class="xref" href="#F8Plugin-Props" title="5.4. Configuration Properties">Section 5.4, “Configuration Properties”</a>) or set the <code class="code">fabric8.serverId</code> Maven property.
				</div></section></section><section class="section" id="F8Plugin-Using"><div class="titlepage"><div><div><h2 class="title">5.2. Using the Plug-In to Deploy a Maven Project</h2></div></div></div><section class="simplesect" id="topic-32436"><div class="titlepage"><div><div><h3 class="title">Prerequisites</h3></div></div></div><div class="para">
					You must ensure the following prerequisites are satisfied before attempting to run the Fabric8 Maven plug-in:
				</div><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><div class="para">
							Your Maven <code class="code">~/.m2/settings.xml</code> file is configured as described in <a class="xref" href="#F8Plugin-Prepare" title="5.1. Preparing to Use the Plug-In">Section 5.1, “Preparing to Use the Plug-In”</a>.
						</div></li><li class="listitem"><div class="para">
							A JBoss Fuse container instance is running on your local machine (alternatively, if the container instance is running on a remote host, you must configure the plug-in's <code class="code">jolokiaUrl</code> property appropriately).
						</div></li></ol></div></section><section class="simplesect" id="topic-32437"><div class="titlepage"><div><div><h3 class="title">Running the plug-in on any Maven project</h3></div></div></div><div class="para">
					To use the Fabric8 plug-in to deploy any maven project into a fabric profile, enter the following Maven command:
				</div><pre class="programlisting">mvn io.fabric8:fabric8-maven-plugin:1.0.0.redhat-355:deploy</pre></section><section class="simplesect" id="topic-32438"><div class="titlepage"><div><div><h3 class="title">Adding the plug-in to a Maven POM</h3></div></div></div><div class="para">
					If you add the Fabric8 plug-in to your <code class="code">pom.xml</code> file as follows:
				</div><pre class="programlisting">&lt;plugins&gt;
  &lt;plugin&gt;
    &lt;groupId&gt;io.fabric8&lt;/groupId&gt;
    &lt;artifactId&gt;fabric8-maven-plugin&lt;/artifactId&gt;
    &lt;version&gt;1.2.0.redhat-133&lt;/version&gt;
    &lt;configuration&gt;
      &lt;profile&gt;testprofile&lt;/profile&gt;
      &lt;version&gt;1.2&lt;/version&gt;
    &lt;/configuration&gt;
  &lt;/plugin&gt;
&lt;/plugins&gt;</pre><div class="para">
					Where the <code class="code">plugin/configuration/version</code> element specifies the Fabric8 version of the target system (which is not necessarily the same as the version of the Fabric8 Maven plug-in).
				</div><div class="para">
					You can now use the following more concise Maven goal:
				</div><pre class="programlisting">mvn fabric8:deploy</pre></section><section class="simplesect" id="topic-32439"><div class="titlepage"><div><div><h3 class="title">What does the plug-in do?</h3></div></div></div><div class="para">
					When you deploy your project to a Fabric profile with this plug-in, the plug-in does the following:
				</div><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><div class="para">
							Uploads any artifacts into the fabric's maven repository,
						</div></li><li class="listitem"><div class="para">
							Lazily creates the Fabric profile or version you specify,
						</div></li><li class="listitem"><div class="para">
							Adds/updates the maven project artifact into the profile configuration,
						</div></li><li class="listitem"><div class="para">
							Adds any additional parent profile, bundles or features to the profile.
						</div></li></ul></div></section><section class="simplesect" id="topic-32440"><div class="titlepage"><div><div><h3 class="title">Example</h3></div></div></div><div class="para">
					You can try out the plug-in with one of the JBoss Fuse <code class="code">quickstart</code> examples, as follows:
				</div><pre class="programlisting">cd <em class="replaceable">InstallDir</em>/quickstarts/rest
mvn io.fabric8:fabric8-maven-plugin:1.0.0.redhat-355:deploy</pre><div class="para">
					You should see a new profile created at the <a class="link" href="http://localhost:8181/hawtio/index.html#/wiki/branch/1.0/view/fabric/profiles/my/rest.profile">my-rest/rest profile page</a>, which should have a bundle and some features (click on the <span class="guilabel">Bundle</span> tab and the <span class="guilabel">Feature</span> tab).
				</div></section></section><section class="section" id="F8Plugin-Config"><div class="titlepage"><div><div><h2 class="title">5.3. Configuring the Plug-In</h2></div></div></div><section class="simplesect" id="topic-32441"><div class="titlepage"><div><div><h3 class="title">Specifying profile information</h3></div></div></div><div class="para">
					You can explicitly configure the name of the profile to create, by adding a <code class="code">configuration</code> element to the plug-in configuration in your <code class="code">pom.xml</code> file, as follows:
				</div><pre class="programlisting">&lt;plugins&gt;
  &lt;plugin&gt;
    &lt;groupId&gt;io.fabric8&lt;/groupId&gt;
    &lt;artifactId&gt;fabric8-maven-plugin&lt;/artifactId&gt;
    &lt;configuration&gt;
      <span class="bold bold"><strong>&lt;profile&gt;my-thing&lt;/profile&gt;</strong></span>
    &lt;/configuration&gt;
  &lt;/plugin&gt;
&lt;/plugins&gt;</pre></section><section class="simplesect" id="topic-32442"><div class="titlepage"><div><div><h3 class="title">Multi-module Maven projects</h3></div></div></div><div class="para">
					For multi-module Maven projects, a more flexible way to configure the plug-in is to use Maven properties. For example if you have a multi-module maven project such as this:
				</div><pre class="programlisting">pom.xml
foo/
  pom.xml
  a/pom.xml
  b/pom.xml
  ...
bar/
  pom.xml
  c/pom.xml
  d/pom.xml
  ...</pre><div class="para">
					You could define the plug-in once in the root <code class="code">pom.xml</code> file, as follows:
				</div><pre class="programlisting">&lt;plugins&gt;
  &lt;plugin&gt;
    &lt;groupId&gt;io.fabric8&lt;/groupId&gt;
    &lt;artifactId&gt;fabric8-maven-plugin&lt;/artifactId&gt;
  &lt;/plugin&gt;
&lt;/plugins&gt;</pre><div class="para">
					While in the <code class="code">foo/pom.xml</code> file you need only define the <code class="code">fabric8.profile</code> property, as follows:
				</div><pre class="programlisting">&lt;project&gt;
  ...
  &lt;properties&gt;
    &lt;fabric8.profile&gt;my-foo&lt;/fabric8.profile&gt;
    ...
  &lt;/properties&gt;
  ...
&lt;/project&gt;</pre><div class="para">
					All of the projects within the <code class="code">foo</code> folder, such as <code class="code">foo/a</code> and <code class="code">foo/b</code>, will deploy to the same profile (in this case the profile, <code class="code">my-foo</code>). You can use the same approach to put all of the projects under the <code class="code">bar</code> folder into a different profile too.
				</div><div class="para">
					At any point in your tree of maven projects you can define a maven <code class="code">fabric8.profile</code> property to specify exactly where it gets deployed; along with any other property on the plug-in (see the Property Reference below).
				</div></section><section class="simplesect" id="topic-32443"><div class="titlepage"><div><div><h3 class="title">Specifying features, additional bundles, repositories and parent profiles</h3></div></div></div><div class="para">
					You can specify additional configuration in the maven plug-in, as follows:
				</div><pre class="programlisting">&lt;plugins&gt;
  &lt;plugin&gt;
    &lt;groupId&gt;io.fabric8&lt;/groupId&gt;
    &lt;artifactId&gt;fabric8-maven-plugin&lt;/artifactId&gt;
    &lt;configuration&gt;
      &lt;profile&gt;my-rest&lt;/profile&gt;
      &lt;features&gt;fabric-cxf-registry fabric-cxf cxf war swagger&lt;/features&gt;
      &lt;featureRepos&gt;mvn:org.apache.cxf.karaf/apache-cxf/${version:cxf}/xml/features&lt;/featureRepos&gt;
    &lt;/configuration&gt;
  &lt;/plugin&gt;
&lt;/plugins&gt;</pre><div class="para">
					Note that the <code class="code">features</code> element allows you to specify a space-separated list of features to include in the profile.
				</div><div class="para">
					This example specifies space-separated lists for the parent profile IDs, features, repositories and bundles so that it is easy to reuse Maven properties for these values (for example, to add some extra features to a child maven project while inheriting from the parent project).
				</div></section><section class="simplesect" id="topic-32444"><div class="titlepage"><div><div><h3 class="title">Configuring with Maven properties</h3></div></div></div><div class="para">
					You can also use maven property values (or command line arguments) to specify the configuration values by prefixing the property name with <code class="code">fabric8.</code>. For example, to deploy a maven project to the <code class="code">cheese</code> profile name, enter the command:
				</div><pre class="programlisting">mvn fabric8:deploy -Dfabric8.profile=cheese</pre><div class="para">
					By default, the project artifacts are uploaded to the Maven repository inside the fabric. If you want to disable this beahvior and just update the profile configuration (for example, if you are already pointing your fabric's Maven repository to your local Maven repository), you can set <code class="code">fabric8.upload=false</code>—for example:
				</div><pre class="programlisting">mvn fabric8:deploy -Dfabric8.upload=false</pre></section><section class="simplesect" id="topic-32445"><div class="titlepage"><div><div><h3 class="title">Specifying profile resources</h3></div></div></div><div class="para">
					If you create the directory, <code class="code">src/main/fabric8</code>, in your Maven project and add any resource files or a <code class="code">ReadMe.md</code> file to your project, they will automatically be uploaded into the profile as well. For example, if you run the following commands from your Maven project directory:
				</div><pre class="programlisting">mkdir -p src/main/fabric8
echo "## Hello World" &gt;&gt; src/main/fabric8/ReadMe.md
mvn fabric8:deploy</pre><div class="para">
					The newly deployed profile will include a <code class="code">ReadMe.md</code> wiki page.
				</div></section></section><section class="section" id="F8Plugin-Props"><div class="titlepage"><div><div><h2 class="title">5.4. Configuration Properties</h2></div></div></div><section class="simplesect" id="topic-32446"><div class="titlepage"><div><div><h3 class="title">Specifying properties</h3></div></div></div><div class="para">
					Properties can be specified either as elements inside the <code class="code">configuration</code> element of the plug-in in your project's <code class="code">pom.xml</code> file. For example, the <code class="code">profile</code> property can be set as follows:
				</div><pre class="programlisting">&lt;plugins&gt;
  &lt;plugin&gt;
    &lt;groupId&gt;io.fabric8&lt;/groupId&gt;
    &lt;artifactId&gt;fabric8-maven-plugin&lt;/artifactId&gt;
    &lt;configuration&gt;
      &lt;profile&gt;${fabric8.profile}&lt;/profile&gt;
    &lt;/configuration&gt;
  &lt;/plugin&gt;
&lt;/plugins&gt;</pre><div class="para">
					Or you can specify the properties on the command line or as Maven build properties (where the property names must be prefixed with <code class="code">fabric8.</code>. For example, to set the profile name, you could add the following property to your <code class="code">pom.xml</code> file:
				</div><pre class="programlisting">&lt;project&gt;
  ...
  &lt;properties&gt;
    &lt;fabric8.profile&gt;my-foo&lt;/fabric8.profile&gt;
    ...
  &lt;/properties&gt;
  ...</pre><div class="para">
					Or you can specify properties on the command line:
				</div><pre class="programlisting">mvn fabric8:deploy -Dfabric8.profile=my-foo</pre></section><section class="simplesect" id="topic-32447"><div class="titlepage"><div><div><h3 class="title">Property reference</h3></div></div></div><div class="para">
					The Fabric8 Maven plug-in supports the following properties (which can be set either as elements inside the <code class="code">configuration</code> element in the <code class="code">pom.xml</code> file or as Maven properties, when prefixed by <code class="code">fabric8.</code>):
				</div><div class="informaltable"><table><tr>
						<th>Parameter</th> <th>Description</th>
					</tr><tr>
						<td>
							<code class="code">profile</code>
						</td>
						 <td>
							The name of the Fabric profile to deploy your project to. Defaults to the <code class="code"><em class="replaceable">groupId</em>-<em class="replaceable">artifactId</em></code> of your Maven project.
						</td>

					</tr><tr>
						<td>
							<code class="code">serverId</code>
						</td>
						 <td>
							The server ID used to lookup in <code class="code">~/.m2/settings/xml</code> for the <code class="code">server</code> element to find the username and password to log in to the fabric. Defaults to <code class="code">fabric8.upload.repo</code>.
						</td>

					</tr><tr>
						<td>
							<code class="code">jolokiaUrl</code>
						</td>
						 <td>
							The Jolokia URL of the JBoss Fuse Management Console. Defaults to <code class="code">http://localhost:8181/jolokia</code>.
						</td>

					</tr><tr>
						<td>
							<code class="code">version</code>
						</td>
						 <td>
							The Fabric version in which to update the profile. Defaults to the current version of the fabric.
						</td>

					</tr><tr>
						<td>
							<code class="code">baseVersion</code>
						</td>
						 <td>
							If the version does not exist, the <code class="code">baseVersion</code> provides the initial values for the newly created version. This is like creating a branch from the <code class="code">baseVersion</code> for a new version branch in git.
						</td>

					</tr><tr>
						<td>
							<code class="code">parentProfiles</code>
						</td>
						 <td>
							Space-separated list of parent profile IDs to be added to the newly created profile. Defaults to <code class="code">karaf</code>.
						</td>

					</tr><tr>
						<td>
							<code class="code">features</code>
						</td>
						 <td>
							Space-separated list of features to add to the profile. For example, the following setting would include both the <code class="code">camel</code> feature and the <code class="code">cxf</code> feature: <code class="code">&lt;features&gt;camel cxf&lt;/features&gt;</code>
						</td>

					</tr><tr>
						<td>
							<code class="code">featureRepos</code>
						</td>
						 <td>
							Space-separated list of feature repository URLs to add to the profile. The URL has the general form <code class="code">mvn:<em class="replaceable">groupId</em>/<em class="replaceable">artifactId</em>/<em class="replaceable">version</em>/xml/features</code>.
						</td>

					</tr><tr>
						<td>
							<code class="code">bundles</code>
						</td>
						 <td>
							Space-separated list of additional bundle URLs (of the form <code class="code">mvn:<em class="replaceable">groupId</em>/<em class="replaceable">artifactId</em>/<em class="replaceable">version</em></code>) to add to the newly created profile. Note you do not have to include the current Maven project artifact; this configuration is intended as a way to list dependent required bundles.
						</td>

					</tr><tr>
						<td>
							<code class="code">upload</code>
						</td>
						 <td>
							Whether or not the <code class="code">deploy</code> goal should upload the local builds to the fabric's Maven repository. You can disable this step if you have configured your fabric's Maven repository to reuse your local maven repository. Defaults to <code class="code">true</code>.
						</td>

					</tr><tr>
						<td>
							<code class="code">profileConfigDir</code>
						</td>
						 <td>
							The folder in your maven project containing resource files to be deployed into the profile, along with the artifact configuration. Defaults to <code class="code">src/main/fabric8</code>. You should create the directory and add any configuration files or documentation you wish to add to your profile.
						</td>

					</tr></table></div></section></section></section><section class="chapter" id="MQ"><div class="titlepage"><div><div><h2 class="title">Chapter 6. ActiveMQ Brokers and Clusters</h2></div><div><div class="abstract"><p class="title"><strong>Abstract</strong></p><div class="para">
						Fabric provides predefined profiles for deploying a simple standalone broker and, in addition, you can use the powerful <code class="code">fabric:mq-create</code> command to create and deploy clusters of brokers.
					</div></div></div></div></div><section class="section" id="MQ-Creating"><div class="titlepage"><div><div><h2 class="title">6.1. Creating a Standalone Broker Instance</h2></div></div></div><section class="simplesect" id="topic-32489"><div class="titlepage"><div><div><h3 class="title">MQ profiles</h3></div></div></div><div class="para">
					The following profiles are important for creating broker instances:
				</div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="code">mq-base</code></span></dt><dd><div class="para">
								An abstract profile, which defines some important properties and resources for the broker, but should never be used directly to instantiate a broker.
							</div></dd><dt><span class="term"><code class="code">mq-default</code></span></dt><dd><div class="para">
								A basic standalone broker, which inherits most of its properties from the <code class="code">mq-base</code> profile.
							</div></dd></dl></div><div class="para">
					To examine the properties defined in these profiles, you can invoke the <code class="code">fabric:profile-display</code> command, as follows:
				</div><pre class="programlisting">JBossFuse:karaf@root&gt; fabric:profile-display mq-default
...
JBossFuse:karaf@root&gt; fabric:profile-display mq-base
...</pre></section><section class="simplesect" id="topic-32490"><div class="titlepage"><div><div><h3 class="title">Creating a new broker instance</h3></div></div></div><div class="para">
					A Fuse MQ broker is a Karaf container instance running a message broker profile. The profile defines the broker dependencies (through features) and the configuration for the broker. The simplest approach to creating a new broker is to use the provided <code class="code">mq-default</code> profile.
				</div><div class="para">
					For example, to create a new <code class="code">mq-default</code> broker instance called <code class="code">broker1</code>, enter the following console command:
				</div><pre class="programlisting">JBossFuse:karaf@root&gt;fabric:container-create-child --profile mq-default root broker1
The following containers have been created successfully:
    broker1</pre><div class="para">
					This command creates a new container called <code class="code">broker1</code> with a broker <span class="emphasis"><em>of the same name</em></span> running on it.
				</div></section><section class="simplesect" id="topic-32491"><div class="titlepage"><div><div><h3 class="title">fabric:mq-create command</h3></div></div></div><div class="para">
					The <code class="code">fabric:mq-create</code> command provides a short cut to creating a broker, but with more flexibility, because it also creates a new profile. To create a new broker instance called <code class="code">brokerx</code> using <code class="code">fabric:mq-create</code>, enter the following console command:
				</div><pre class="programlisting">JBossFuse:karaf@root&gt; fabric:mq-create --create-container broker --replicas 1 brokerx
MQ profile mq-broker-default.brokerx ready</pre><div class="para">
					Just like the basic <code class="code">fabric:container-create-child</code> command, <code class="code">fabric:mq-create</code> creates a container called <code class="code">broker1</code> and runs a broker instance on it. There are some differences, however:
				</div><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><div class="para">
							The new <code class="code">broker1</code> container is implicitly created as a child of the current container,
						</div></li><li class="listitem"><div class="para">
							The new broker has its own profile, <code class="code">mq-broker-default.brokerx</code>, which is based on the <code class="code">mq-base</code> profile template,
						</div></li><li class="listitem"><div class="para">
							It is possible to edit the <code class="code">mq-broker-default.brokerx</code> profile, to customize the configuration of this new broker.
						</div></li><li class="listitem"><div class="para">
							The <code class="code">--replicas</code> option lets you specify the number of master/slave broker replicas (for more details, see <a class="xref" href="#MQ-Topol-MasterSlave" title="6.3.2. Master-Slave Cluster">Section 6.3.2, “Master-Slave Cluster”</a>). In this example, we specify one replica (the default is two).
						</div></li></ul></div><div class="admonition note"><div class="admonition_header">Note</div><div><div class="para">
						The new profile gets the name <code class="code">mq-broker-<em class="replaceable">Group</em>.<em class="replaceable">BrokerName</em></code> by default. If you want the profile to have the same name as the broker (which was the default in JBoss Fuse version 6.0), you can specify the profile name explicitly using the <code class="code">--profile</code> option.
					</div></div></div></section><section class="simplesect" id="MQ-Creating-Assign"><div class="titlepage"><div><div><h3 class="title">Starting a broker on an existing container</h3></div></div></div><div class="para">
					The <code class="code">fabric:mq-create</code> command can be used to deploy brokers on existing containers. Consider the following example, which creates a new Fuse MQ broker in two steps:
				</div><pre class="programlisting">JBossFuse:karaf@root&gt; fabric:container-create-child root broker1
The following containers have been created successfully:
    broker1

JBossFuse:karaf@root&gt; fabric:mq-create --assign-container broker1 brokerx
MQ profile mq-broker-default.brokerx ready</pre><div class="para">
					The preceding example firstly creates a default child container, and then creates and deploys the new <code class="code">mq-broker-default.brokerx</code> profile to the container, by invoking <code class="code">fabric:mq-create</code> with the <code class="code">--assign-container</code> option. Of course, instead of deploying to a local child container (as in this example), we could assign the broker to an SSH container or a cloud container.
				</div></section><section class="simplesect" id="topic-32493"><div class="titlepage"><div><div><h3 class="title">Broker groups</h3></div></div></div><div class="para">
					Brokers created using the <code class="code">fabric:mq-create</code> command are always registered with a specific <em class="firstterm">broker group</em>. If you do not specify the group name explicitly at the time you create the broker, the broker gets registered with the <code class="code">default</code> group by default.
				</div><div class="para">
					If you like, you can specify the group name explicitly using the <code class="code">--group</code> option of the <code class="code">fabric:mq-create</code> command. For example, to create a new broker that registers with the <code class="code">west-coast</code> group, enter the following console command:
				</div><pre class="programlisting">JBossFuse:karaf@root&gt; fabric:mq-create --create-container broker --replicas 1 --group west-coast brokery
MQ profile mq-broker-default.brokery ready</pre><div class="para">
					If the <code class="code">west-coast</code> group does not exist prior to running this command, it is automatically created by Fabric. Broker groups are important for defining clusters of brokers, providing the underlying mechanism for creating load-balancing clusters and master-slave clusters. For details, see <a class="xref" href="#MQ-Topol" title="6.3. Topologies">Section 6.3, “Topologies”</a>.
				</div></section></section><section class="section" id="MQ-Connecting"><div class="titlepage"><div><div><h2 class="title">6.2. Connecting to a Broker</h2></div></div></div><section class="simplesect" id="topic-32494"><div class="titlepage"><div><div><h3 class="title">Overview</h3></div></div></div><div class="para">
					This section describes how to connect a client to a broker. In order to connect to a JBoss MQ broker, you need to know its <em class="firstterm">group name</em>. Every MQ broker is associated with a group when it is created: if none is specified explicitly, it automatically gets associated with the <code class="code">default</code> group.
				</div></section><section class="simplesect" id="topic-32495"><div class="titlepage"><div><div><h3 class="title">Client URL</h3></div></div></div><div class="para">
					To connect to an MQ broker, the client must specify a discovery URL, in the following format:
				</div><pre class="programlisting">discovery:(fabric:<em class="replaceable">GroupName</em>)</pre><div class="para">
					For example, to connect to a broker associated with the <code class="code">default</code> group, the client would use the following URL:
				</div><pre class="programlisting">discovery:(fabric:default)</pre><div class="para">
					The connection factory then looks for available brokers in the group and connects the client to one of them.
				</div></section><section class="simplesect" id="topic-32496"><div class="titlepage"><div><div><h3 class="title">Example client profiles</h3></div></div></div><div class="para">
					You can test broker by deploying the <code class="code">example-mq</code> profile into a container. The <code class="code">example-mq</code> profile instantiates a pair of messaging clients: a <span class="emphasis"><em>producer client</em></span>, that sends messages continuously to the <code class="code">FABRIC.DEMO</code> queue on the broker; and a <span class="emphasis"><em>consumer client</em></span>, that consumes messages from the <code class="code">FABRIC.DEMO</code> queue.
				</div><div class="para">
					Create a new container with the <code class="code">example-mq</code> profile, by entering the following command:
				</div><pre class="programlisting">JBossFuse:karaf@root&gt; fabric:container-create-child --profile example-mq root example</pre><div class="para">
					You can check whether the <code class="code">example</code> container is successfully provisioned, using the following console command:
				</div><pre class="programlisting">JBossFuse:karaf@root&gt; watch container-list</pre><div class="para">
					After the example container is successfully provisioned, you can connect to it and check its log to verify the flow of messages, using the following console commands:
				</div><pre class="programlisting">JBossFuse:karaf@root&gt; container-connect example
JBossFuse:karaf@example&gt; log:display</pre></section></section><section class="section" id="MQ-Topol"><div class="titlepage"><div><div><h2 class="title">6.3. Topologies</h2></div></div></div><section class="section" id="MQ-Topol-LoadBal"><div class="titlepage"><div><div><h3 class="title">6.3.1. Load-Balancing Cluster</h3></div></div></div><section class="simplesect" id="topic-32497"><div class="titlepage"><div><div><h4 class="title">Overview</h4></div></div></div><div class="para">
						Fabric exploits the concept of broker groups to implement cluster functionality. To set up a load-balancing cluster, all of the brokers in the cluster should register with the same group name, but using <span class="emphasis"><em>unique</em></span> broker names.
					</div><div class="para">
						For example, <a class="xref" href="#MQ-Topol-LoadBal-FigLBC" title="Figure 6.1. Load-Balancing Cluster">Figure 6.1, “Load-Balancing Cluster”</a> shows a load-balancing cluster with the group name, <code class="code">loadbal</code>, and with three brokers registered in the group: <code class="code">brokerx</code>, <code class="code">brokery</code>, and <code class="code">brokerz</code>. This type of topology is ideal for load balancing non-persistent messages across brokers and for providing high-availability.
					</div><div class="figure" id="MQ-Topol-LoadBal-FigLBC"><p class="title"><strong>Figure 6.1. Load-Balancing Cluster</strong></p><div class="figure-contents"><div style="text-align: center; " class="mediaobject"><object style="width: 437; text-align: middle" type="image/svg+xml" data="images/mq_01.svg"><embed style="width: 437; " type="image/svg+xml" src="images/mq_01.svg"/></object></div></div></div></section><section class="simplesect" id="topic-32498"><div class="titlepage"><div><div><h4 class="title">Create brokers in a load-balancing cluster</h4></div></div></div><div class="para">
						The basic rules for creating a load-balancing cluster of brokers are as follows:
					</div><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><div class="para">
								Choose a group name for the load-balancing cluster.
							</div></li><li class="listitem"><div class="para">
								Each broker in the cluster registers with the chosen group.
							</div></li><li class="listitem"><div class="para">
								Each broker must be identified by a <span class="emphasis"><em>unique broker name</em></span>.
							</div></li><li class="listitem"><div class="para">
								Normally, each broker is deployed in a separate container.
							</div></li></ul></div><div class="para">
						For example, consider the cluster shown in <a class="xref" href="#MQ-Topol-LoadBal-FigLBC" title="Figure 6.1. Load-Balancing Cluster">Figure 6.1, “Load-Balancing Cluster”</a>. The group name is <code class="code">loadbal</code> and the cluster consists of three broker instances with broker names: <code class="code">brokerx</code>, <code class="code">brokery</code>, and <code class="code">brokerz</code>.
					</div><div class="para">
						To create this cluster, perform the following steps:
					</div><div class="procedure"><ol class="procedure" type="1"><li class="step"><div class="para">
								First of all create some containers:
							</div><pre class="programlisting">JBossFuse:karaf@root&gt; container-create-child root broker 3
The following containers have been created successfully:
	Container: broker1.
	Container: broker2.
	Container: broker3.</pre></li><li class="step"><div class="para">
								Wait until the containers are successfully provisioned. You can conveniently monitor them using the <code class="code">watch</code> command, as follows:
							</div><pre class="programlisting">JBossFuse:karaf@root&gt; watch container-list</pre></li><li class="step"><div class="para">
								You can then assign broker profiles to each of the containers, using the <code class="code">fabric:mq-create</code> command, as follows:
							</div><pre class="programlisting">JBossFuse:karaf@root&gt; mq-create --group loadbal --assign-container broker1 brokerx
MQ profile mq-broker-loadbal.brokerx ready

JBossFuse:karaf@root&gt; mq-create --group loadbal --assign-container broker2 brokery
MQ profile mq-broker-loadbal.brokery ready

JBossFuse:karaf@root&gt; mq-create --group loadbal --assign-container broker3 brokerz
MQ profile mq-broker-loadbal.brokerz ready</pre></li><li class="step"><div class="para">
								You can use the <code class="code">fabric:profile-list</code> command to see the new profiles created for these brokers:
							</div><pre class="programlisting">JBossFuse:karaf@root&gt; profile-list --hidden
[id]                                     [# containers] [parents]
...
mq-broker-loadbal.brokerx                1              mq-base
mq-broker-loadbal.brokery                1              mq-base
mq-client-loadbal  
...</pre></li><li class="step"><div class="para">
								You can use the <code class="code">fabric:cluster-list</code> command to view the cluster configuration for this load balancing cluster:
							</div><pre class="programlisting">JBossFuse:karaf@root&gt; cluster-list
[cluster]                      [masters]                      [slaves]                       [services]
...
fusemq/loadbal                                                                               
   brokerx                     broker1                        -                              tcp://MyLocalHost:50394
   brokery                     broker2                        -                              tcp://MyLocalHost:50604
   brokerz                     broker3                        -                              tcp://MyLocalHost:50395</pre></li></ol></div></section><section class="simplesect" id="topic-32499"><div class="titlepage"><div><div><h4 class="title">Configure clients of a load-balancing cluster</h4></div></div></div><div class="para">
						To connect a client to a load-balancing cluster, use a URL of the form, <code class="code">discovery:(fabric:<em class="replaceable">GroupName</em>)</code>, which automatically load balances the client across the available brokers in the cluster. For example, to connect a client to the <code class="code">loadbal</code> cluster, you would use a URL like the following:
					</div><pre class="programlisting">discovery:(fabric:loadbal)</pre><div class="para">
						For convenience, the <code class="code">mq-create</code> command automatically generates a profile named <code class="code">mq-client-<em class="replaceable">GroupName</em></code>, which you can combine either with the <code class="code">example-mq-consumer</code> profile or with the <code class="code">example-mq-producer</code> profile to create a client of the load-balancing cluster.
					</div><div class="para">
						For example, to create a consumer client of the <code class="code">loadbal</code> group, you can deploy the <code class="code">mq-client-loadbal</code> profile and the <code class="code">example-mq-consumer</code> profile together in a child container, by entering the following command:
					</div><pre class="programlisting">JBossFuse:karaf@root&gt; container-create-child --profile mq-client-loadbal --profile example-mq-consumer root consumer
The following containers have been created successfully:
	Container: consumer.</pre><div class="para">
						To create a producer client of the <code class="code">loadbal</code> group, you can deploy the <code class="code">mq-client-loadbal</code> profile and the <code class="code">example-mq-producer</code> profile together in a child container, by entering the following command:
					</div><pre class="programlisting">JBossFuse:karaf@root&gt; container-create-child --profile mq-client-loadbal --profile example-mq-producer root producer
The following containers have been created successfully:
	Container: producer.</pre><div class="para">
						To verify that the clients are functioning correctly, you can connect to one of them and check the log. For example, to check the log of the consumer client:
					</div><pre class="programlisting">JBossFuse:karaf@root&gt; container-connect consumer

JBossFuse:admin@consumer&gt; log:display
2014-01-16 14:31:41,776 | INFO  | Thread-42        | ConsumerThread                   | io.fabric8.mq.ConsumerThread   54 | 110 - org.jboss.amq.mq-client - 6.1.0.redhat-312 | Received test message: 982
2014-01-16 14:31:41,777 | INFO  | Thread-42        | ConsumerThread                   | io.fabric8.mq.ConsumerThread   54 | 110 - org.jboss.amq.mq-client - 6.1.0.redhat-312 | Received test message: 983</pre></section></section><section class="section" id="MQ-Topol-MasterSlave"><div class="titlepage"><div><div><h3 class="title">6.3.2. Master-Slave Cluster</h3></div></div></div><section class="simplesect" id="topic-32500"><div class="titlepage"><div><div><h4 class="title">Overview</h4></div></div></div><div class="para">
						In the master-slave pattern, multiple peer brokers provide the same service and all compete to be the master. Only <span class="emphasis"><em>one</em></span> master can exist at a given time, while the rest remain on standby as slaves. If the master stops, the remaining brokers (slaves) compete to become the new master. If the broker containers are deployed across different machines or data centres, the result is a highly available broker.
					</div><div class="para">
						For example, <a class="xref" href="#MQ-Topol-MasterSlave-FigMSC" title="Figure 6.2. Master-Slave Cluster">Figure 6.2, “Master-Slave Cluster”</a> shows a master-slave cluster with the group name, <code class="code">masterslave</code>, and three brokers that compete with each other to register as the broker, <code class="code">hq-broker</code>. A broker becomes the master by acquiring a lock (where the lock implementation is provided by the underlying ZooKeeper registry). The other two brokers that fail to acquire the lock remain as slaves (but they continue trying to acquire the lock, at regular time intervals).
					</div><div class="figure" id="MQ-Topol-MasterSlave-FigMSC"><p class="title"><strong>Figure 6.2. Master-Slave Cluster</strong></p><div class="figure-contents"><div style="text-align: center; " class="mediaobject"><object style="width: 466; text-align: middle" type="image/svg+xml" data="images/mq_02.svg"><embed style="width: 466; " type="image/svg+xml" src="images/mq_02.svg"/></object></div></div></div></section><section class="simplesect" id="topic-32501"><div class="titlepage"><div><div><h4 class="title">Create brokers in a master-slave cluster</h4></div></div></div><div class="para">
						The basic rules for creating a master-slave cluster of brokers are as follows:
					</div><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><div class="para">
								Choose a group name for the master-slave cluster.
							</div></li><li class="listitem"><div class="para">
								Each broker in the cluster registers with the chosen group.
							</div></li><li class="listitem"><div class="para">
								Each broker must be identified by the <span class="emphasis"><em>same</em></span> virtual broker name.
							</div></li><li class="listitem"><div class="para">
								Normally, each broker is deployed in a separate container.
							</div></li></ul></div><div class="para">
						For example, consider the cluster shown in <a class="xref" href="#MQ-Topol-MasterSlave-FigMSC" title="Figure 6.2. Master-Slave Cluster">Figure 6.2, “Master-Slave Cluster”</a>. The group name is <code class="code">masterslave</code> and the cluster consists of three broker instances, each with the <span class="emphasis"><em>same</em></span> broker name: <code class="code">hq-broker</code>. You can create this cluster by entering a single <code class="code">fabric:mq-create</code> command, as follows:
					</div><pre class="programlisting">JBossFuse:karaf@root&gt; mq-create --create-container broker --replicas 3 --group masterslave hq-broker</pre><div class="para">
						Alternatively, if you have already created three containers, <code class="code">broker1</code>, <code class="code">broker2</code> and <code class="code">broker3</code> (possibly running on separate machines), you can deploy a cluster of three brokers to the containers by entering the following command:
					</div><pre class="programlisting">JBossFuse:karaf@root&gt; mq-create --assign-container broker1,broker2,broker3 --group masterslave hq-broker</pre><div class="para">
						The first broker that starts becomes the master, while the others are slaves. When you stop the master, one of the slaves will take over and clients will reconnect. If brokers are persistent, you need to ensure that they all use the same store—for details of how to configure this, see <a class="xref" href="#MQ-Topol-MasterSlave-Persistent" title="Configuring persistent data">the section called “Configuring persistent data”</a>.
					</div></section><section class="simplesect" id="topic-32502"><div class="titlepage"><div><div><h4 class="title">Configure clients of a master-slave cluster</h4></div></div></div><div class="para">
						To connect a client to a master-slave cluster, use a URL of the form, <code class="code">discovery:(fabric:<em class="replaceable">GroupName</em>)</code>, which automatically connects the client to the current master server. For example, to connect a client to the <code class="code">masterslave</code> cluster, you would use a URL like the following:
					</div><pre class="programlisting">discovery:(fabric:masterslave)</pre><div class="para">
						You can use the automatically generated client profile, <code class="code">mq-client-masterslave</code>, to create sample clients. For example, to create an example consumer client in its own container, enter the following console command:
					</div><pre class="programlisting">JBossFuse:karaf@root&gt; container-create-child --profile mq-client-masterslave --profile example-mq-consumer root consumer
The following containers have been created successfully:
	Container: consumer.</pre><div class="para">
						And to create an example producer client in its own container, enter the following console command:
					</div><pre class="programlisting">JBossFuse:karaf@root&gt; container-create-child --profile mq-client-masterslave --profile example-mq-producer root producer
The following containers have been created successfully:
	Container: producer.</pre></section><section class="simplesect" id="topic-32503"><div class="titlepage"><div><div><h4 class="title">Locking mechanism</h4></div></div></div><div class="para">
						One benefit of this kind of master-slave architecture is that it does not depend on shared storage for locking, so it can be used even with non-persistent brokers. The broker group uses ZooKeeper to manage a shared distributed lock that controls ownership of the master status.
					</div></section><section class="simplesect" id="topic-32504"><div class="titlepage"><div><div><h4 class="title">Re-using containers for multiple clusters</h4></div></div></div><div class="para">
						Fabric supports re-using the same containers for multiple master-slave clusters, which is a convenient way to economize on hardware resources. For example, given the three containers, <code class="code">broker1</code>, <code class="code">broker2</code>, and <code class="code">broker3</code>, already running the <code class="code">hq-broker</code> cluster, it is possible to reuse the <span class="emphasis"><em>same</em></span> containers for another highly available broker cluster, <code class="code">web-broker</code>. You can assign the <code class="code">web-broker</code> profile to the existing containers with the following command:
					</div><pre class="programlisting">mq-create --assign-container broker1,broker2,broker3 web-broker</pre><div class="para">
						This command assigns the new <code class="code">web-broker</code> profile to the same containers already running <code class="code">hq-broker</code>. Fabric automatically prevents two masters from running on the same container, so the master for <code class="code">hq-broker</code> will run on a different container from the master for <code class="code">web-broker</code>. This arrangement makes optimal use of the available resources.
					</div></section><section class="simplesect" id="MQ-Topol-MasterSlave-Persistent"><div class="titlepage"><div><div><h4 class="title">Configuring persistent data</h4></div></div></div><div class="para">
						When you run a master-slave configuration with persistent brokers, it is important to specify where your store is located, because you need to be able to access it from multiple hosts. To support this scenario, the <code class="code">fabric:mq-create</code> command enables you to specify the location of the data directory, as follows:
					</div><pre class="programlisting">mq-create --assign-container broker1 --data /var/activemq/hq-broker hq-broker</pre><div class="para">
						The preceding command creates the <code class="code">hq-broker</code> virtual broker, which uses the <code class="code">/var/activemq/hq-broker</code> directory for the data (and store) location. You can then mount some shared storage to this path and share the storage amongst the brokers in the master-slave cluster.
					</div></section></section><section class="section" id="MQ-Topol-BrokerNetworks"><div class="titlepage"><div><div><h3 class="title">6.3.3. Broker Networks</h3></div></div></div><section class="simplesect" id="topic-32506"><div class="titlepage"><div><div><h4 class="title">Overview</h4></div></div></div><div class="para">
						It is possible to combine broker clusters with broker networks, giving you a hybrid broker network that combines the benefits of broker clusters (for example, high availability) with the benefits of broker networks (managing the flow of messages between different geographical sites).
					</div></section><section class="simplesect" id="topic-32507"><div class="titlepage"><div><div><h4 class="title">Broker networks</h4></div></div></div><div class="para">
						A <em class="firstterm">broker network</em> in JBoss Fuse is a form of federation where brokers are linked together using <em class="firstterm">network connectors</em>. This can be used as a way of forwarding messages between different geographical locations. Messages can be forwarded either <span class="emphasis"><em>statically</em></span> (where specified categories of messages are always forwarded to a specific broker), or <span class="emphasis"><em>dynamically</em></span> (where messages are forwarded only in response to a client that connects to a broker and subscribes to particular queues or topics).
					</div></section><section class="simplesect" id="topic-32508"><div class="titlepage"><div><div><h4 class="title">Creating network connectors</h4></div></div></div><div class="para">
						In the context of Fabric, network connectors can be created by passing the <code class="code">--network</code> option to the <code class="code">fabric:mq-create</code> command.
					</div></section><section class="simplesect" id="topic-32509"><div class="titlepage"><div><div><h4 class="title">Example broker network</h4></div></div></div><div class="para">
						Consider the scenario shown in <a class="xref" href="#MQ-Topol-BrokerNetworks-FigNT" title="Figure 6.3. Broker Network with Master-Slave Clusters">Figure 6.3, “Broker Network with Master-Slave Clusters”</a>.
					</div><div class="figure" id="MQ-Topol-BrokerNetworks-FigNT"><p class="title"><strong>Figure 6.3. Broker Network with Master-Slave Clusters</strong></p><div class="figure-contents"><div style="text-align: center; " class="mediaobject"><object style="width: 672; text-align: middle" type="image/svg+xml" data="images/mq_03.svg"><embed style="width: 672; " type="image/svg+xml" src="images/mq_03.svg"/></object></div></div></div><div class="para">
						The figure shows two master-slave clusters:
					</div><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><div class="para">
								The first cluster has the group name, <code class="code">us-west</code>, and provides high-availability with a master-slave cluster of two brokers, <code class="code">us-west1</code> and <code class="code">us-west2</code>.
							</div></li><li class="listitem"><div class="para">
								The second cluster has the group name, <code class="code">us-east</code>, and provides high-availability with a master-slave cluster of two brokers, <code class="code">us-east1</code> and <code class="code">us-east2</code>.
							</div></li></ul></div><div class="para">
						Network connectors link the master brokers between each of the geographical locations (there are, in fact, two network connectors in this topology: from west to east and from east to west).
					</div><div class="para">
						To create the pair of master-slave brokers for the <code class="code">us-east</code> group (consisting of the two containers <code class="code">us-east1</code> and <code class="code">us-east2</code>), you would log on to a root container running in the US East location and enter a command like the following:
					</div><pre class="programlisting">mq-create --group us-east --network us-west --networks-username <em class="replaceable">User</em> --networks-password <em class="replaceable">Pass</em> --create-container us-east us-east</pre><div class="para">
						Where the <code class="code">--network</code> option specifies the name of the broker group you want to connect to, and the <code class="code"><em class="replaceable">User</em></code> and <code class="code"><em class="replaceable">Pass</em></code> are the credentials required to log on to the <code class="code">us-west</code> broker cluster. By default, the <code class="code">fabric:mq-create</code> command creates a master/slave pair of brokers.
					</div><div class="para">
						And to create the pair of master-slave brokers for the <code class="code">us-west</code> group (consisting of the two containers <code class="code">us-west1</code> and <code class="code">us-west2</code>), you would log on to a root container running in the US West location and enter a command like the following:
					</div><pre class="programlisting">mq-create --group us-west --network us-east --networks-username <em class="replaceable">User</em> --networks-password <em class="replaceable">Pass</em> --create-container us-west us-west</pre><div class="para">
						Where <code class="code"><em class="replaceable">User</em></code> and <code class="code"><em class="replaceable">Pass</em></code> are the credentials required to log on to the <code class="code">us-east</code> broker cluster.
					</div><div class="admonition note"><div class="admonition_header">Note</div><div><div class="para">
							In a real scenario, you would probably first create the containers on separate machines and then assign brokers to the containers, using the <code class="code">--assign-container</code> option in place of <code class="code">--create-container</code>.
						</div></div></div></section><section class="simplesect" id="topic-32510"><div class="titlepage"><div><div><h4 class="title">Connecting to the example broker network</h4></div></div></div><div class="para">
						At the US East location, any clients that need to connect to the broker network should use the following client URL:
					</div><pre class="programlisting">discovery:(fabric:us-east)</pre><div class="para">
						And at the US West location, any clients that need to connect to the broker network should use the following client URL:
					</div><pre class="programlisting">discovery:(fabric:us-west)</pre><div class="para">
						Any messages that need to be propagated between locations, from US East to US West (or from US West to US East), are transmitted over the broker network through one of the network connectors.
					</div></section></section></section><section class="section" id="MQ-BrokerConfig"><div class="titlepage"><div><div><h2 class="title">6.4. Broker Configuration</h2></div></div></div><section class="simplesect" id="topic-32511"><div class="titlepage"><div><div><h3 class="title">Overview</h3></div></div></div><div class="para">
					The examples presented so far have demonstrated how to create brokers with default configuration settings. In practice, you will usually need to customize the broker configurations and this can be done by editing the properties of the corresponding Fabric profiles.
				</div></section><section class="simplesect" id="topic-32512"><div class="titlepage"><div><div><h3 class="title">Setting OSGi Config Admin properties</h3></div></div></div><div class="para">
					Many of the broker configuration settings can be altered by editing OSGi Config Admin properties (which are organized into collections identified by a <em class="firstterm">persistent ID</em> or PID). For example, consider the <code class="code">broker1</code> profile created by entering the following <code class="code">fabric:mq-create</code> command:
				</div><pre class="programlisting">fabric:mq-create --create-container broker --replicas 1 --network us-west brokerx</pre><div class="para">
					The preceding command creates the new profile, <code class="code">mq-broker-default.brokerx</code>, and assigns this profile to the newly created <code class="code">broker1</code> container.
				</div><div class="admonition note"><div class="admonition_header">Note</div><div><div class="para">
						The new profile gets the name <code class="code">mq-broker-<em class="replaceable">Group</em>.<em class="replaceable">BrokerName</em></code> by default. If you want the profile to have the same name as the broker (which was the default in JBoss Fuse version 6.0), you can specify the profile name explicitly using the <code class="code">--profile</code> option.
					</div></div></div><div class="para">
					You can inspect the details of the <code class="code">mq-broker-default.brokerx</code> profile using the <code class="code">fabric:profile-display</code> command, as follows:
				</div><pre class="programlisting">JBossFuse:karaf@root&gt; profile-display mq-broker-default.brokerx
    Profile id: broker1
    Version   : 1.0
    Parents   : mq-base
    Associated Containers :

    Container settings
    ----------------------------

    Configuration details
    ----------------------------
    PID: io.fabric8.mq.fabric.server-brokerx
    standby.pool default
    connectors openwire
    broker-name broker1
    data /opt/fuse-fabric/data/broker1
    config profile:broker.xml
    group default
    network us-west</pre><div class="para">
					Associated with the <code class="code">io.fabric8.mq.fabric.server-brokerx</code> PID are a variety of property settings, such as <code class="code">network</code> and <code class="code">group</code>. You can now add more properties to this PID to customize the broker configuration.
				</div></section><section class="simplesect" id="topic-32513"><div class="titlepage"><div><div><h3 class="title">Setting network connector properties</h3></div></div></div><div class="para">
					You can specify additional configuration for network connectors, where the property names have the form <code class="code">network.<em class="replaceable">NetworkPropName</em></code>. For example, to add the setting, <code class="code">network.bridgeTempDestinations=false</code>, to the PID for <code class="code">brokerx</code>, enter the following console command:
				</div><pre class="programlisting">profile-edit --pid io.fabric8.mq.fabric.server-brokerx/network.bridgeTempDestinations=false brokerx</pre><div class="para">
					The deployed broker dynamically detects the change to this property and updates the network connector on the fly.
				</div></section><section class="simplesect" id="topic-32514"><div class="titlepage"><div><div><h3 class="title">Network connector properties by reflection</h3></div></div></div><div class="para">
					Fabric uses reflection to set network connector properties. That is, any PID property of the form <code class="code">network.<em class="replaceable">OptionName</em></code> can be used to set the corresponding <code class="code"><em class="replaceable">OptionName</em></code> property on the <code class="code">org.apache.activemq.network.NetworkBridgeConfiguration</code> class. In particular, this implies you can set any of the following <code class="code">network.<em class="replaceable">OptionName</em></code> properties:
				</div><div class="informaltable"><table class="lt-4-cols lt-7-rows"><colgroup><col style="width: 33%; " class="c1"/><col style="width: 33%; " class="c2"/><col style="width: 33%; " class="c3"/></colgroup><thead><tr><th>Property</th><th>Default</th><th>Description</th></tr></thead><tbody><tr><td><code class="code">name</code></td><td><code class="code">bridge</code> </td><td>Name of the network - for more than one network connector between the same two brokers, use different names</td></tr><tr><td><code class="code">userName</code></td><td><span class="emphasis"><em>None</em></span></td><td>Username for logging on to the remote broker port, if authentication is enabled.</td></tr><tr><td><code class="code">password</code></td><td><span class="emphasis"><em>None</em></span></td><td>Password for logging on to the remote broker port, if authentication is enabled.</td></tr><tr><td><code class="code">dynamicOnly</code></td><td><code class="code">false</code> </td><td>If <code class="code">true</code>, only activate a networked durable subscription when a corresponding durable subscription reactivates, by default they are activated on start-up.</td></tr><tr><td><code class="code">dispatchAsync</code></td><td><code class="code">true</code></td><td>Determines how the network bridge sends messages to the local broker. If <code class="code">true</code>, the network bridge sends messages asynchronously.</td></tr><tr><td><code class="code">decreaseNetworkConsumerPriority</code> </td><td><code class="code">false</code> </td><td>If <code class="code">true</code>, starting at priority <code class="code">-5</code>, decrease the priority for dispatching to a network Queue consumer the further away it is (in network hops) from the producer. If <code class="code">false</code>, all network consumers use same default priority (that is, <code class="code">0</code>) as local consumers.</td></tr><tr><td><code class="code">consumerPriorityBase</code></td><td><code class="code">-5</code></td><td>Sets the starting priority for consumers. This base value will be decremented by the length of the broker path when <code class="code">decreaseNetworkConsumerPriority</code> is set.</td></tr><tr><td><code class="code">networkTTL</code> </td><td><code class="code">1</code> </td><td>The number of brokers in the network that messages and subscriptions can pass through (sets both <code class="code">messageTTL</code> and <code class="code">consumerTTL</code>)</td></tr><tr><td><code class="code">messageTTL</code> </td><td><code class="code">1</code> </td><td>The number of brokers in the network that messages can pass through.</td></tr><tr><td><code class="code">consumerTTL</code> </td><td><code class="code">1</code> </td><td>The number of brokers in the network that subscriptions can pass through (keep to 1 in a mesh).</td></tr><tr><td><code class="code">conduitSubscriptions</code> </td><td><code class="code">true</code> </td><td>Multiple consumers subscribing to the same destination are treated as one consumer by the network.</td></tr><tr><td><code class="code">duplex</code> </td><td><code class="code">false</code> </td><td>If <code class="code">true</code>, a network connection is used both to produce <span class="emphasis"><em>and</em></span> to consume messages. This is useful for hub and spoke scenarios, when the hub is behind a firewall, and so on.</td></tr><tr><td><code class="code">prefetchSize</code> </td><td><code class="code">1000</code></td><td>Sets the prefetch size on the network connector's consumer. It must be greater than <code class="code">0</code>, because network consumers do not poll for messages</td></tr><tr><td><code class="code">suppressDuplicateQueueSubscriptions</code></td><td><code class="code">false</code></td><td>If <code class="code">true</code>, duplicate subscriptions in the network that arise from network intermediaries are suppressed. For example, consider brokers <code class="code">A</code>, <code class="code">B</code>, and <code class="code">C</code>, networked using multicast discovery. A consumer on <code class="code">A</code> gives rise to a networked consumer on <code class="code">B</code> and <code class="code">C</code>. In addition, <code class="code">C</code> networks to <code class="code">B</code> (based on the network consumer from <code class="code">A</code>) and <code class="code">B</code> networks to <code class="code">C</code>. When <code class="code">true</code>, the network bridges between <code class="code">C</code> and <code class="code">B</code> (being duplicates of their existing network subscriptions to <code class="code">A</code>) will be suppressed. Reducing the routing choices in this way provides determinism when producers or consumers migrate across the network as the potential for dead routes (stuck messages) are eliminated. The <code class="code">networkTTL</code> value needs to match or exceed the broker count to require this intervention.</td></tr><tr><td><code class="code">suppressDuplicateTopicSubscriptions</code></td><td><code class="code">true</code></td><td>If <code class="code">true</code>, duplicate network topic subscriptions (in a cyclic network) are suppressed.</td></tr><tr><td><code class="code">bridgeTempDestinations</code> </td><td><code class="code">true</code> </td><td> <div class="para">
									Whether to broadcast advisory messages for temporary destinations created in the network of brokers. Temporary destinations are typically created for request-reply messages. Broadcasting the information about temp destinations is turned on by default, so that consumers of a request-reply message can be connected to another broker in the network and still send back the reply on the temporary destination specified in the <code class="code">JMSReplyTo</code> header. In an application scenario where most or all of the messages use the request-reply pattern, this generates additional traffic on the broker network, because every message typically sets a unique <code class="code">JMSReplyTo</code> address (which causes a new temp destination to be created and broadcasted with an advisory message in the network of brokers).
								</div>
								 <div class="para">
									If you disable this feature, this network traffic can be reduced, but in this case the producers and consumers of a request-reply message need to be connected to the same broker. Remote consumers (that is, connected through another broker in your network) will not be able to send the reply message, but instead will raise a <code class="code">temp destination does not exist</code> exception.
								</div>
								 </td></tr><tr><td><code class="code">alwaysSyncSend</code> </td><td><code class="code">false</code> </td><td>If <code class="code">true</code>, non-persistent messages are sent to the remote broker using request/reply semantics instead of oneway message semantics. This setting affects both persistent and non-persistent messages the same way.</td></tr><tr><td><code class="code">staticBridge</code></td><td><code class="code">false</code> </td><td>If <code class="code">true</code>, the broker does not respond dynamically to new consumers. It uses only <code class="code">staticallyIncludedDestinations</code> to create demand subscriptions.</td></tr><tr><td><code class="code">useCompression</code></td><td><code class="code">false</code></td><td>Compresses the message body when sending it over the network.</td></tr><tr><td><code class="code">advisoryForFailedForward</code></td><td><code class="code">false</code></td><td>If <code class="code">true</code>, send an advisory message when the broker fails to forward the message to the temporary destination across the bridge.</td></tr><tr><td><code class="code">useBrokerNamesAsIdSeed</code></td><td><code class="code">true</code></td><td>Add the broker name as a prefix to connections and consumers created by the network bridge. It helps with visibility.</td></tr><tr><td><code class="code">gcDestinationViews</code></td><td><code class="code">true</code></td><td>If <code class="code">true</code>, remove any MBeans for destinations that have not been used for a while.</td></tr><tr><td><code class="code">gcSweepTime</code></td><td><code class="code">60000</code></td><td>The period of inactivity in milliseconds, after which we remove MBeans.</td></tr><tr><td><code class="code">checkDuplicateMessagesOnDuplex</code></td><td><code class="code">false</code></td><td>If <code class="code">true</code>, check for duplicates on the duplex connection. </td></tr></tbody></table></div></section><section class="simplesect" id="topic-32515"><div class="titlepage"><div><div><h3 class="title">Broker configuration file</h3></div></div></div><div class="para">
					Another important aspect of broker configuration is the ActiveMQ broker configuration file, which is specified as a Spring XML file. In the context of Fabric, this file is stored as a resource in the ZooKeeper registry in the <code class="code">mq-base</code> profile. That is, in the ZooKeeper registry, the <code class="code">broker.xml</code> file is stored in the following location:
				</div><pre class="programlisting">/fabric/configs/versions/1.0/profiles/mq-base/broker.xml</pre><div class="para">
					This file has the following default contents:
				</div><pre class="programlisting">    &lt;beans
      xmlns="http://www.springframework.org/schema/beans"
      xmlns:amq="http://activemq.apache.org/schema/core"
      xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
      xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd
      http://activemq.apache.org/schema/core http://activemq.apache.org/schema/core/activemq-core.xsd"&gt;

        &lt;!-- Allows us to use system properties and fabric as variables in this configuration file --&gt;
        &lt;bean class="org.springframework.beans.factory.config.PropertyPlaceholderConfigurer"&gt;
            &lt;property name="properties"&gt;
                &lt;bean class="io.fabric8.mq.fabric.ConfigurationProperties"/&gt;
            &lt;/property&gt;
        &lt;/bean&gt;

        &lt;broker xmlns="http://activemq.apache.org/schema/core" brokerName="${broker-name}" dataDirectory="${data}" start="false"&gt;

            &lt;destinationPolicy&gt;
                &lt;policyMap&gt;
                  &lt;policyEntries&gt;
                    &lt;policyEntry topic="&gt;" producerFlowControl="true" memoryLimit="1mb"&gt;
                      &lt;pendingSubscriberPolicy&gt;
                        &lt;vmCursor /&gt;
                      &lt;/pendingSubscriberPolicy&gt;
                    &lt;/policyEntry&gt;
                    &lt;policyEntry queue="&gt;" producerFlowControl="true" memoryLimit="1mb"&gt;
                    &lt;/policyEntry&gt;
                  &lt;/policyEntries&gt;
                &lt;/policyMap&gt;
            &lt;/destinationPolicy&gt;

            &lt;managementContext&gt;
                &lt;managementContext createConnector="false"/&gt;
            &lt;/managementContext&gt;

            &lt;persistenceAdapter&gt;
                &lt;kahaDB directory="${data}/kahadb"/&gt;
            &lt;/persistenceAdapter&gt;

            &lt;transportConnectors&gt;
                &lt;transportConnector name="openwire" uri="tcp://0.0.0.0:0"/&gt;
            &lt;/transportConnectors&gt;
        &lt;/broker&gt;

    &lt;/beans&gt;</pre><div class="para">
					Note that some of the PID properties from the profile are substituted into this template (for example, <code class="code">broker-name</code> and <code class="code">data</code>) and it's important that you reuse them properly. The easiest way to edit this configuration is to use the Fuse Management Console (see <a class="link" href="https://access.redhat.com/documentation/en-US/Red_Hat_JBoss_Fuse/6.2/html/Management_Console_User_Guide/index.html">"Management Console User Guide"</a>) or the built-in profile text editor (see <a class="xref" href="#ProfileEdit" title="Appendix A. Editing Profiles with the Built-In Text Editor">Appendix A, <em>Editing Profiles with the Built-In Text Editor</em></a>).
				</div></section><section class="simplesect" id="topic-32516"><div class="titlepage"><div><div><h3 class="title">Additional broker configuration files</h3></div></div></div><div class="para">
					If you like, you can create additional broker configuration files in the <code class="code">mq-base</code> profile, for example:
				</div><pre class="programlisting">/fabric/configs/versions/1.0/profiles/mq-base/mybroker.xml</pre><div class="para">
					You can then use this custom <code class="code">mybroker.xml</code> configuration by invoking the <code class="code">fabric:mq-create</code> command with the <code class="code">--config</code> option, as follows:
				</div><pre class="programlisting">fabric:mq-create --config mybroker.xml brokerx</pre><div class="para">
					The <code class="code">--config</code> option assumes that the configuration file is stored in the current version of the <code class="code">mq-base</code> profile, so you need to specify only the file name (that is, the full ZooKeeper path is not required).
				</div></section></section></section></div><div class="part" id="PartProd"><div class="titlepage"><div><div><h1 class="title">Part II. Fabric in Production</h1></div><div><div class="abstract"><p class="title"><strong>Abstract</strong></p><div class="para">
					Deepen your understanding and understand the principles of running Fabric in a production environment.
				</div></div></div></div></div><div class="toc"><p><strong>Table of Contents</strong></p><ul class="toc"><li><span class="chapter"><a href="#Ensemble">7. Fabric Ensemble and Registry</a></span><ul><li><span class="section"><a href="#Ensemble-Registry">7.1. Fabric Registry</a></span></li><li><span class="section"><a href="#Ensemble-Admin">7.2. Administering a Fabric Ensemble</a></span></li></ul></li><li><span class="chapter"><a href="#Agents">8. Fabric Agents</a></span><ul><li><span class="section"><a href="#Agents-Intro">8.1. Introduction</a></span></li><li><span class="section"><a href="#Agents-ConfigAdmin">8.2. The Configuration Admin Bridge</a></span></li><li><span class="section"><a href="#Agents-Deploy">8.3. The Deployment Agent</a></span></li></ul></li><li><span class="chapter"><a href="#Ports">9. Allocating Ports</a></span><ul><li><span class="section"><a href="#Ports-Service">9.1. The Port Service</a></span></li><li><span class="section"><a href="#Ports-Using">9.2. Using the Port Service</a></span></li></ul></li><li><span class="chapter"><a href="#Gateway">10. Gateway</a></span><ul><li><span class="section"><a href="#Gateway-Arch">10.1. Gateway Architecture</a></span></li><li><span class="section"><a href="#Gateway-Running">10.2. Running the Gateway</a></span></li><li><span class="section"><a href="#Gateway-Config">10.3. Configuring the Gateway</a></span></li><li><span class="section"><a href="#Gateway-Version">10.4. Versioning</a></span></li><li><span class="section"><a href="#Gateway-URITempl">10.5. URI Template Expressions</a></span></li></ul></li><li><span class="chapter"><a href="#FMCManageAuthentication">11. Securing Fabric Containers</a></span></li><li><span class="chapter"><a href="#FESBFabricMavenProxyConfig">12. Configuring a Fabric's Maven Proxy</a></span></li><li><span class="chapter"><a href="#Offline">13. Offline Repositories</a></span><ul><li><span class="section"><a href="#Offline-Profile">13.1. Offline Repository for a Profile</a></span></li><li><span class="section"><a href="#Offline-Version">13.2. Offline Repository for a Version</a></span></li><li><span class="section"><a href="#Offline-Maven">13.3. Offline Repository for a Maven Project</a></span></li></ul></li><li><span class="chapter"><a href="#Git">14. Configuring with Git</a></span><ul><li><span class="section"><a href="#Git-HowItWorks">14.1. How Git Works inside Fabric</a></span></li><li><span class="section"><a href="#Git-Cluster">14.2. Using a Git Cluster</a></span></li><li><span class="section"><a href="#Git-Proxy">14.3. Using a Git HTTP Proxy</a></span></li><li><span class="section"><a href="#Git-External">14.4. Using an External Git Repository</a></span></li><li><span class="section"><a href="#Git_HTTP-proxy">14.5. Using an HTTP Proxy with a Git Cluster</a></span></li></ul></li><li><span class="chapter"><a href="#Patching">15. Patching</a></span><ul><li><span class="section"><a href="#ESBRuntimePatchFabric">15.1. Patching a Container in a Fabric</a></span></li></ul></li></ul></div><section class="chapter" id="Ensemble"><div class="titlepage"><div><div><h2 class="title">Chapter 7. Fabric Ensemble and Registry</h2></div><div><div class="abstract"><p class="title"><strong>Abstract</strong></p><div class="para">
						The Fabric ensemble and registry is a critical part of the Fabric infrastructure. In a production environment, it is particularly important to understand the correct approach to creating and maintaining a Fabric ensemble.
					</div></div></div></div></div><section class="section" id="Ensemble-Registry"><div class="titlepage"><div><div><h2 class="title">7.1. Fabric Registry</h2></div></div></div><section class="simplesect" id="topic-32407"><div class="titlepage"><div><div><h3 class="title">Overview</h3></div></div></div><div class="para">
					Fuse Fabric uses <a class="link" href="http://zookeeper.apache.org/">Apache ZooKeeper</a> (a highly reliable distributed coordination service) as its registry for storing cluster configuration and node registration.
				</div><div class="para">
					ZooKeeper is designed with consistency and high availability in mind, while protecting against network splits, using the concept of a server quorum. For example, you might run five ZooKeeper servers and, so long as you have a quorum (three or more servers available), the ZooKeeper cluster is reliable and not in a network split.
				</div></section><section class="simplesect" id="topic-32408"><div class="titlepage"><div><div><h3 class="title">Registry structure</h3></div></div></div><div class="para">
					The structure of the registry is a tree-like structure, similar to a filesystem. Each node of the tree (a <em class="firstterm">znode</em>) can hold data and can have children.
				</div><div class="para">
					For example, the following shows an outline of the registry structure:
				</div><div class="informalexample"><pre class="programlisting">        fabric
            |
            +----registry (runtime registry)
            |        |
            |        +----containers
            |                 |
            |                 +----root
            |
            +----configs (configuration registry)
                     |
                     +----versions
                     |        |
                     |        +----1.0
                     |               |
                     |               +----profiles
                     |                        |
                     |                        +----default
                     |
                     +----containers</pre></div></section><section class="simplesect" id="topic-32409"><div class="titlepage"><div><div><h3 class="title">Parts of the registry</h3></div></div></div><div class="para">
					Conceptually, the Fabric registry consists of two main parts:
				</div><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><div class="para">
							<span class="emphasis"><em>Configuration Registry</em></span>—the logical configuration of your fabric, which typically contains no physical machine information. It contains details of the applications to be deployed and their dependencies.
						</div></li><li class="listitem"><div class="para">
							<span class="emphasis"><em>Runtime Registry</em></span>—contains details of how many machines are actually running, their physical location, and what services they are implementing.
						</div></li></ul></div></section><section class="simplesect" id="topic-32410"><div class="titlepage"><div><div><h3 class="title">Making the registry highly available</h3></div></div></div><div class="para">
					With a single container hosting the registry, high availability is not supported. In order to have a highly available Fabric registry, you need to replicate the registry on multiple containers (on different physical hosts). The common term used to describe a group of servers that replicate the Fabric registry is an <em class="firstterm">ensemble</em>.
				</div></section></section><section class="section" id="Ensemble-Admin"><div class="titlepage"><div><div><h2 class="title">7.2. Administering a Fabric Ensemble</h2></div></div></div><section class="simplesect" id="topic-32411"><div class="titlepage"><div><div><h3 class="title">Recommendations for an ensemble in production</h3></div></div></div><div class="para">
					To assure high availability of the Fabric registry in a production environment, it is recommended that you observe the following guidelines for a Fabric ensemble:
				</div><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><div class="para">
							Deploy a minimum of five Fabric servers in production (if one server is taken down for maintenance, one other server can fail, and the Fabric registry will still be available).
						</div></li><li class="listitem"><div class="para">
							Fabric servers should be deployed on separate host machines.
						</div></li><li class="listitem"><div class="para">
							Each Fabric server should only have a Fabric registry agent deployed inside it. No other profiles should be deployed in it.
						</div></li><li class="listitem"><div class="para">
							The size of the ensemble should be fixed at the outset, and not changed later (if you subsequently add or remove containers from the ensemble, the ZooKeeper IP ports would be re-assigned).
						</div></li></ul></div></section><section class="simplesect" id="topic-32412"><div class="titlepage"><div><div><h3 class="title">Creating an ensemble</h3></div></div></div><div class="para">
					A Fabric ensemble is created in two stages, as follows:
				</div><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><div class="para">
							Create an initial ensemble, consisting of one Fabric server.
						</div></li><li class="listitem"><div class="para">
							Expand the ensemble, by adding an even number of containers.
						</div></li></ol></div></section><section class="simplesect" id="topic-32413"><div class="titlepage"><div><div><h3 class="title">Creating an initial ensemble</h3></div></div></div><div class="para">
					An initial ensemble is usually created by invoking the <code class="code">fabric:create</code> console command (which converts the current container into a Fabric server, which is a sole member of the newly created ensemble). Alternatively, when creating a new container with the <code class="code">fabric:container-create-ssh</code> or <code class="code">fabric:container-create-cloud</code> commands, you can pass the <code class="code">--ensemble-server</code> option.
				</div><div class="para">
					For details of how to create an initial ensemble using the <code class="code">fabric:create</code> command, see <a class="xref" href="#ESBRuntimeFabricCreate" title="Chapter 2. Creating a New Fabric">Chapter 2, <em>Creating a New Fabric</em></a>.
				</div></section><section class="simplesect" id="topic-32414"><div class="titlepage"><div><div><h3 class="title">Expanding the ensemble</h3></div></div></div><div class="para">
					Once you have an initial ensemble, consisting of one Fabric server, you can expand the ensemble by invoking the <code class="code">fabric:ensemble-add</code> command. To expand the ensemble, perform the following steps:
				</div><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><div class="para">
							Create some new managed containers in the current fabric, which you can then add to the ensemble. Use the default profile for these new containers. For a production environment, it is recommended that you create at least four new managed containers (must be an even number), each running on their own host.
						</div></li><li class="listitem"><div class="para">
							While logged on to a container in the fabric, use the <code class="code">fabric:ensemble-add</code> command to add the managed containers to the ensemble. For example, given the four managed containers, <code class="code">container1</code>, <code class="code">container2</code>, <code class="code">container3</code>, and <code class="code">container4</code>, you would enter the following command:
						</div><pre class="programlisting">fabric:ensemble-add container1 container2 container3 container4</pre><div class="admonition note"><div class="admonition_header">Note</div><div><div class="para">
								You must specify an <span class="emphasis"><em>even</em></span> number of containers to the <code class="code">fabric:ensemble-add</code> command.
							</div></div></div></li><li class="listitem"><div class="para">
							To check that the ensemble has been successfully created, invoke the <code class="code">fabric:container-list</code> command.
						</div></li></ol></div><div class="admonition important"><div class="admonition_header">Important</div><div><div class="para">
						Do not attempt to expand (or shrink) a Fabric ensemble in a production environment. When you add containers to (or remove containers from) an ensemble, the ZooKeeper IP ports are all re-assigned, which typically causes the containers in the fabric to lose connectivity with the ensemble.
					</div></div></div></section><section class="simplesect" id="topic-32415"><div class="titlepage"><div><div><h3 class="title">Taking a Fabric server down for maintenance</h3></div></div></div><div class="para">
					If you need to perform any maintenance on the host where a Fabric server is running, you can do this while maintaining availability of the Fabric registry, so long as a quorum (more than half) of the Fabric servers are still running. To stop a Fabric server, simply invoke the <code class="code">fabric:container-stop</code> command, specifying the name of the Fabric server.
				</div><div class="para">
					In general, it is recommended to have at least five Fabric servers in the ensemble. Three is not an adequate number. For example, with three servers in the ensemble consider what happens when you take a Fabric server down for maintenance. The two remaining Fabric servers form a quorum, but there is now no tolerance for failure. If one of the remaining Fabric servers fails, the whole fabric fails. In order to maintain high availability during maintenance, it is therefore essential to have at least five Fabric servers in the ensemble.
				</div></section></section></section><section class="chapter" id="Agents"><div class="titlepage"><div><div><h2 class="title">Chapter 8. Fabric Agents</h2></div><div><div class="abstract"><p class="title"><strong>Abstract</strong></p><div class="para">
						The Fabric agent, which is responsible for provisioning on each container instance, is a key component of the Fabric infrastructure. When it comes to troubleshooting the behavior of a Fabric container, it is valuable to have an understanding of what the Fabric agent does and how it works.
					</div></div></div></div></div><section class="section" id="Agents-Intro"><div class="titlepage"><div><div><h2 class="title">8.1. Introduction</h2></div></div></div><section class="simplesect" id="topic-32347"><div class="titlepage"><div><div><h3 class="title">Fabric agent</h3></div></div></div><div class="para">
					The <em class="firstterm">Fabric agent</em> is the part of Fabric that is responsible for applying profiles to containers. The agent can run in any container and its role is to retrieve profile information from the registry and apply them to the container.
				</div><div class="para">
					To be specific, the Fabric agent performs the following actions:
				</div><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><div class="para">
							Retrieves the profiles and versions assigned to the container on which it is running.
						</div></li><li class="listitem"><div class="para">
							Reconfigures the container.
						</div></li><li class="listitem"><div class="para">
							Calculates what needs to be installed, removed or updated on the container.
						</div></li><li class="listitem"><div class="para">
							Performs the requisite install, remove, and update actions.
						</div></li></ol></div></section><section class="simplesect" id="topic-32348"><div class="titlepage"><div><div><h3 class="title">Agent modules</h3></div></div></div><div class="para">
					In reality, the Fabric agent is composed of the following two modules:
				</div><div class="variablelist"><dl class="variablelist"><dt><span class="term">[<span class="citation">fabric-configadmin</span>]</span></dt><dd><div class="para">
								The Fabric configuration admin bridge. Translates the registry information into configuration information.
							</div></dd><dt><span class="term">[<span class="citation">fabric-agent</span>]</span></dt><dd><div class="para">
								The deployment agent. Reads the translated configuration and provisions the container accordingly.
							</div></dd></dl></div><div class="para">
					Often, the term, <span class="emphasis"><em>agent</em></span>, refers just to the deployment agent ([<span class="citation">fabric-agent</span>] module), but here we discuss both of the agent modules and describe the role of each in some detail.
				</div></section></section><section class="section" id="Agents-ConfigAdmin"><div class="titlepage"><div><div><h2 class="title">8.2. The Configuration Admin Bridge</h2></div></div></div><section class="simplesect" id="topic-32349"><div class="titlepage"><div><div><h3 class="title">Overview</h3></div></div></div><div class="para">
					The configuration admin bridge is responsible for bridging between the ZooKeeper registry and the OSGi Configuration Admin service. After the bridge connects to the ZooKeeper registry, it discovers what version is assigned to the container, retrieves the appropriate versions of the profiles assigned to the container, translates the profiles into configuration data, and applies the profile data to the container.
				</div></section><section class="simplesect" id="topic-32350"><div class="titlepage"><div><div><h3 class="title">Information in a profile</h3></div></div></div><div class="para">
					Profiles can contain two distinct kinds of information:
				</div><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><div class="para">
							<span class="emphasis"><em>Configuration information</em></span>—which includes:
						</div><div class="itemizedlist"><ul class="itemizedlist" type="circle"><li class="listitem"><div class="para">
									System configuration
								</div></li><li class="listitem"><div class="para">
									OSGi configuration
								</div></li></ul></div></li><li class="listitem"><div class="para">
							<span class="emphasis"><em>Provisioning information</em></span>—which includes lists of:
						</div><div class="itemizedlist"><ul class="itemizedlist" type="circle"><li class="listitem"><div class="para">
									Bundles
								</div></li><li class="listitem"><div class="para">
									Karaf features
								</div></li></ul></div></li></ul></div></section><section class="simplesect" id="topic-32351"><div class="titlepage"><div><div><h3 class="title">Actions performed</h3></div></div></div><div class="para">
					The configuration admin bridge reads all of the relevant profiles and creates an OSGi configuration to represent them. The provisioning and system information are then stored under the <code class="code">io.fabric8.agent</code> PID (in the context of the OSGi Configuration Admin service, a PID is a named collection of property settings).
				</div><div class="para">
					If an assigned profile belongs to a hierarchy (profile inheritance) or if multiple profiles are assigned to the container, the configuration admin bridge takes this into account, resolving any overlapping configuration settings to produce an overlay view of the profiles. There is only one <code class="code">io.fabric8.agent</code> PID, even when there are multiple assigned profiles.
				</div><div class="para">
					The output from the configuration admin bridge is just a set of key-value pairs stored under the <code class="code">io.fabric8.agent</code> PID.
				</div></section><section class="simplesect" id="topic-32352"><div class="titlepage"><div><div><h3 class="title">Configuration updates</h3></div></div></div><div class="para">
					The configuration admin bridge watches the Fabric registry for changes, so that any updates to the container's assigned profiles are tracked and immediately applied to the local container's OSGi configuration.
				</div></section></section><section class="section" id="Agents-Deploy"><div class="titlepage"><div><div><h2 class="title">8.3. The Deployment Agent</h2></div></div></div><section class="simplesect" id="topic-32353"><div class="titlepage"><div><div><h3 class="title">Actions performed</h3></div></div></div><div class="para">
					The <em class="firstterm">deployment agent</em> listens for local configuration changes on the <code class="code">io.fabric8.agent</code> PID. Any change in that configuration will trigger the deployment agent.
				</div><div class="para">
					When the deployment agent is triggered, it performs the following actions:
				</div><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><div class="para">
							The deployment agent reads the whole <code class="code">io.fabric8.agent</code> PID and calculates what bundles are to be installed in the container.
						</div></li><li class="listitem"><div class="para">
							If the profiles assigned to the container specify any Karaf features, the deployment agent translates them into a list of bundles, so that the agent obtains a complete list of bundles to install.
						</div></li><li class="listitem"><div class="para">
							The deployment agent compares the list of bundles to install with the list of bundles currently installed, in order to identify:
						</div><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><div class="para">
									Bundles to uninstall,
								</div></li><li class="listitem"><div class="para">
									Bundles to install,
								</div></li><li class="listitem"><div class="para">
									Bundles to update.
								</div></li></ul></div></li><li class="listitem"><div class="para">
							The deployment agent then performs the bundle uninstalling, installing, and updating in the container.
						</div></li></ol></div></section><section class="simplesect" id="topic-32354"><div class="titlepage"><div><div><h3 class="title">Downloading artifacts</h3></div></div></div><div class="para">
					The deployment agent is capable of downloading artifacts from two different types of maven repository:
				</div><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><div class="para">
							Registered Fabric Maven proxies
						</div></li><li class="listitem"><div class="para">
							Configured Maven repositories (any Maven repository configured in the profile overlay).
						</div></li></ul></div><div class="para">
					Priority is always given to the Fabric Maven proxies. If more than one Maven proxy is registered in the fabric, the proxies are used in order, from the oldest to the newest.
				</div><div class="para">
					If the target artifact is not found in the Maven proxies, the configured Maven repositories are used instead. The list of repositories is determined by the <code class="code">org.ops4j.pax.url.mvn.repositories</code> property of the <code class="code">io.fabric8.agent</code> PID.
				</div><div class="para">
					To change the list of repositories for a specific profile, you can simply change the <code class="code">org.ops4j.pax.url.mvn.repositories</code> property using the <code class="code">fabric:profile-edit</code> command:
				</div><pre class="programlisting">fabric:profile-edit --pid io.fabric8.agent/org.ops4j.pax.url.mvn.repositories=http://repositorymanager.mylocalnetwork.net default</pre><div class="para">
					It is recommended that you specify this configuration in one profile only, and have the rest of profiles inherit from it. The <code class="code">default</code> profile, which is the ancestor of all of the standard profiles, is the ideal place for this.
				</div></section><section class="simplesect" id="topic-32355"><div class="titlepage"><div><div><h3 class="title">Container restarts</h3></div></div></div><div class="para">
					In most cases, when a container is provisioned by the provisioning agent, the container is kept alive and no restart is needed. A restart becomes necessary, however, whenever the following changes are made:
				</div><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><div class="para">
							Changes to the OSGi framework;
						</div></li><li class="listitem"><div class="para">
							Changes to the OSGi framework configuration.
						</div></li></ul></div><div class="para">
					The normal case is where the container stays alive during provisioning, because it is rarely necessary to make changes to the underlying OSGi framework. If a container does need to restart, the restart is performed automatically by the deployment agent and, after the restart, the container reconnects to the cluster without any manual intervention.
				</div></section><section class="simplesect" id="topic-32356"><div class="titlepage"><div><div><h3 class="title">Monitoring the provisioning status</h3></div></div></div><div class="para">
					Throughout the whole process of deploying and provisioning, the deployment agent stores the provisioning status in the runtime registry, so that it is available to the whole cluster. The user can check the provisioning status at any time using the <code class="code">fabric:container-list</code> command.
				</div><pre class="programlisting">JBossFuse:karaf@root&gt; fabric:container-list

[id]                           [version] [alive] [profiles]                     [provision status]
root*                          1.0       true    fabric, fabric-ensemble-0000-1 success
mq1                            1.0       true    mq                             success
mq2                            1.0       true    mq                             downloading
billing-broker                 1.0       true    billing                        success
    admin-console              1.0       true    web, admin-console             success</pre><div class="para">
					To monitor the provisioning status in real time, you can pass the <code class="code">fabric:container-list</code> command as an argument to the <code class="code">shell:watch</code> command, as follows:
				</div><pre class="programlisting">shell:watch fabric:container-list</pre></section><section class="simplesect" id="topic-32357"><div class="titlepage"><div><div><h3 class="title">Resolution and startup ordering</h3></div></div></div><div class="para">
					To figure out what bundles need to be installed and what bundles need to be removed, the Fabric agent uses the OSGi Bundle Repository (OBR) resolver. The OBR resolver makes sure that all requirements are met (usually package requirements, but potentially also service requirements). To discover a bundle's requirements, the OBR reads the following bundle headers:
				</div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="code">Import-Package</code></span></dt><dd><div class="para">
								For each package listed here, the OBR resolver searches for a bundle that declares the package in a corresponding <code class="code">Export-Package</code> header.
							</div></dd><dt><span class="term"><code class="code">Import-Service</code></span></dt><dd><div class="para">
								For each service listed here, the OBR resolver searches for a bundle that declares the service in a corresponding <code class="code">Export-Service</code> header.
							</div></dd></dl></div><div class="para">
					If you are using Blueprint configuration files, it is especially important to be aware of the need to add an <code class="code">Export-Service</code> header to bundles that implement services. Blueprint configuration files with mandatory references to services will automatically be packaged with the <code class="code">Import-Service</code> bundle header (assuming that you use the <code class="code">maven-bundle-plugin</code>). If the bundle that exports the service does not explicitly specify an <code class="code">Export-Service</code> header, resolution will fail. To fix this error, either the exporter bundle must add an <code class="code">Export-Service</code> declaration, or the importer bundle must remove the <code class="code">Import-Service</code> directive.
				</div><div class="para">
					If resolution is successful, the Fabric agent will start the bundles. Even though you should try to avoid having requirements in the startup order of your bundles, the Fabric agent will attempt to start the bundles based on their expressed requirements and capabilities. This will not solve all issues, especially in cases where asynchronous service registration is involved. The best way to deal with this kind of issues is to use OSGi services.
				</div></section></section></section><section class="chapter" id="Ports"><div class="titlepage"><div><div><h2 class="title">Chapter 9. Allocating Ports</h2></div><div><div class="abstract"><p class="title"><strong>Abstract</strong></p><div class="para">
						You can use the port service to take care of allocating ports for your services, where the port service allocates ports in such a way as to avoid port clashes.
					</div></div></div></div></div><section class="section" id="Ports-Service"><div class="titlepage"><div><div><h2 class="title">9.1. The Port Service</h2></div></div></div><section class="simplesect" id="topic-32531"><div class="titlepage"><div><div><h3 class="title">What is the port service?</h3></div></div></div><div class="para">
					The port service is designed to address the problem of clashing IP port values, which frequently arises in a production environment. The following kinds of problem commonly arise:
				</div><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><div class="para">
							<span class="emphasis"><em>Ports clashing with third-party services</em></span>—a server machine in a production environment often has multiple services deployed on it, with a wide range of IP ports in use. In this environment, there is a relatively large risk that a Fabric container could clash with existing IP ports.
						</div></li><li class="listitem"><div class="para">
							<span class="emphasis"><em>Ports clashing with other Fabric containers</em></span>—when multiple Fabric containers are deployed on the same host, it is necessary to configure their standard services with different IP ports. Setting the IP ports manually would be a considerable nuisance (and error prone).
						</div></li><li class="listitem"><div class="para">
							<span class="emphasis"><em>Ports clashing within a container</em></span>—a port clash can also occur within a single container, if multiple services are competing for the same ports (for example, multiple routes binding to the same ports). Because Fabric containers are highly dynamic, we need to be able to prevent port clashes in this case, and ports must be allocated and de-allocated as services come and go.
						</div></li></ul></div><div class="para">
					The port service addresses this problem by taking over the process of allocating ports. A service that uses the port service can specify a range of ports that it is willing to use, and the port service takes care of allocating a port that does not clash with any of the existing services.
				</div></section><section class="simplesect" id="topic-32532"><div class="titlepage"><div><div><h3 class="title">Benefits of the port service</h3></div></div></div><div class="para">
					The port service offers the following benefits at run time:
				</div><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><div class="para">
							<span class="emphasis"><em>Avoiding port clashes for standard container services</em></span>
						</div></li><li class="listitem"><div class="para">
							<span class="emphasis"><em>Avoiding port clashes for custom services</em></span>
						</div></li></ul></div></section><section class="simplesect" id="topic-32533"><div class="titlepage"><div><div><h3 class="title">Avoiding port clashes for standard container services</h3></div></div></div><div class="para">
					When you start up multiple containers on the same host, the port service ensures that the containers automatically choose different IP ports for their standard services, thus avoiding port clashes between containers. You get this benefit for free: the standard container services are already configured to use the port service.
				</div></section><section class="simplesect" id="topic-32534"><div class="titlepage"><div><div><h3 class="title">Avoiding port clashes for custom services</h3></div></div></div><div class="para">
					You can also use the port service for your own applications, enabling your custom services to avoid port clashes. This requires you to configure your custom services, as appropriate, to use the port service.
				</div></section><section class="simplesect" id="topic-32535"><div class="titlepage"><div><div><h3 class="title">Using the port service in your own applications</h3></div></div></div><div class="para">
					To use the port service in your own application, proceed as follows:
				</div><div class="procedure"><ol class="procedure" type="1"><li class="step"><div class="para">
							Use the OSGi Config Admin service to define a key, whose value is a port range. Use the following syntax to define a key:
						</div><pre class="programlisting"><em class="replaceable">KeyID</em> = ${port:<em class="replaceable">MinValue</em>,<em class="replaceable">MaxValue</em>}</pre><div class="para">
							The preceding syntax defines the key, <code class="code"><em class="replaceable">KeyID</em></code>, where <code class="code"><em class="replaceable">MinValue</em></code> specifies the minimum value of the IP port, and <code class="code"><em class="replaceable">MaxValue</em></code> specifies the maximum value of the IP port. You can create this key using the standard Karaf commands for editing persistent IDs (PIDs) and their keys (using the <code class="code">fabric:profile-edit</code> command with the <code class="code">--pid</code> option in a Fabric container).
						</div><div class="para">
							For example, if you are logged into a Fabric container, you can see that the <code class="code">default</code> profile defines the key, <code class="code">org.osgi.service.http.port</code>, which specifies the container's Jetty port, as follows:
						</div><pre class="programlisting">FuseFabric:karaf@root&gt; fabric:profile-display default
...
PID: org.ops4j.pax.web
  org.ops4j.pax.web.config.checksum ${checksum:profile:jetty.xml}
  org.ops4j.pax.web.config.url profile:jetty.xml
  javax.servlet.context.tempdir ${karaf.data}/pax-web-jsp
  <span class="bold bold"><strong>org.osgi.service.http.port ${port:8181,8282}</strong></span></pre></li><li class="step"><div class="para">
							In your application's XML configuration (either Spring XML or Blueprint XML), replace the literal port value in the service's address by a property placeholder—for example, <code class="code">${org.osgi.service.http.port}</code>—which substitutes the value of the key defined in step 1.
						</div><div class="para">
							For a complete example of how to configure the property placeholder, see <a class="xref" href="#Ports-Using" title="9.2. Using the Port Service">Section 9.2, “Using the Port Service”</a>.
						</div></li></ol></div></section><section class="simplesect" id="topic-32536"><div class="titlepage"><div><div><h3 class="title">How the port service allocates a port</h3></div></div></div><div class="para">
					Given a service with a port range (for example, <code class="code">${port:9090,9190}</code>) running on a specific target host, when you start up the service for the <span class="emphasis"><em>first time</em></span>, the port service allocates a port as follows:
				</div><div class="procedure"><ol class="procedure" type="1"><li class="step"><div class="para">
							Determines which ports in the range are already in use on the target host (whether local or remote), by actually trying to bind to the ports.
						</div></li><li class="step"><div class="para">
							Checks the registered ports in the ZooKeeper registry for <span class="emphasis"><em>all</em></span> of the containers deployed on the target host (even if the containers are currently not running).
						</div></li><li class="step"><div class="para">
							Allocates the first free port, within the specified range, that does not clash with any of the ports discovered in steps 1 and 2.
						</div></li></ol></div></section><section class="simplesect" id="topic-32537"><div class="titlepage"><div><div><h3 class="title">How allocated ports are stored</h3></div></div></div><div class="para">
					Allocated ports are stored permanently in the ZooKeeper registry, under the following registry node:
				</div><div class="informalexample"><pre class="programlisting">/fabric/registry/ports/</pre></div><div class="para">
					Each key value, <code class="code"><em class="replaceable">KeyID</em></code>, is filed under its corresponding persistent ID, <code class="code"><em class="replaceable">PID</em></code>, and container name, <code class="code"><em class="replaceable">ContainerName</em></code>, as follows:
				</div><div class="informalexample"><pre class="programlisting">/fabric/registry/ports/containers/<em class="replaceable">ContainerName</em>/<em class="replaceable">PID</em>/<em class="replaceable">KeyID</em></pre></div><div class="para">
					For example, given the child container, <code class="code">Child1</code>, the key for the child container's Jetty port would be stored in the following ZooKeeper node:
				</div><div class="informalexample"><pre class="programlisting">/fabric/registry/ports/containers/Child1/org.ops4j.pax.web/org.osgi.service.http.port</pre></div></section><section class="simplesect" id="topic-32538"><div class="titlepage"><div><div><h3 class="title">Keys used by the standard container services</h3></div></div></div><div class="para">
					Some of keys used by standard container services are as follows:
				</div><div class="informalexample"><pre class="programlisting">/fabric/registry/ports/containers/<em class="replaceable">ContainerName</em>/org.apache.karaf.shell/sshPort
/fabric/registry/ports/containers/<em class="replaceable">ContainerName</em>/org.ops4j.pax.web/org.osgi.service.http.port
/fabric/registry/ports/containers/<em class="replaceable">ContainerName</em>/org.apache.karaf.management/rmiServerPort
/fabric/registry/ports/containers/<em class="replaceable">ContainerName</em>/org.apache.karaf.management/rmiRegistryPort</pre></div></section><section class="simplesect" id="topic-32539"><div class="titlepage"><div><div><h3 class="title">Behavior upon stopping and restarting a container</h3></div></div></div><div class="para">
					When you stop a container, the ports used by that container are stored in the ZooKeeper registry and continue to be reserved for that container by the port service. Subsequently, when you restart the container, Fabric reads the port values stored in ZooKeeper and restarts the container's services using the stored values. This behavior has the following consequences:
				</div><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><div class="para">
							The ports used by the container's services remain constant (after the initial allocation has occurred). You can advertise the ports to clients and be confident that the ports will remain valid over the long term.
						</div></li><li class="listitem"><div class="para">
							If, while the container is stopped, another service binds to one of the container's ports, there is a port clash when the container restarts, and the affected service fails to start (but at least we can guarantee that Fabric will not cause such a clash, because Fabric deliberately avoids re-using allocated container ports).
						</div></li></ul></div></section><section class="simplesect" id="topic-32540"><div class="titlepage"><div><div><h3 class="title">Deallocating ports</h3></div></div></div><div class="para">
					When you destroy a container (by invoking the <code class="code">fabric:container-delete</code> command), Fabric deallocates all of the ports assigned to that container, so that they become available for use again by services in other containers. In other words, when the <code class="code"><em class="replaceable">ContainerName</em></code> container is deleted, all of the key entries under <code class="code">/fabric/registry/ports/containers/<em class="replaceable">ContainerName</em></code> are deleted from the ZooKeeper registry.
				</div></section></section><section class="section" id="Ports-Using"><div class="titlepage"><div><div><h2 class="title">9.2. Using the Port Service</h2></div></div></div><section class="simplesect" id="topic-32541"><div class="titlepage"><div><div><h3 class="title">Overview</h3></div></div></div><div class="para">
					This section explains how to use the port service in you own applications, taking the <code class="code">example-camel-cxf</code> profile as an example. There are two basic steps to configuring the port service in your application:
				</div><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><div class="para">
							<span class="emphasis"><em>At development time</em></span>—using the property placeholder service, replace a service's fixed port number by a key.
						</div></li><li class="listitem"><div class="para">
							<span class="emphasis"><em>At deployment time</em></span>—using the OSGi Config Admin service, specify the key value as a port range. For example, you can specify the key value as a PID property setting in a Fabric profile.
						</div></li></ul></div><div class="para">
					It is possible to configure the property placeholder in Blueprint XML, or in Java (using the relevant OSGi API).
				</div><div class="admonition note"><div class="admonition_header">Note</div><div><div class="para">
						The property placeholder syntax in Spring XML is deprecated (it belongs to the deprecated Spring-DM component).
					</div></div></div></section><section class="simplesect" id="topic-32542"><div class="titlepage"><div><div><h3 class="title">Demonstration code</h3></div></div></div><div class="para">
					This example is based on the <code class="code">example-camel-cxf</code> profile. The source code for the example is taken from the <code class="code">fabric-camel-cxf</code> example on <a class="link" href="https://github.com/fabric8io/fabric8">Github</a>, which is available from the following URL:
				</div><pre class="programlisting">https://github.com/fabric8io/fabric8/tree/1.x/fabric/fabric-examples/fabric-camel-cxf</pre></section><section class="simplesect" id="topic-32543"><div class="titlepage"><div><div><h3 class="title">Property placeholder in XML configuration</h3></div></div></div><div class="para">
					The following Spring XML configuration shows the definition of an endpoint for the greeter Web service (taken from the file, <code class="code">src/main/resources/OSGI-INF/blueprint/cxf.xml</code>, in the <code class="code">fabric-camel-cxf</code> demonstration):
				</div><div class="informalexample"><pre class="programlisting">&lt;blueprint xmlns="http://www.osgi.org/xmlns/blueprint/v1.0.0"
           xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
           xmlns:cxf="http://camel.apache.org/schema/blueprint/cxf"
           xmlns:cm="http://aries.apache.org/blueprint/xmlns/blueprint-cm/v1.1.0"
           xsi:schemaLocation="
           http://www.osgi.org/xmlns/blueprint/v1.0.0
           http://www.osgi.org/xmlns/blueprint/v1.0.0/blueprint.xsd
           http://camel.apache.org/schema/blueprint/cxf
           http://camel.apache.org/schema/blueprint/cxf/camel-cxf.xsd"&gt;

    &lt;cm:property-placeholder id="placeholder"
                             persistent-id="io.fabric8.examples.camel.cxf"
                             update-strategy="reload"&gt;
        &lt;cm:default-properties&gt;
            &lt;cm:property name="greeterPort" value="9090"/&gt;
        &lt;/cm:default-properties&gt;
    &lt;/cm:property-placeholder&gt;

    &lt;cxf:cxfEndpoint id="greeterEndpoint"
                     address="http://localhost:${greeterPort}/greeter"
                     serviceClass="io.fabric8.examples.camelcxf.Greeter"&gt;
      &lt;cxf:features&gt;
        &lt;bean class="io.fabric8.cxf.endpoint.ManagedApiFeature"/&gt;
      &lt;/cxf:features&gt;
    &lt;/cxf:cxfEndpoint&gt;
    ...
&lt;/blueprint&gt;</pre></div><div class="para">
					The CXF endpoint (which binds to a Camel route) is defined by the <code class="code">cxf:cxfEndpoint</code> element. In the <code class="code">address</code> attribute, the port number is specified by substituting the <code class="code">greeterPort</code> key, <code class="code">${greeterPort}</code>. The property placeholder mechanism is configured by the <code class="code">cm:property-placeholder</code> element, which specifies that the <code class="code">greeterPort</code> property belongs to the <code class="code">io.fabric8.examples.camel.cxf</code> PID. The property placeholder mechanism is integrated with the OSGi Config Admin service, which allows you to override the port number at deployment time.
				</div></section><section class="simplesect" id="topic-32544"><div class="titlepage"><div><div><h3 class="title">Specifying a port range using OSGi Config Admin</h3></div></div></div><div class="para">
					At deployment time, you can override the default port number of the greeter Web service. In this particular example, where the deployment is described by the <code class="code">example-camel-cxf</code> profile, the port number is integrated with the port service and specified as a port range.
				</div><div class="para">
					Because the port range is defined at deployment time, it is <span class="emphasis"><em>not</em></span> specified in the example source code, but is instead specified in the <code class="code">example-camel-cxf</code> Fabric profile. You can see the configured port range by entering the following console command:
				</div><div class="informalexample"><pre class="programlisting">JBossFuse:karaf@root&gt; fabric:profile-display example-camel-cxf</pre></div><div class="para">
					In the output of this command, you should see the following configuration setting for the <code class="code">io.fabric8.examples.camel.cxf</code> persistent ID:
				</div><div class="informalexample"><pre class="programlisting">...
Configuration details
----------------------------
PID: io.fabric8.examples.camel.cxf
  greeterPort ${port:9090,9190}
...</pre></div><div class="para">
					The preceding output shows that the <code class="code">greeterPort</code> key is set to <code class="code">${port:9090,9190}</code>.
				</div></section><section class="simplesect" id="topic-32545"><div class="titlepage"><div><div><h3 class="title">Modifying the port range</h3></div></div></div><div class="para">
					If you want to modify the port range configured in the <code class="code">example-camel-cxf</code> profile, you can do so using the <code class="code">fabric:profile-edit</code> console command. For example, to change the value of <code class="code">greeterPort</code> to the range, <code class="code">${port:7070,7170}</code>, you would enter the following console command:
				</div><pre class="programlisting">JBossFuse:karaf@root&gt; fabric:profile-edit
  --pid io.fabric8.examples.camel.cxf/greeterPort=\$\{port:7070,7170\}
  example-camel-cxf</pre><div class="para">
					Where the <code class="code">$</code> sign and the curly braces, <code class="code">{ }</code>, must be escaped by the backslash character, <code class="code">\</code>, as shown. Alternatively, if you prefer to edit the port range using the built-in text editor, you can enter the following console command instead:
				</div><pre class="programlisting">JBossFuse:karaf@root&gt; fabric:profile-edit --pid io.fabric8.examples.camel.cxf example-camel-cxf</pre></section></section></section><section class="chapter" id="Gateway"><div class="titlepage"><div><div><h2 class="title">Chapter 10. Gateway</h2></div><div><div class="abstract"><p class="title"><strong>Abstract</strong></p><div class="para">
						The Fabric Gateway provides a TCP and HTTP/S gateway for discovery, load balancing and failover of services running in a fabric. The Fabric Gateway enables you to use standard HTTP URLs to access Web applications or Web services running in a fabric. In JBoss Fuse, messaging clients can discover and connect to brokers over any supported messaging protocol (OpenWire, STOMP, MQTT, AMQP or WebSockets), letting the gateway handle the connection management to the real services running inside the fabric.
					</div></div></div></div></div><section class="section" id="Gateway-Arch"><div class="titlepage"><div><div><h2 class="title">10.1. Gateway Architecture</h2></div></div></div><section class="simplesect" id="topic-32359"><div class="titlepage"><div><div><h3 class="title">Deployment strategies</h3></div></div></div><div class="para">
					There are two main deployment strategies for a gateway:
				</div><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><div class="para">
							Run the gateway on each machine that needs to discover services and communicate with it through <code class="code">localhost</code>. In this case, you do not need to hard code any host names in your messaging or Web clients and the connection to the gateway on <code class="code">localhost</code> is nice and fast.
						</div></li><li class="listitem"><div class="para">
							Run the gateway on one or more known hosts using DNS or VIP load balancing (mapping host names to machines). In thise case, you can use a fixed host name for all your services
						</div></li></ul></div></section><section class="simplesect" id="topic-32360"><div class="titlepage"><div><div><h3 class="title">How the gateway works</h3></div></div></div><div class="para">
					The gateway monitors and detects any changes in the ZooKeeper registry for all Web applications, Web services, servlets and message brokers. For all of the registered services, the gateway applies mapping rules to figure out how to expose those services through TCP or HTTP.
				</div><div class="para">
					The ZooKeeper registry is automatically populated by Fabric when you deploy Web archives (WARs) or CXF based Web services.
				</div></section></section><section class="section" id="Gateway-Running"><div class="titlepage"><div><div><h2 class="title">10.2. Running the Gateway</h2></div></div></div><section class="simplesect" id="topic-32361"><div class="titlepage"><div><div><h3 class="title">Deploy a gateway profile</h3></div></div></div><div class="para">
					To run the gateway, simply deploy one (or more) of the predefined profiles to a Fabric container. The following gateway profiles are provided:
				</div><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="code">gateway-mq</code></span></dt><dd><div class="para">
								Profile for a messaging gateway (for accessing Apache ActiveMQ brokers in the fabric).
							</div></dd><dt><span class="term"><code class="code">gateway-http</code></span></dt><dd><div class="para">
								Profile for a HTTP gateway (for Web applications or Web services).
							</div></dd></dl></div></section></section><section class="section" id="Gateway-Config"><div class="titlepage"><div><div><h2 class="title">10.3. Configuring the Gateway</h2></div></div></div><section class="simplesect" id="topic-32362"><div class="titlepage"><div><div><h3 class="title">Configuring with the Management Console</h3></div></div></div><div class="para">
					To configure the gateway using the Management Console UI, navigate to the <span class="guilabel">Profiles</span> page then click on the <span class="guilabel">Configuration</span> tab, then select either the <span class="guilabel">Fabric8 HTTP Gateway</span> or the <span class="guilabel">Fabric8 MQ Gateway</span> to configure its settings.
				</div></section><section class="simplesect" id="topic-32363"><div class="titlepage"><div><div><h3 class="title">HTTP mapping rules</h3></div></div></div><div class="para">
					When using the HTTP gateway, it is a common requirement to map different versions of Web applications or Web services to different URI paths on the gateway. You can perform very flexible mappings using <a class="link" href="https://en.wikipedia.org/wiki/URL_Template">URI templates</a>.
				</div><div class="para">
					The default behavior is to expose all Web applications and Web services at the context path they are running in the target server. For example, if you deploy the <code class="code">example-quickstarts-rest</code> profile, that uses a URI like <code class="code">/cxf/crm/customerservice/customers/123</code> on whatever host and port it is deployed on. Hence, by default, it is visible on the gateway at <a class="link" href="http://localhost:9000/cxf/crm/customerservice/customers/123">http://localhost:9000/cxf/crm/customerservice/customers/123</a>. For this example, the URI template is:
				</div><pre class="programlisting">{contextPath}/</pre><div class="para">
					Which means take the context path (in the above case, <code class="code">/cxf/crm</code>) and append <code class="code">/</code>, giving <code class="code">/cxf/crm/</code>. Any request within that path is then passed to an instance of the CXF <code class="code">crm</code> service.
				</div></section><section class="simplesect" id="topic-32364"><div class="titlepage"><div><div><h3 class="title">Selecting part of the ZooKeeper registry</h3></div></div></div><div class="para">
					The mapping rules for the MQ gateway and the HTTP gateway are tied to particular regions of the ZooKeeper registry. If you specify a ZooKeeper path for a mapping rule, any services registered under that path become associated with that rule.
				</div><div class="para">
					For example, in the case of messaging, you could associate a messaging gateway with all message brokers worldwide. Alternatively, you could provide continent-specific, country-specific or region-specific gateways, just by specifying different ZooKeeper paths for each gateway configuration. For regional messaging clusters, use different ZooKeeper folders for geographically distinct broker clusters.
				</div><div class="para">
					With HTTP then REST APIs, SOAP Web Services, servlets and web applications all live in different parts of the ZooKeeper registry. From the Management Console UI, you can browse the contents of the registry in the <span class="guilabel">Runtime | Registry</span> section of the console (in the <span class="guilabel">Fabric</span> view).
				</div><div class="para">
					Here are the common ZooKeeper paths:
				</div><div class="informaltable"><table><tr>
						<th>ZooKeeper Path</th> <th>Description</th>
					</tr><tr>
						<td>
							<code class="code">/fabric/registry/clusters/apis/rest</code>
						</td>
						 <td>
							REST based web services
						</td>

					</tr><tr>
						<td>
							<code class="code">/fabric/registry/clusters/apis/ws</code>
						</td>
						 <td>
							SOAP based web services
						</td>

					</tr><tr>
						<td>
							<code class="code">/fabric/registry/clusters/servlets</code>
						</td>
						 <td>
							Servlets (registered usually individually via the OSGI APIs)
						</td>

					</tr><tr>
						<td>
							<code class="code">/fabric/registry/clusters/webapps</code>
						</td>
						 <td>
							Web Applications (i.e. WARs)
						</td>

					</tr></table></div></section><section class="simplesect" id="topic-32365"><div class="titlepage"><div><div><h3 class="title">Segregating URI paths</h3></div></div></div><div class="para">
					You might want to segregate servlets, Web services, or Web applications into different URI spaces.
				</div><div class="para">
					For example, if you want all Web services to be available under <code class="code">/api/</code> and Web applications to be available under <code class="code">/app/</code>, update the URI templates as follows:
				</div><div class="para">
					For the Web services mapping rule:
				</div><pre class="programlisting">ZooKeeperPath: /fabric/registry/clusters/apis
URI template: /api{contextPath}/</pre><div class="para">
					For the Web applications mapping rule:
				</div><pre class="programlisting">ZooKeeperPath: /fabric/registry/clusters/webapps
URI template: /app{contextPath}/</pre><div class="para">
					If you want to split RESTful APIs and SOAP web services into different URI paths, replace the preceding mapping rule with the following rules:
				</div><pre class="programlisting">ZooKeeperPath: /fabric/registry/clusters/apis/rest
URI template: /rest{contextPath}/

ZooKeeperPath: /fabric/registry/clusters/apis/ws
URI template: /ws{contextPath}/</pre></section></section><section class="section" id="Gateway-Version"><div class="titlepage"><div><div><h2 class="title">10.4. Versioning</h2></div></div></div><section class="simplesect" id="topic-32366"><div class="titlepage"><div><div><h3 class="title">Explicit URIs</h3></div></div></div><div class="para">
					You might want to expose all available versions of each Web service and Web application at a different URI. For example, consider the case where you change your URI template to the following:
				</div><pre class="programlisting">/version/{version}{contextPath}/</pre><div class="para">
					If you have <code class="code">1.0</code> and <code class="code">1.1</code> versions of a profile that packages Web services or Web applications, you can now access the different versions using version-specific URIs. For example, if you are running version <code class="code">1.0</code> and version <code class="code">1.1</code> implementations of the <code class="code">example-quickstarts-rest</code> profile, you can access either one through the following URIs:
				</div><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><div class="para">
							Version 1.0 through <a class="link" href="http://localhost:9000/version/1.0/cxf/crm/customerservice/customers/123">http://localhost:9000/version/1.0/cxf/crm/customerservice/customers/123</a>
						</div></li><li class="listitem"><div class="para">
							Version 1.1 through <a class="link" href="http://localhost:9000/version/1.1/cxf/crm/customerservice/customers/123">http://localhost:9000/version/1.1/cxf/crm/customerservice/customers/123</a>
						</div></li></ul></div><div class="para">
					Both versions are available to the gateway, provided you include the version information in the URI.
				</div></section><section class="simplesect" id="topic-32367"><div class="titlepage"><div><div><h3 class="title">Rolling upgrades</h3></div></div></div><div class="para">
					Another approach to dealing with versions of Web services and Web applications is to expose only a <span class="emphasis"><em>single</em></span> version at a time of each Web service or Web application in a single gateway. This is the default configuration.
				</div><div class="para">
					For example, if you deploy a <code class="code">1.0</code> version of the <code class="code">gateway-http</code> profile and run a few services, you will see all <code class="code">1.0</code> versions of them. If you run some <code class="code">1.1</code> versions of these services, the gateway will not see them. If you now do a rolling upgrade of your gateway to version <code class="code">1.1</code>, it will switch to showing only the <code class="code">1.1</code> versions of the services.
				</div><div class="para">
					Alternatively, you can specify the exact <span class="emphasis"><em>profile</em></span> version to use, on the mapping configuration screen.
				</div><div class="para">
					Another approach you can use with Web applications is to specify the maven coordinates and maven version of a web application in the ZooKeeper path.
				</div></section></section><section class="section" id="Gateway-URITempl"><div class="titlepage"><div><div><h2 class="title">10.5. URI Template Expressions</h2></div></div></div><section class="simplesect" id="topic-32368"><div class="titlepage"><div><div><h3 class="title">Variables</h3></div></div></div><div class="para">
					The following table shows the variables you can use in a URI template expression:
				</div><div class="informaltable"><table><tr>
						<th>Expression</th> <th>Description</th>
					</tr><tr>
						<td>
							<code class="code">{bundleName}</code>
						</td>
						 <td>
							The name of the bundle that registers the Web service, servlet or application. This variable is currently <span class="emphasis"><em>not</em></span> supported for Web services, but works for Web applications and servlets in an OSGi container.
						</td>

					</tr><tr>
						<td>
							<code class="code">{bundleVersion}</code>
						</td>
						 <td>
							The version of the bundle that registers the Web service, servlet or application. This variable is currently <span class="emphasis"><em>not</em></span> supported for Web services, but works for Web applications and servlets in an OSGi container.
						</td>

					</tr><tr>
						<td>
							<code class="code">{container}</code>
						</td>
						 <td>
							The container ID of the container where the Web service or Web application is deployed.
						</td>

					</tr><tr>
						<td>
							<code class="code">{contextPath}</code>
						</td>
						 <td>
							The context path (the part of the URL after the host and port) of the Web service or Web application implementation.
						</td>

					</tr><tr>
						<td>
							<code class="code">{servicePath}</code>
						</td>
						 <td>
							The relative path within ZooKeeper that a service is registered. This is usually is made up of, for web services as the service name and version. For web applications its often the maven coordinates
						</td>

					</tr><tr>
						<td>
							<code class="code">{version}</code>
						</td>
						 <td>
							The profile version of the Web service or Web application.
						</td>

					</tr></table></div></section></section></section><section class="chapter" id="FMCManageAuthentication"><div class="titlepage"><div><div><h2 class="title">Chapter 11. Securing Fabric Containers</h2></div><div><div class="abstract"><p class="title"><strong>Abstract</strong></p><div class="para">
						By default, fabric containers uses text-based username/password authentication. Setting up a more robust access control system involves creating and deploying a new JAAS realm to the containers in the fabric.
					</div></div></div></div></div><section class="simplesect" id="topic-32468"><div class="titlepage"><div><div><h2 class="title">Default authentication system</h2></div></div></div><div class="para">
				By default, Fabric uses a simple text-based authentication system (implemented by the JAAS login module, <code class="code">io.fabric8.jaas.ZookeeperLoginModule</code>). This system allows you to define user accounts and assign passwords and roles to the users. Out of the box, the user credentials are stored in the Fabric registry, unencrypted.
			</div></section><section class="simplesect" id="topic-32469"><div class="titlepage"><div><div><h2 class="title">Managing users</h2></div></div></div><div class="para">
				You can manage users in the default authentication system using the <code class="code">jaas:*</code> family of console commands. First of all you need to attach the <code class="code">jaas:*</code> commands to the <code class="code">ZookeeperLoginModule</code> login module, as follows:
			</div><pre class="programlisting">JBossFuse:karaf@root&gt; jaas:realms 
Index Realm                Module Class                                                                    
    1 karaf                org.apache.karaf.jaas.modules.properties.PropertiesLoginModule                  
    2 karaf                org.apache.karaf.jaas.modules.publickey.PublickeyLoginModule                    
    3 karaf                io.fabric8.jaas.ZookeeperLoginModule                                            
JBossFuse:karaf@root&gt; jaas:manage --index 3</pre><div class="para">
				Which attaches the <code class="code">jaas:*</code> commands to the <code class="code">ZookeeperLoginModule</code> login module. You can then add users and roles, using the <code class="code">jaas:useradd</code> and <code class="code">jaas:roleadd</code> commands. Finally, when you are finished editing the user data, you must commit the changes by entering the <code class="code">jaas:update</code> command, as follows:
			</div><pre class="programlisting">JBossFuse:karaf@root&gt; jaas:update</pre><div class="para">
				Alternatively, you can abort the pending changes by entering <code class="code">jaas:cancel</code>.
			</div></section><section class="simplesect" id="topic-32470"><div class="titlepage"><div><div><h2 class="title">Obfuscating stored passwords</h2></div></div></div><div class="para">
				By default, the JAAS <code class="code">ZookeeperLoginModule</code> stores passwords in plain text. You can provide additional protection to passwords by storing them in an obfuscated format. This can be done by adding the appropriate configuration properties to the <code class="code">io.fabric8.jaas</code> PID and ensuring that they are applied to <span class="emphasis"><em>all</em></span> of the containers in the fabric.
			</div><div class="para">
				For more details, see <a class="link" href="https://access.redhat.com/documentation/en-US/Red_Hat_JBoss_Fuse/6.2/html/Security_Guide/FMQSecurityEncryptProperties.html">section "Using Encrypted Property Placeholders" in "Security Guide"</a>.
			</div><div class="admonition note"><div class="admonition_header">Note</div><div><div class="para">
					Although message digest algorithms are not easy to crack, they are not invulnerable to attack (for example, see the <a class="link" href="https://en.wikipedia.org/wiki/Cryptographic_hash_function">Wikipedia article on cryptographic hash functions</a>). Always use file permissions to protect files containing passwords, in addition to using password encryption.
				</div></div></div></section><section class="simplesect" id="topic-32471"><div class="titlepage"><div><div><h2 class="title">Enabling LDAP authentication</h2></div></div></div><div class="para">
				Fabric supports LDAP authentication (implemented by the Apache Karaf <code class="code">LDAPLoginModule</code>), which you can enable by adding the requisite configuration to the default profile.
			</div><div class="para">
				For details of how to enable LDAP authentication in a fabric, see <a class="link" href="https://access.redhat.com/documentation/en-US/Red_Hat_JBoss_Fuse/6.2/html/Security_Guide/FESBLDAPTutorial.html">chapter "LDAP Authentication Tutorial" in "Security Guide"</a>.
			</div></section></section><section class="chapter" id="FESBFabricMavenProxyConfig"><div class="titlepage"><div><div><h2 class="title">Chapter 12. Configuring a Fabric's Maven Proxy</h2></div><div><div class="abstract"><p class="title"><strong>Abstract</strong></p><div class="para">
						The Fabric Ensemble creates a Maven proxy to access the repositories from which artifacts are distributed to the fabric's containers. You can modify the default settings to use a different set of repositories or make an internal repository accessible.
					</div></div></div></div></div><section class="simplesect" id="topic-32485"><div class="titlepage"><div><div><h2 class="title">Overview</h2></div></div></div><div class="para">
				The Fabric Ensemble creates a Maven proxy to facilitate access to the artifacts required by the containers in the fabric. Each Fabric Server deployed in the fabric runs an instance of a Maven proxy. The ensemble aggregates all of the proxies so that it appears to the Fabric Agents as a single Maven proxy.
			</div><div class="para">
				The Fabric Agents use the fabric's Maven proxy to access the known repositories. This ensures that all of the containers use the same set of repositories and artifacts.
			</div><div class="admonition note"><div class="admonition_header">Note</div><div><div class="para">
					Advanced users can configure each Fabric server to act as a proxy for a different set of repositories. However, this is not a recommended set up.
				</div></div></div><div class="admonition note"><div class="admonition_header">Note</div><div><div class="para">
					Fuse Management Console provides tooling for uploading bundles using the Maven proxy. You can also add the fabric's Maven Proxy to a POM file so that bundles can be distributed to the ensemble as part of an automated build process.
				</div></div></div></section><section class="simplesect" id="topic-32486"><div class="titlepage"><div><div><h2 class="title">Default repositories</h2></div></div></div><div class="para">
				By default a fabric's Maven proxy is configured to be a proxy for the following Maven repositories:
			</div><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><div class="para">
						Maven Central (http://repo1.maven.org/maven2)
					</div></li><li class="listitem"><div class="para">
						Fuse Public (<code class="code">https://repo.fusesource.com/nexus/content/groups/public</code>)
					</div></li><li class="listitem"><div class="para">
						Fuse Releases (https://repo.fusesource.com/nexus/content/repositories/releases)
					</div></li><li class="listitem"><div class="para">
						Fuse Early Access (https://repo.fusesource.com/nexus/content/groups/ea)
					</div></li><li class="listitem"><div class="para">
						JBoss Public (<code class="code">https://repository.jboss.org/nexus/content/repositories/public</code>)
					</div></li><li class="listitem"><div class="para">
						SpringSource (http://repository.springsource.com/maven/bundles/release, http://repository.springsource.com/maven/bundles/external)
					</div></li><li class="listitem"><div class="para">
						User's Local (~/.m2/repository)
					</div></li></ul></div></section><section class="simplesect" id="topic-32487"><div class="titlepage"><div><div><h2 class="title">Changing the repositories</h2></div></div></div><a id="idp6696064" class="indexterm"></a><a id="idp6697024" class="indexterm"></a><a id="idp7494064" class="indexterm"></a><div class="para">
				To change the repositories the ensemble proxies:
			</div><div class="procedure"><ol class="procedure" type="1"><li class="step"><div class="para">
						Create a new profile version. From the command console this is done using the <span class="command"><strong>fabric:version-create</strong></span> command. See <a class="link" href="https://access.redhat.com/documentation/en-US/Red_Hat_JBoss_Fuse/6.2/html/Console_Reference/ConsoleFabricVersionCreate.html">section "fabric:version-create" in "Console Reference"</a> for more information.
					</div></li><li class="step"><div class="para">
						Change the <code class="code">org.ops4j.pax.url.mvn.repositories</code> property in the <code class="code">io.fabric8.agent</code> PID of the <code class="code">default</code> profile. <a class="xref" href="#FESBFabricMavenProxyConfigEx010" title="Example 12.1. Configuring the Maven Proxy URL">Example 12.1, “Configuring the Maven Proxy URL”</a> shows the console command for editing this property.
					</div><div class="example" id="FESBFabricMavenProxyConfigEx010"><p class="title"><strong>Example 12.1. Configuring the Maven Proxy URL</strong></p><div class="example-contents"><pre class="screen">JBossFuse:karaf@root&gt; fabric:profile-edit -p io.fabric8.agent/org.ops4j.pax.url.mvn.repositories = file:${runtime.home}/${karaf.default.repository}@snapshots@id=karaf-default, file:${runtime.data}/maven/upload@snapshots@id=fabric-upload, http://repo1.maven.org/maven2@id=central, https://repo.fusesource.com/nexus/content/groups/public@id=fusepublic, https://repository.jboss.org/nexus/content/repositories/public@id=jbosspublic, https://repo.fusesource.com/nexus/content/repositories/releases@id=jbossreleases, https://repo.fusesource.com/nexus/content/groups/ea@id=jbossearlyaccess, http://repository.springsource.com/maven/bundles/release@id=ebrreleases, http://repository.springsource.com/maven/bundles/external@id=ebrexternal</pre></div></div><div class="admonition note"><div class="admonition_header">Note</div><div><div class="para">
							The <code class="code">io.fabric8.agent</code> PID is refined in all of the fabric profiles. Setting the proxy URL, the <code class="code">org.ops4j.pax.url.mvn.repositories</code> property, in the <code class="code">default</code> profile ensures that all of the other fabric profiles share the same Maven proxy setting.
						</div></div></div><div class="admonition important"><div class="admonition_header">Important</div><div><div class="para">
							The <code class="code">fabric</code> profile's <code class="code">io.fabric8.maven</code> PID, which ultimately controls the Maven proxy, imports its value from the <code class="code">default</code> profile's <code class="code">io.fabric8.agent</code> PID. You should <span class="bold bold"><strong>not</strong></span> change the settings of the <code class="code">io.fabric8.maven</code> PID.
						</div></div></div><div class="para">
						Alternatively, instead of resetting the entire list of repositories, you can append a new entry to the repository list by invoking <code class="code">fabric:profile-edit</code> with the <code class="code">--append</code> option, as follows:
					</div><pre class="programlisting">JBossFuse:karaf@root&gt; profile-edit --pid io.fabric8.agent/org.ops4j.pax.url.mvn.repositories='http://fusewin.tpb.lab.eng.brq.redhat.com:8081/nexus/content/repositories/fuse-qe-repo@id=fuse-qa' --append default 1.1</pre></li><li class="step"><div class="para">
						Roll the changes out the fabric by upgrading the containers to the new profile version.
					</div><div class="admonition important"><div class="admonition_header">Important</div><div><div class="para">
							You cannot test this configuration change out on a few containers to validate it. The change <span class="bold bold"><strong>must</strong></span> be made to the entire fabric or it will result in conflicts.
						</div></div></div></li></ol></div></section><section class="simplesect" id="idp12260112"><div class="titlepage"><div><div><h2 class="title">Using an HTTP proxy with the Maven proxy</h2></div></div></div><div class="para">
				Using fabric's built-in Maven proxy, all nodes communicate directly with each other over HTTP. If you need to secure this communication (as when fabric's maven proxy must request maven artifacts from remote repositories), you can configure an HTTP proxy in fabric using a Maven <code class="filename">settings.xml</code> file that includes an HTTP proxy configuration.
			</div><div class="para">
				To do so, follow these steps:
			</div><div class="procedure"><ol class="procedure" type="1"><li class="step"><div class="para">
						Prepare an HTTP proxy settings file (see <a class="xref" href="#HttpProxySettings" title="Example 12.2. Example HTTP proxy settings .xml file">Example 12.2, “Example HTTP proxy settings <code class="code">.xml</code> file”</a> for example content), and put it in the Red Hat JBoss Fuse <em class="replaceable">InstallDir</em><code class="literal">/fuse/</code> directory.
					</div></li><li class="step"><div class="para">
						Start up JBoss Fuse, and create a fabric. For details, see <a class="xref" href="#topic-32522" title="Steps to create the fabric">the section called “Steps to create the fabric”</a>.
					</div></li><li class="step"><div class="para">
						Specify the name and location of the HTTP settings file. At the <code class="code">JBossFuse:karaf@root&gt;</code> command line, type:
					</div><pre class="programlisting">profile-edit --pid io.fabric8.maven/io.fabric8.maven.settings=/home/fuse/http-proxy-settings.xml default</pre></li><li class="step"><div class="para">
						Remove the <span class="property">org.ops4j.pax,url.mvn.repositories</span> property from the <code class="filename">default</code> profile. At the <code class="code">JBossFuse:karaf@root&gt;</code> command line, type:
					</div><pre class="programlisting">profile-edit --delete --pid io.fabric8.agent/org.ops4j.pax.url.mvn.repositories default</pre><div class="para">
						Removing this property causes the Maven proxy to pick up repositories from Maven's <code class="filename">/home/.m2/settings.xml</code> file, pointed to in the <code class="filename">/home/fuse/http-proxy-settings.xml</code> file.
					</div><div class="para">
						All fabric Maven proxy requests for remote repositories will now be redirected to the HTTP proxy server.
					</div></li></ol></div><div class="example" id="HttpProxySettings"><p class="title"><strong>Example 12.2. Example HTTP proxy settings <code class="code">.xml</code> file</strong></p><div class="example-contents"><pre class="programlisting language-xml">&lt;settings xmlns="http://maven.apache.org/SETTINGS/1.0.0" 
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://maven.apache.org/SETTINGS/1.0.0
    http://maven.apache.org/xsd/settings-1.0.0.xsd"&gt;
    
  &lt;!-- localRepository contains the path to the local repository maven  
       will use to store artifacts. Default: ~/.m2/repository --&gt;
        
  &lt;localRepository&gt;/home/fuse/.m2/repository&lt;/localRepository&gt;

      &lt;proxies&gt;
          &lt;proxy&gt;
              &lt;id&gt;qeos-proxy-1&lt;/id&gt;
                  &lt;active&gt;true&lt;/active&gt;
                  &lt;protocol&gt;http&lt;/protocol&gt;
                  &lt;host&gt;10.8.50.13&lt;/host&gt;
                  &lt;port&gt;3128&lt;/port&gt;
          &lt;/proxy&gt;
      &lt;/proxies&gt;
      &lt;profiles&gt;
          &lt;profile&gt;
              &lt;id&gt;fuse-repo&lt;/id&gt;
                  &lt;repositories&gt;
                      &lt;repository&gt;
                          &lt;id&gt;fuse-qe-repo&lt;/id&gt;
                          &lt;url&gt;http://fusewin.tpb.lab.eng.brq.redhat.com:8081/nexus/content/repositories/fuse-qe-repo&lt;/url&gt;
                              &lt;layout&gt;default&lt;/layout&gt;
                      &lt;/repository&gt;
                      &lt;repository&gt;
                          &lt;id&gt;central&lt;/id&gt;
                          &lt;url&gt;http://repo1.maven.org/maven2@id=maven.central.repo&lt;/url&gt;
                              &lt;layout&gt;default&lt;/layout&gt;
                      &lt;/repository&gt;
                  &lt;/repositories&gt;
          &lt;/profile&gt;
      &lt;/profiles&gt;
      &lt;activeProfiles&gt;
          &lt;activeProfile&gt;fuse-repos&lt;/activeProfile&gt;
      &lt;/activeProfiles&gt;

&lt;/settings&gt;</pre></div></div></section></section><section class="chapter" id="Offline"><div class="titlepage"><div><div><h2 class="title">Chapter 13. Offline Repositories</h2></div><div><div class="abstract"><p class="title"><strong>Abstract</strong></p><div class="para">
						Its quite common a common requirement to need offline repositories: either as a local cache of remote Maven repositories, or in cases where production machines do not have access to the Internet.
					</div></div></div></div></div><section class="section" id="Offline-Profile"><div class="titlepage"><div><div><h2 class="title">13.1. Offline Repository for a Profile</h2></div></div></div><section class="simplesect" id="topic-32473"><div class="titlepage"><div><div><h3 class="title">Download into a specified directory</h3></div></div></div><div class="para">
					To download all the bundles and features of a given profile, <code class="code"><em class="replaceable">ProfileName</em></code>, enter the following console command:
				</div><pre class="programlisting">fabric:profile-download --profile <em class="replaceable">ProfileName</em> /tmp/myrepo</pre><div class="para">
					This command downloads all the bundles and features for the default version of the given profile into the <code class="code">/tmp/myrepo</code> directory.
				</div></section><section class="simplesect" id="topic-32474"><div class="titlepage"><div><div><h3 class="title">Download into the system folder</h3></div></div></div><div class="para">
					If you omit the path, the <code class="code">fabric:profile-download</code> command installs the files to the <code class="code">system</code> folder inside the current Fuse container (thereby populating the local maven repository for the container). For example:
				</div><pre class="programlisting">fabric:profile-download --profile <em class="replaceable">ProfileName</em></pre></section></section><section class="section" id="Offline-Version"><div class="titlepage"><div><div><h2 class="title">13.2. Offline Repository for a Version</h2></div></div></div><section class="simplesect" id="topic-32475"><div class="titlepage"><div><div><h3 class="title">Download the current version</h3></div></div></div><div class="para">
					To download all the bundles and features for all the profiles in the default version, enter the following console command:
				</div><pre class="programlisting">fabric:profile-download /tmp/myrepo</pre></section><section class="simplesect" id="topic-32476"><div class="titlepage"><div><div><h3 class="title">Download a specific version</h3></div></div></div><div class="para">
					You can specify the version to download using the <code class="code">--version</code> option, as follows:
				</div><pre class="programlisting">fabric:profile-download --version 1.0 /tmp/myrepo</pre><div class="para">
					If you omit the path the <code class="code">fabric:profile-download</code> command installs the files into the<code class="code">system</code> folder inside the current Fuse container (thereby populating the local maven repository for the container).
				</div></section></section><section class="section" id="Offline-Maven"><div class="titlepage"><div><div><h2 class="title">13.3. Offline Repository for a Maven Project</h2></div></div></div><section class="simplesect" id="topic-32477"><div class="titlepage"><div><div><h3 class="title">Download repository for Maven project</h3></div></div></div><div class="para">
					If you have a Maven project and you need to create an offline repository for building this project and its runtime dependencies, you can use the <a class="link" href="http://maven.apache.org/plugins/maven-dependency-plugin/go-offline-mojo.html">maven dependency plugin</a>.
				</div><div class="para">
					For example, from the top-level directory of a Maven project (such that the current directory has a <code class="code">pom.xml</code> file), you should be able to run the following Maven command:
				</div><pre class="programlisting">mvn org.apache.maven.plugins:maven-dependency-plugin:2.8:go-offline -Dmaven.repo.local=/tmp/cheese</pre><div class="para">
					Which downloads all the Maven dependencies and plug-ins required to build the project to the <code class="code">/tmp/cheese</code> directory.
				</div></section></section></section><section class="chapter" id="Git"><div class="titlepage"><div><div><h2 class="title">Chapter 14. Configuring with Git</h2></div><div><div class="abstract"><p class="title"><strong>Abstract</strong></p><div class="para">
						Fabric implicitly uses <a class="link" href="https://git-scm.com/">Git</a> to store much of its configuration data (in particular, for storing versioned profile data). Normally, this aspect of Fabric is completely transparent, and there is no need to be concerned with the Git functionality inside Fabric. But if you want to, you have the option of tapping directly into the Git layer inside Fabric, in order to manage Fabric configurations.
					</div></div></div></div></div><section class="section" id="Git-HowItWorks"><div class="titlepage"><div><div><h2 class="title">14.1. How Git Works inside Fabric</h2></div></div></div><section class="simplesect" id="idp569584"><div class="titlepage"><div><div><h3 class="title">Cluster architecture</h3></div></div></div><div class="para">
					When Fabric is configured as a Git cluster, the Git configuration layer works as follows:
				</div><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><div class="para">
							Each Fabric server has its own clone of the Git configuration.
						</div></li><li class="listitem"><div class="para">
							One Fabric server is elected to be the <span class="emphasis"><em>master</em></span> instance, and serves as the master remote repository for the other Fabric servers.
						</div></li><li class="listitem"><div class="para">
							All configuration changes made in the other Fabric servers (the <span class="emphasis"><em>slave</em></span> instances) are pushed to the master instance.
						</div></li><li class="listitem"><div class="para">
							When changes occur in the master, the slaves automatically pull the new configuration from the master.
						</div></li><li class="listitem"><div class="para">
							If the master instance is stopped, another container is elected to be the master (failover).
						</div></li><li class="listitem"><div class="para">
							An administrator can access the Git configuration layer by cloning a local Git repository from the master instance. By pushing updates from this local repository, the administrator can change the configuration of the fabric.
						</div></li></ul></div></section><section class="simplesect" id="idp5788576"><div class="titlepage"><div><div><h3 class="title">External Git repository architecture</h3></div></div></div><div class="para">
					When Fabric is configured with an external Git repository, the Git configuration layer works as follows:
				</div><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><div class="para">
							The external Git repository is created in an external Git server (for example, using a service such as GitLab or Gerrit).
						</div></li><li class="listitem"><div class="para">
							When the Fabric is created, it automatically populates the external Git repository with the default configuration (which is initialized by reading the <code class="code"><em class="replaceable">InstallDir</em>/fabric/import</code> directory).
						</div></li><li class="listitem"><div class="para">
							Each Fabric server maintains a synchronized state with the external Git repository.
						</div></li><li class="listitem"><div class="para">
							All configuration changes made in the Fabric servers are pushed to the external Git repository.
						</div></li><li class="listitem"><div class="para">
							When changes occur in the external Git repository, the Fabric servers automatically pull the new configuration from the external Git repository.
						</div></li><li class="listitem"><div class="para">
							An administrator can access the Git configuration layer by cloning a local Git repository from the external Git repository. By pushing updates from this local repository to the external Git repository, the administrator can change the configuration of the fabric.
						</div></li></ul></div></section><section class="simplesect" id="idp12128384"><div class="titlepage"><div><div><h3 class="title">What is stored in the Git repositories?</h3></div></div></div><div class="para">
					The Git repositories in Fabric are used to store Fabric profile configuration data. A Fabric profile consists of the resources, configuration data, and meta-data required to deploy an application into a Fabric container.
				</div></section><section class="simplesect" id="idp50509408"><div class="titlepage"><div><div><h3 class="title">Git branches</h3></div></div></div><div class="para">
					The branches of the Git repository correspond directly to <em class="firstterm">profile versions</em> in Fabric. For example, if you enter the following console command:
				</div><pre class="programlisting">JBossA-MQ:karaf@root&gt; fabric:version-create 
Created version: 1.1 as copy of: 1.0</pre><div class="para">
					You will discover that the underlying Git repository now has a new branch called <code class="code">1.1</code>. In fact, most of the Fabric version commands are approximately equivalent to a corresponding <code class="code">git</code> command, as shown in the following table:
				</div><div class="informaltable"><table frame="void"><col width="50%"/><col width="50%"/><thead><tr>
							<th>Fabric Version Command</th> <th>Analogous Git Command</th>
						</tr></thead><tbody><tr>
							<td>
								<code class="code">fabric:version-create <em class="replaceable">NewBranch</em></code>
							</td>
							 <td>
								<code class="code">git branch <em class="replaceable">NewBranch</em></code>
							</td>

						</tr><tr>
							<td>
								<code class="code">fabric:version-list</code>
							</td>
							 <td>
								<code class="code">git branch</code>
							</td>

						</tr><tr>
							<td>
								<code class="code">fabric:version-set-default <em class="replaceable">Branch</em></code>
							</td>
							 <td>
								<code class="code">git checkout <em class="replaceable">Branch</em></code>
							</td>

						</tr><tr>
							<td>
								<code class="code">fabric:version-delete <em class="replaceable">Branch</em></code>
							</td>
							 <td>
								<code class="code">git branch -d <em class="replaceable">Branch</em></code>
							</td>

						</tr></tbody></table></div></section><section class="simplesect" id="idm6985152"><div class="titlepage"><div><div><h3 class="title">Configuring through the console commands</h3></div></div></div><div class="para">
					When you make any changes to profiles using the console commands, these changes are implicitly committed to the underlying Git repository. Hence, some of the console commands are equivalent to Git operations. For example, if you create a new profile by invoking <code class="code">fabric:profile-create</code>, new files are added to the Git repository, and the changes are committed. Similarly, when you edit a profile using the <code class="code">fabric:profile-edit</code> command, these changes are added and committed to the underlying Git repository.
				</div></section><section class="simplesect" id="idp13545264"><div class="titlepage"><div><div><h3 class="title">Prerequisites</h3></div></div></div><div class="para">
					Fabric itself does not require any <code class="code">git</code> binaries to be installed on your system, because it is implemented using the <a class="link" href="https://eclipse.org/jgit/">JGit</a> library. You will need to install Git binaries on your local system, however, if you want to configure Fabric directly through Git, using a clone of the Git repository.
				</div></section><section class="simplesect" id="idp2099888"><div class="titlepage"><div><div><h3 class="title">Configuring directly through Git</h3></div></div></div><div class="para">
					There are two alternative ways of setting up a fabric to use Git configuration, as follows:
				</div><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><div class="para">
							<a class="xref" href="#Git-Cluster" title="14.2. Using a Git Cluster">Section 14.2, “Using a Git Cluster”</a>
						</div></li><li class="listitem"><div class="para">
							<a class="xref" href="#Git-External" title="14.4. Using an External Git Repository">Section 14.4, “Using an External Git Repository”</a>
						</div></li></ul></div></section></section><section class="section" id="Git-Cluster"><div class="titlepage"><div><div><h2 class="title">14.2. Using a Git Cluster</h2></div></div></div><section class="simplesect" id="idp9221872"><div class="titlepage"><div><div><h3 class="title">Overview</h3></div></div></div><div class="para">
					<a class="xref" href="#Git-Cluster-FigGCA" title="Figure 14.1. Git Cluster Architecture">Figure 14.1, “Git Cluster Architecture”</a> shows an overview of the Fabric architecture when the fabric is configured to use a Git cluster.
				</div><div class="figure" id="Git-Cluster-FigGCA"><p class="title"><strong>Figure 14.1. Git Cluster Architecture</strong></p><div class="figure-contents"><div style="text-align: center; " class="mediaobject"><img style="text-align: middle" src="images/git_01.gif" width="400" alt="Git Cluster Architecture"/></div></div></div></section><section class="simplesect" id="idp57760832"><div class="titlepage"><div><div><h3 class="title">Clone the Git repository</h3></div></div></div><div class="para">
					When a fabric is configured with a Git cluster, the current <span class="emphasis"><em>master</em></span> behaves as a Git server. This means that you can clone the Git repository directly from the Fabric server that is the master.
				</div><div class="para">
					Clone the Git repository using a command like the following:
				</div><pre class="programlisting">$ git clone -b 1.0 http://<em class="replaceable">Hostname</em>:<em class="replaceable">Port</em>/git/fabric</pre><div class="para">
					Where <code class="code"><em class="replaceable">Hostname</em></code> and <code class="code"><em class="replaceable">Port</em></code> are the hostname and IP port of the master Fabric server. Note the following points:
				</div><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><div class="para">
							The port number, <code class="code"><em class="replaceable">Port</em></code>, is usually <code class="code">8181</code>, by default. But if you deploy multiple Fabric containers on the same host, their HTTP ports are automatically incremented, 8182, 8183, (or whichever is the next available port number at the time the container is created).
						</div></li><li class="listitem"><div class="para">
							The <code class="code">-b</code> option is used to check out the <code class="code">1.0</code> Git branch, which corresponds to version 1.0 of the Fabric profile data. There is also a <code class="code">master</code> branch, but it is normally not used by the Fabric servers.
						</div></li><li class="listitem"><div class="para">
							You can also see a sample clone command in the Fuse Management Console, if you navigate to the <span class="guilabel">Container:</span> page for the relevant container, click on the <span class="guilabel">URLs</span> tag, and go to the <span class="guilabel">Git:</span> field. Note, however, that if you try to clone from a slave instance, you will get an error (the Fuse Management Console currently does not indicate whether the container is a slave or a master).
						</div></li></ul></div><div class="admonition important"><div class="admonition_header">Important</div><div><div class="para">
						Do <span class="emphasis"><em>not</em></span> attempt to clone your repository directly from the <code class="code"><em class="replaceable">InstallDir</em>/data/git/local/fabric</code> directory (which holds the container's local Git repository). This approach does not work. When you push and pull to the container's HTTP port, it automatically triggers synchronization events within the Git cluster. These necessary synchronizations would be bypassed, if you cloned from a directory.
					</div></div></div></section><section class="simplesect" id="idp13599456"><div class="titlepage"><div><div><h3 class="title">Authentication</h3></div></div></div><div class="para">
					The Git server exposed by the Fabric is deployed into the container's Jetty container and shares the same security configuration as other default HTTP services. In particular, the HTTP port is configured to request credentials through the HTTP BASIC authentication protocol, and these credentials are then authenticated in the container using the standard JAAS authentication infrastructure. In practice, this means you can use any of the JAAS credentials configured in the fabric to log on to the Git server.
				</div><div class="para">
					You can use one of the following alternatives to specify the credentials for Git:
				</div><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><div class="para">
							<span class="emphasis"><em>Let Git prompt you for credentials</em></span>—this is the default, if you use a Git URL of the form, <code class="code">http://<em class="replaceable">Hostname</em>:<em class="replaceable">Port</em>/git/fabric</code>.
						</div></li><li class="listitem"><div class="para">
							<span class="emphasis"><em>Embed credentials in the Git URL</em></span>—you can embed the credentials directly in the Git URL, using the following syntax:
						</div><pre class="programlisting">http://<em class="replaceable">User</em>:<em class="replaceable">Pass</em>@<em class="replaceable">Hostname</em>:<em class="replaceable">Port</em>/git/fabric</pre></li></ul></div></section><section class="simplesect" id="idp22625712"><div class="titlepage"><div><div><h3 class="title">Basic tasks with Git</h3></div></div></div><div class="para">
					You can now use standard Git commands to perform basic configuration tasks in Fabric:
				</div><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><div class="para">
							<span class="emphasis"><em>Push to the Fabric Git server</em></span>—you can use your local Git repository to edit profile configurations and push the changes up to the fabric. For example, to edit the Camel route in the <code class="code">example-camel-twitter</code> profile:
						</div><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><div class="para">
									Make sure that you are working in the correct branch (initially, this should be branch <code class="code">1.0</code>):
								</div><pre class="programlisting">$ cd <em class="replaceable">LocalGitRepo</em>
$ git checkout 1.0</pre></li><li class="listitem"><div class="para">
									Edit the following Blueprint XML file in your local Git repository, to alter the Camel route:
								</div><pre class="programlisting"><em class="replaceable">LocalGitRepo</em>/fabric/profiles/example/camel/twitter.profile/camel.xml</pre></li><li class="listitem"><div class="para">
									Add and commit the changes locally, using Git commands:
								</div><pre class="programlisting">$ git add -u
$ git commit -m "Changed the route in example-camel-twitter"</pre></li><li class="listitem"><div class="para">
									Push the changes to the fabric:
								</div><pre class="programlisting">$ git push</pre><div class="para">
									This updates the configuration in all of the Fabric servers in the Git cluster. If any of the containers in your fabric have deployed the <code class="code">example-camel-twitter</code> profile, they will immediately be updated with the changes.
								</div></li></ol></div></li><li class="listitem"><div class="para">
							<span class="emphasis"><em>Pull from the Fabric Git server</em></span>—if you change the profile configuration using commands in the Karaf console, you can synchronize those changes with your local Git repository by doing a <code class="code">git pull</code>. For example, to edit the Camel route in the <code class="code">example-camel-twitter</code> profile from the Karaf console:
						</div><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><div class="para">
									In the Karaf console, you can edit the Camel route from the <code class="code">example-camel-twitter</code> profile by entering the following console command:
								</div><pre class="programlisting">fabric:profile-edit --resource camel.xml example-camel-twitter</pre></li><li class="listitem"><div class="para">
									You can now synchronize your local Git repository to these changes. Open a command prompt, and enter the following commands:
								</div><pre class="programlisting">$ cd <em class="replaceable">LocalGitRepo</em>
$ git checkout 1.0</pre></li><li class="listitem"><div class="para">
									Pull the changes from the fabric:
								</div><pre class="programlisting">$ git pull</pre></li></ol></div></li></ul></div></section><section class="simplesect" id="idp1736752"><div class="titlepage"><div><div><h3 class="title">What happens after a failover?</h3></div></div></div><div class="para">
					So far, we have been assuming that the master instance remains unchanged, so that the master instance is synonymous with the <code class="code">origin</code> upstream repository. But what happens if there is a failover? For example, if the Fabric server that is the master instance is stopped and restarted. If your ensemble consists of only one Fabric server, this makes no difference, because there is no other server to fail over to. But if there are three (or five) servers in your ensemble, one of the other Fabric servers will automatically be elected as the new master.
				</div><div class="para">
					The consequence for your local Git repository is that the origin repository is no longer the master instance. Hence, if you try to do a <code class="code">git push</code> or a <code class="code">git pull</code> after failover, you will get the following error:
				</div><pre class="programlisting">$ git pull
fatal: repository 'http://<em class="replaceable">Hostname</em>:8181/git/fabric/' not found</pre></section><section class="simplesect" id="idp1120832"><div class="titlepage"><div><div><h3 class="title">Adding multiple upstream repositories</h3></div></div></div><div class="para">
					Currently, there is no mechanism in Git for failing over automatically to an alternative Git server. But what you can do in Git is to add multiple upstream repositories. It then becomes possible to push to and pull from alternative Git repositories, as long as you name them explicitly in the command line.
				</div><div class="para">
					For example, consider the case where there are two additional Fabric servers in a Git cluster (making three in total). You can add the two additional servers as upstream repositories, using the following Git commands:
				</div><pre class="programlisting">$ git remote add ensemble2 <em class="replaceable">Ensemble2GitURL</em>
$ git remote add ensemble3 <em class="replaceable">Ensemble2GitURL</em></pre><div class="para">
					You can then push to either of these repositories explicitly, using a command of the form:
				</div><pre class="programlisting">$ git push <em class="replaceable">UpstreamName</em> <em class="replaceable">BranchName</em></pre><div class="para">
					For example, to push to branch <code class="code">1.0</code> of the <code class="code">ensemble2</code> Git server:
				</div><pre class="programlisting">$ git push ensemble2 1.0</pre><div class="para">
					Only one of the repositories, <code class="code">origin</code>, <code class="code">ensemble2</code>, <code class="code">ensemble3</code>, is accessible at one time, however (whichever is the master).
				</div></section><section class="simplesect" id="Git-Cluster-Tutorial"><div class="titlepage"><div><div><h3 class="title">Git cluster tutorial</h3></div></div></div><div class="para">
					The following tutorial explains how to create a fabric, which demonstrates a master-slave cluster of Git repositories:
				</div><div class="procedure"><ol class="procedure" type="1"><li class="step"><div class="para">
							<span class="emphasis"><em>(Optional)</em></span> Prepare the container for a cold start. Delete the following directories:
						</div><pre class="programlisting"><em class="replaceable">InstallDir</em>/data
<em class="replaceable">InstallDir</em>/instances</pre><div class="admonition warning"><div class="admonition_header">Warning</div><div><div class="para">
								Performing a cold start completely wipes the current state of the root container, including all of the deployed bundles, and features, and most of the stored data. Do <span class="emphasis"><em>not</em></span> perform this operation on a production system.
							</div></div></div></li><li class="step"><div class="para">
							Start up the container, by entering the following command:
						</div><pre class="programlisting">./bin/fuse</pre></li><li class="step"><div class="para">
							Create a new fabric. At the container prompt, enter the following console command:
						</div><pre class="programlisting">fabric:create --new-user admin --new-user-password <em class="replaceable">AdminPass</em> --new-user-role Administrator \
  --zookeeper-password <em class="replaceable">ZooPass</em> --global-resolver manualip \
  --resolver manualip --manual-ip 127.0.0.1 --wait-for-provisioning</pre><div class="para">
							You need to substitute your own values for <code class="code"><em class="replaceable">AdminPass</em></code> and <code class="code"><em class="replaceable">ZooPass</em></code>. This sample command uses the <code class="code">--manual-ip</code> option to assign the loopback address, <code class="code">127.0.0.1</code>, to the root container. If your host has a static IP address and hostname assigned to it, however, it would be better to use the assigned hostname here instead.
						</div><div class="para">
							You need to wait a minute or two for this command to complete.
						</div></li><li class="step"><div class="para">
							Create two new child containers in the fabric, by entering the following console command:
						</div><pre class="programlisting">fabric:container-create-child --profile fabric root ensemble 2</pre><div class="para">
							This command returns quickly, with the following message:
						</div><pre class="programlisting">The following containers have been created successfully:
	Container: ensemble.
	Container: ensemble2.</pre><div class="para">
							But it takes a couple of more minutes for the new child containers to be completely provisioned. Check the status of the child containers, by entering the following command:
						</div><pre class="programlisting">fabric:container-list</pre><div class="para">
							Wait until the child containers have a <code class="code">[provision status]</code> of <code class="code">success</code> before proceeding.
						</div></li><li class="step"><div class="para">
							Add the two child containers to the Fabric ensemble, so that the Fabric ensemble consists of three containers in all: <code class="code">root</code>, <code class="code">ensemble</code>, and <code class="code">ensemble2</code>. Enter the following console command:
						</div><pre class="programlisting">fabric:ensemble-add ensemble ensemble2</pre><div class="para">
							Wait until the ensemble containers have been successfully provisioned before proceeding.
						</div></li><li class="step"><div class="para">
							Clone the Git repository. The three containers in the Fabric ensemble now constitute a Git cluster. Initially, the <code class="code">root</code> container is the <span class="emphasis"><em>master</em></span> instance of the cluster, so you should attempt to clone the Git repository from the HTTP port exposed by the <code class="code">root</code> container.
						</div><div class="para">
							Open a new command prompt and, at a convenient location in the file system, enter the following command:
						</div><pre class="programlisting">git clone -b 1.0 http://127.0.0.1:8181/git/fabric</pre><div class="para">
							This command clones the Fabric Git repository and checks out the <code class="code">1.0</code> branch. You should now be able to see the profile configuration files under the <code class="code">fabric/profiles</code> subdirectory.
						</div><div class="para">
							If the <code class="code">root</code> container is <span class="emphasis"><em>not</em></span> the current master, you can expect to see an error message like the following when you attempt to clone:
						</div><pre class="programlisting">Cloning into 'fabric'...
fatal: repository 'http://127.0.0.1:8181/git/fabric/' not found</pre></li><li class="step"><div class="para">
							In the next few steps, we explore the failover behaviour of the Git cluster. First of all, we stop the <code class="code">root</code> container (the current Git master), in order to force a failover. In the root container console, enter the <code class="code">shutdown</code> command, as follows:
						</div><pre class="programlisting">JBossA-MQ:karaf@root&gt; shutdown
Confirm: shutdown instance root (yes/no): yes</pre></li><li class="step"><div class="para">
							Now restart the root container, by entering the following command:
						</div><pre class="programlisting">./bin/fuse</pre></li><li class="step"><div class="para">
							Return to the command prompt where you cloned the Git repository and try to do a <code class="code">git pull</code>, as follows:
						</div><pre class="programlisting">cd fabric
git pull</pre><div class="para">
							You will get an error like the following:
						</div><pre class="programlisting">$ git pull
fatal: repository 'http://127.0.0.1:8181/git/fabric/' not found</pre><div class="para">
							Because the root container (listening on IP port 8181) is no longer the master.
						</div><div class="admonition note"><div class="admonition_header">Note</div><div><div class="para">
								In this example, because all of the ensemble containers are running on the same host, the ensemble containers are distinguished by having different IP port numbers (8181, 8182, and 8183). If you created the other ensemble containers on separate hosts, however, they would all have the same port number (8181), but different host names.
							</div></div></div></li><li class="step"><div class="para">
							One of the other Fabric servers (<code class="code">ensemble</code> or <code class="code">ensemble2</code>) is now the master. To gain access to the master, try adding both of the alternative Git URLs as upstream repositories. From a directory in the cloned Git repository, enter the following commands:
						</div><pre class="programlisting">$ git remote add ensemble http://127.0.0.1:8182/git/fabric
$ git remote add ensemble2 http://127.0.0.1:8183/git/fabric</pre></li><li class="step"><div class="para">
							You can now try pulling from one of the other Fabric servers. You can either pull from the <code class="code">ensemble</code> container (pulling branch <code class="code">1.0</code>), as follows:
						</div><pre class="programlisting">$ git pull ensemble 1.0</pre><div class="para">
							Or from the <code class="code">ensemble2</code> container (pulling branch <code class="code">1.0</code>), as follows:
						</div><pre class="programlisting">$ git pull ensemble2 1.0</pre><div class="para">
							Only one of these alternatives can succeed (pulling from the master). Pulling from the slave instance returns an error.
						</div></li><li class="step"><div class="para">
							After you have identified the current master, you can proceed to push and pull using the long form of the <code class="code">git</code> commands (for example, <code class="code">git pull <em class="replaceable">RemoteName</em> <em class="replaceable">BranchName</em></code>).
						</div></li></ol></div></section></section><section class="section" id="Git-Proxy"><div class="titlepage"><div><div><h2 class="title">14.3. Using a Git HTTP Proxy</h2></div></div></div><div class="para">
					When using Fabric's built-in Git cluster, all nodes communicate directly with each other over HTTP. If you need to secure communications, you can configure a Git HTTP proxy.
				</div><section class="simplesect" id="idp824256"><div class="titlepage"><div><div><h3 class="title">Configuring a Git HTTP proxy</h3></div></div></div><div class="para">
					You configure a Git HTTP proxy by configuring the <code class="filename">GitProxyService</code>.
				</div><div class="para">
					After you have created the fabric (as described in <a class="xref" href="#Git-Cluster-Tutorial" title="Git cluster tutorial">the section called “Git cluster tutorial”</a>) issue these commands at the command line: 
<pre class="programlisting">$ fabric:profile-edit --pid io.fabric8.git.proxy/proxyHost=servername default
$ fabric:profile-edit --pid io.fabric8.git.proxy/proxyPort=portNumber default</pre>

				</div></section><section class="simplesect" id="idp51120912"><div class="titlepage"><div><div><h3 class="title"/></div></div></div><div class="para">

				</div></section><section class="simplesect" id="idp51127456"><div class="titlepage"><div><div><h3 class="title"/></div></div></div><div class="para">

				</div></section><section class="simplesect" id="idp51128736"><div class="titlepage"><div><div><h3 class="title"/></div></div></div><div class="para">

				</div></section></section><section class="section" id="Git-External"><div class="titlepage"><div><div><h2 class="title">14.4. Using an External Git Repository</h2></div></div></div><section class="simplesect" id="idp51779840"><div class="titlepage"><div><div><h3 class="title">Overview</h3></div></div></div><div class="para">
					<a class="xref" href="#Git-External-FigEGRA" title="Figure 14.2. External Git Repository Architecture">Figure 14.2, “External Git Repository Architecture”</a> shows an overview of the Fabric architecture when the fabric is configured to use an external Git repository.
				</div><div class="figure" id="Git-External-FigEGRA"><p class="title"><strong>Figure 14.2. External Git Repository Architecture</strong></p><div class="figure-contents"><div style="text-align: center; " class="mediaobject"><img style="text-align: middle" src="images/git_02.gif" width="622" alt="External Git Repository Architecture"/></div></div></div></section><section class="simplesect" id="idp4442976"><div class="titlepage"><div><div><h3 class="title">External git repository architecture</h3></div></div></div><div class="para">
					When you configure a fabric with an external Git repository (which must be done at fabric creation time), the external Git repository becomes the primary Git repository for all of the containers in the Fabric. All of the Fabric servers in the ensemble maintain their own copy of the Git repository (under their respective <code class="code">data/</code> directories), but this local copy is kept up-to-date by regularly polling the external Git repository for updates. If a change is detected in the external Git repository, every Fabric server will do a <code class="code">git pull</code> to update it's local copy of the Git repository.
				</div><div class="para">
					It is also possible for an administrator to clone a local copy of the external Git repository. Using standard <code class="code">git</code> commands, the administrator can now edit the configuration files in the local copy and push the changes to the external Git repository. As soon as those changes are received by the external Git repository, the Fabric servers will detect that an update has occurred and pull the latest configuration.
				</div></section><section class="simplesect" id="idp3283056"><div class="titlepage"><div><div><h3 class="title">Preparing an external Git repository</h3></div></div></div><div class="para">
					When setting up this type of Fabric architecture, the first step is to prepare an external Git repository. When setting up this repository, you should pay attention to the following points:
				</div><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><div class="para">
							The Git repository must be initialized. For example, if you were creating a new Git repository on your local file system, you would initialize it using the command <code class="code">git init</code>. If you are using a Git server to host your repository (for example, Gerrit, GitLab, or GitHub), the Git repository is usually initialized automatically, after you create it.
						</div></li><li class="listitem"><div class="para">
							You must ensure that all of your Fabric servers are able to access the external Git repository. For example, if your Git server uses a HTTP based protocol to access the repository, you are generally required to have username/password credentials for the HTTP BASIC authentication protocol.
						</div></li></ul></div></section><section class="simplesect" id="idp16972288"><div class="titlepage"><div><div><h3 class="title">Authentication</h3></div></div></div><div class="para">
					In this architecture, authentication is handled by the external Git repository (and the Git server that hosts it). The most common cases are:
				</div><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><div class="para">
							<span class="emphasis"><em>HTTP URL</em></span>—in this case, the Git server is likely to use HTTP with TLS (HTTPS), to verify the server identity, and HTTP BASIC authentication, to verify the client identity. When creating the fabric (with the <code class="code">fabric:create</code> command), you need to specify the following additional options in this case:
						</div><div class="itemizedlist"><ul class="itemizedlist" type="circle"><li class="listitem"><div class="para">
									<code class="code">--external-git-url <em class="replaceable">ExternalGitHttpUrl</em></code>
								</div></li><li class="listitem"><div class="para">
									<code class="code">--external-git-user <em class="replaceable">ExternalGitUser</em></code>
								</div></li><li class="listitem"><div class="para">
									<code class="code">--external-git-password <em class="replaceable">ExternalGitPass</em></code>
								</div></li></ul></div></li><li class="listitem"><div class="para">
							<span class="emphasis"><em>File URL</em></span>—in this case, no authentication is required. You can specify the Git URL either in the form <code class="code">/path/to/repo</code> (recommended) or <code class="code">file:///path/to/repo</code> (slower). If the Fabric servers are deployed on separate hosts, you must make sure that they all have access to the specified directory (for example, through a Network File Server). When creating the fabric (with the <code class="code">fabric:create</code> command), you need to specify the following additional options in this case:
						</div><div class="itemizedlist"><ul class="itemizedlist" type="circle"><li class="listitem"><div class="para">
									<code class="code">--external-git-url <em class="replaceable">ExternalGitFileUrl</em></code>
								</div></li></ul></div></li></ul></div></section><section class="simplesect" id="idp6322592"><div class="titlepage"><div><div><h3 class="title">Creating a fabric with an external Git repository</h3></div></div></div><div class="para">
					Typically, to create a fabric with an external Git repository, you would enter a console command like the following:
				</div><pre class="programlisting">fabric:create --new-user admin --new-user-password <em class="replaceable">AdminPass</em> --new-user-role Administrator \
  --zookeeper-password <em class="replaceable">ZooPass</em> --global-resolver manualip \
  --resolver manualip --manual-ip <em class="replaceable">StaticIPAddress</em> --wait-for-provisioning \
  --external-git-url <em class="replaceable">ExternalGitHttpUrl</em> \
  --external-git-user <em class="replaceable">ExternalGitUser</em> --external-git-password <em class="replaceable">ExternalGitPass</em></pre><div class="para">
					Note the following points:
				</div><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><div class="para">
							A new user is created with username, <code class="code">admin</code>, password, <code class="code"><em class="replaceable">AdminPass</em></code>, and role, <code class="code">Administrator</code>. You can use these JAAS credentials to log on to any of the containers in the fabric.
						</div></li><li class="listitem"><div class="para">
							The Zookeeper password is set to <code class="code"><em class="replaceable">ZooPass</em></code> (the only time you are prompted to enter the Zookeeper password is when joining a container to the fabric).
						</div></li><li class="listitem"><div class="para">
							The resolver policy for the root container is set to <code class="code">manualip</code> (using the <code class="code">--resolver</code> option) and the global resolver policy (which becomes the default resolver policy for containers created in this fabric) is also set to <code class="code">manualip</code>. This enables you to specify the root container's IP address, <code class="code"><em class="replaceable">StaticIPAddress</em></code>, explicitly. It is essential that you assign a static IP address to the Fabric server host (for demonstrations and tests on a single machine, you can use the loopback address, <code class="code">127.0.0.1</code>).
						</div></li><li class="listitem"><div class="para">
							The Git URL, <code class="code"><em class="replaceable">ExternalGitHttpUrl</em></code>, is specified through the <code class="code">--external-git-url</code> option.
						</div></li><li class="listitem"><div class="para">
							Assuming that you use a HTTP Git URL with BASIC authentication enabled, you will also need to specify credentials, using the <code class="code">--external-git-user</code> and <code class="code">--external-git-password</code> options.
						</div></li></ul></div></section><section class="simplesect" id="idp51935920"><div class="titlepage"><div><div><h3 class="title">What happens if the external Git repository fails?</h3></div></div></div><div class="para">
					Because the external Git repository is the primary Git repository, which is used to synchronize configuration data with the other Fabric servers, it is technically a single point of failure. The effect of a failure of the external Git repository is not as serious as you might think, however. It does <span class="emphasis"><em>not</em></span> lead to a failure of the Fabric servers. In case of an external Git repository failure (or a loss of connectivity) the Fabric servers continue to operate with the configuration data they have already cached in their local copies of the Git repository. As soon as the external Git repository comes back on line, they will re-synchronize their configuration data.
				</div></section><section class="simplesect" id="idp20293168"><div class="titlepage"><div><div><h3 class="title">External Git repository tutorial</h3></div></div></div><div class="para">
					The following tutorial explains how to create a fabric, which synchronizes its configuration with an external Git repository:
				</div><div class="procedure"><ol class="procedure" type="1"><li class="step"><div class="para">
							Create a new (empty) Git repository, which you can use as the external Git repository. Typically, you would create the Git repository in a hosting service, such as GitLab, Gerrit, or GitHub. Make a note of the new repository's HTTP URL, <code class="code"><em class="replaceable">ExternalGitHttpUrl</em></code>, and make sure that it is possible to access the external Git repository from the hosts where you will be deploying your Fabric servers.
						</div></li><li class="step"><div class="para">
							<span class="emphasis"><em>(Optional)</em></span> Prepare the container for a cold start. Delete the following directories:
						</div><pre class="programlisting"><em class="replaceable">InstallDir</em>/data
<em class="replaceable">InstallDir</em>/instances</pre><div class="admonition warning"><div class="admonition_header">Warning</div><div><div class="para">
								Performing a cold start completely wipes the current state of the root container, including all of the deployed bundles, and features, and most of the stored data. Do <span class="emphasis"><em>not</em></span> perform this operation on a production system.
							</div></div></div></li><li class="step"><div class="para">
							Start up the container, by entering the following command:
						</div><pre class="programlisting">./bin/fuse</pre></li><li class="step"><div class="para">
							Create a new fabric. At the container prompt, enter the following console command:
						</div><pre class="programlisting">fabric:create --new-user admin --new-user-password <em class="replaceable">AdminPass</em> --new-user-role Administrator \
  --zookeeper-password <em class="replaceable">ZooPass</em> --global-resolver manualip \
  --resolver manualip --manual-ip 127.0.0.1 --wait-for-provisioning \
  --external-git-url <em class="replaceable">ExternalGitHttpUrl</em> \
  --external-git-user <em class="replaceable">ExternalGitUser</em> --external-git-password <em class="replaceable">ExternalGitPass</em></pre><div class="para">
							You need to substitute your own values for <code class="code"><em class="replaceable">AdminPass</em></code> and <code class="code"><em class="replaceable">ZooPass</em></code>. The <code class="code"><em class="replaceable">ExternalGitHttpUrl</em></code> is the HTTP URL of the external Git repository you created earlier and the <code class="code"><em class="replaceable">ExternalGitUser</em></code> value and the <code class="code"><em class="replaceable">ExternalGitPass</em></code> value are the username/password credentials required to access the external Git repository (using HTTP BASIC authentication).
						</div><div class="para">
							This sample command uses the <code class="code">--manual-ip</code> option to assign the loopback address, <code class="code">127.0.0.1</code>, to the root container. If your host has a static IP address and hostname assigned to it, however, it would be better to use the assigned hostname here instead.
						</div><div class="para">
							You need to wait a minute or two for this command to complete.
						</div></li><li class="step"><div class="para">
							After your fabric has been created, navigate to the contents of the external Git repository in your browser (assuming that your Git server supports this functionality). The external repository should now be populated with the default configuration of your fabric, with two branches available: <code class="code">master</code> and <code class="code">1.0</code>. The <code class="code">1.0</code> branch is the branch that is initially used by your fabric.
						</div></li><li class="step"><div class="para">
							Create a local clone of the external Git repository, which you can then use to push or pull profile configurations. Open a new command prompt and, in a convenient location on the file system, enter the following command:
						</div><pre class="programlisting">git clone -b 1.0 <code class="code"><em class="replaceable">ExternalGitHttpUrl</em></code></pre><div class="para">
							This <code class="code">git</code> command will prompt you to enter the username and password credentials for the external Git repository.
						</div><div class="para">
							This command clones the Fabric Git repository and checks out the <code class="code">1.0</code> branch. You should now be able to see the profile configuration files under the <code class="code">fabric/profiles</code> subdirectory.
						</div></li><li class="step"><div class="para">
							You can now use regular <code class="code">git</code> commands to configure your Fabric profiles. Simply edit the files in your local Git repository, add the changes, commit, and then push the changes to the external Git repository (working in the <code class="code">1.0</code> branch). Shortly after the changes are pushed to the external Git repository, the containers in your Fabric ensemble (the Fabric servers) will poll the repository, pull the changes, and redeploy any changed profiles..
						</div></li></ol></div></section></section><section class="section" id="Git_HTTP-proxy"><div class="titlepage"><div><div><h2 class="title">14.5. Using an HTTP Proxy with a Git Cluster</h2></div></div></div><div class="para">
					Using fabric's built-in Git cluster, all nodes communicate directly with each other over HTTP. If you need to secure this communication, you can configure an HTTP proxy by configuring the <span class="property">GitProxyService</span>.
				</div><div class="procedure"><ol class="procedure" type="1"><li class="step"><div class="para">
							Start up JBoss Fuse, and create a fabric. For details, see <a class="xref" href="#topic-32522" title="Steps to create the fabric">the section called “Steps to create the fabric”</a>.
						</div></li><li class="step"><div class="para">
							At the <code class="code">JBossFuse:karaf@root&gt;</code> command line, type:
						</div><pre class="programlisting">profile-edit --pid io.fabric8.git.proxy/proxyHost=serverName default                          
profile-edit --pid io.fabric8.git.proxy/proxyPort=portNumber default</pre><div class="para">
							These commands specify the hostname and port to use, and the <code class="filename">default</code> profile is updated with the new configuration.
						</div><div class="para">
							For example:
						</div><pre class="programlisting">profile-edit --pid io.fabric8.git.proxy/proxyHost=10.8.50.60 default                          
profile-edit --pid io.fabric8.git.proxy/proxyPort=3128 default</pre><div class="para">
							All changes made to the fabric configuration will now be redirected to the Git HTTP proxy on host <code class="literal">10.8.50.60</code>'s port <code class="literal">3128</code>.
						</div></li></ol></div></section></section><section class="chapter" id="Patching"><div class="titlepage"><div><div><h2 class="title">Chapter 15. Patching</h2></div></div></div><section class="section" id="ESBRuntimePatchFabric"><div class="titlepage"><div><div><h2 class="title">15.1. Patching a Container in a Fabric</h2></div><div><div class="abstract"><p class="title"><strong>Abstract</strong></p><div class="para">
							In a fabric patches are applied to profiles and the patched version of the profile is applied to the container. The management console is the recommended tool for patching containers in a fabric. The <span class="command"><strong>fabric</strong></span> shell also has the commands needed to apply a patch and roll it out to running containers.
						</div></div></div></div></div><section class="simplesect" id="topic-32417"><div class="titlepage"><div><div><h3 class="title">Overview</h3></div></div></div><div class="para">
					The bundles loaded by a container in a fabric are controlled by the container's Fabric Agent. The agent inspects the profiles applied to the container to determine what bundles to load, and the version of each bundle, and then loads the specified version of each bundle for the container.
				</div><div class="para">
					A patch typically includes a new version of one or more bundles, so to apply the patch to a container in a fabric you need to update the profiles applied to it. This will cause the Fabric Agent to load the patched versions of the bundles.
				</div><div class="para">
					The management console is the recommended tool for patching containers in a fabric. However, the command console's <span class="command"><strong>fabric</strong></span> shell also provides the commands needed to patch containers running in a fabric.
				</div></section><section class="simplesect" id="idp23226176"><div class="titlepage"><div><div><h3 class="title">Is it necessary to patch the underlying container?</h3></div></div></div><div class="para">
					In general, when you want to patch a fabric, it is <span class="emphasis"><em>not</em></span> necessary to patch the underlying container as well (for example, by following the instructions in <a class="xref" href="#">???</a>). Fabric has its own mechanisms for distributing patch artefacts (for example, using a git repository for the profile data, and Apache Maven for the OSGi bundles), which are independent of the underlying container installation.
				</div><div class="admonition note"><div class="admonition_header">Note</div><div><div class="para">
						In exceptional cases, however, it might be necessary to patch the underlying container (for example, if there was an issue with the <code class="code">fabric:create</code> command). Always read the patch <code class="code">README</code> file to find out whether there are any special steps required to install a particular patch.
					</div></div></div></section><section class="simplesect" id="topic-32419"><div class="titlepage"><div><div><h3 class="title">Using the management console</h3></div></div></div><a id="idp13698704" class="indexterm"></a><div class="para">
					The management console is the easiest and most verbose method of patching containers in a fabric. Its <span class="guilabel">Patching</span> tab uploads patches to a fabric's Maven repository and applies the patch to a specified profile version. You can then use the management console to roll the patch out to all of the containers in the fabric.
				</div><div class="para">
					See <a class="link" href="https://access.redhat.com/documentation/en-US/Red_Hat_JBoss_Fuse/6.2/html/Management_Console_User_Guide/FMCUG_Fabric_Patching.html">chapter "Patching a Fabric" in "Management Console User Guide"</a> for more information.
				</div></section><section class="simplesect" id="topic-32420"><div class="titlepage"><div><div><h3 class="title">Using the command console</h3></div></div></div><a id="idp51129520" class="indexterm"></a><a id="idm8567360" class="indexterm"></a><div class="para">
					The Red Hat JBoss Fuse command console can also be used to patch containers running in a fabric. To patch a fabric container:
				</div><div class="procedure"><ol class="procedure" type="1"><li class="step"><div class="para">
							Before you proceed to install the patch, make sure to read the text of the <code class="code">README</code> file that comes with the patch, as there might be additional <span class="emphasis"><em>manual steps</em></span> required to install a particular patch.
						</div></li><li class="step"><div class="para">
							Create a new version, using the <code class="code">fabric:version-create</code> command:
						</div><pre class="programlisting">JBossFuse:karaf@root&gt; fabric:version-create 1.1
Created version: 1.1 as copy of: 1.0</pre><div class="admonition important"><div class="admonition_header">Important</div><div><div class="para">
								The version name must be a pure <span class="emphasis"><em>numeric</em></span> string, such as <code class="code">1.1</code>, <code class="code">1.2</code>, <code class="code">2.1</code>, or <code class="code">2.2</code>. You cannot incorporate alphabetic characters in the version name (such as <code class="code">1.0.patch</code>).
							</div></div></div></li><li class="step"><div class="para">
							Apply the patch to the new version, using the <code class="code">fabric:patch-apply</code> command. For example, to apply the <code class="code">activemq.zip</code> patch file to version <code class="code">1.1</code>:
						</div><pre class="programlisting">JBossFuse:karaf@root&gt; fabric:patch-apply --version 1.1 file:///patches/activemq.zip</pre></li><li class="step"><div class="para">
							Upgrade the container using the <code class="code">fabric:container-upgrade</code> command, specifying which container you want to upgrade. For example, to upgrade the <code class="code">root</code> container, enter the following command:
						</div><pre class="programlisting">JBossFuse:karaf@root&gt; fabric:container-upgrade 1.1 root
Upgraded container root from version 1.0 to 1.1</pre><div class="admonition important"><div class="admonition_header">Important</div><div><div class="para">
								It is recommended that you upgrade only one or two containers to the patched profile version, to ensure that the patch does not introduce any new issues. When you are certain that the patch works as expected, upgrade the remaining containers in the fabric.
							</div></div></div></li><li class="step"><div class="para">
							You can check that the new patch profile has been created using the <code class="code">fabric:profile-list</code> command, as follows:
						</div><pre class="programlisting">BossFuse:karaf@root&gt; fabric:profile-list --version 1.1 | grep patch
default                                  0              patch-activemq-patch
patch-activemq-patch</pre><div class="para">
							Where we presume that the patch was applied to profile version 1.1.
						</div><div class="admonition tip"><div class="admonition_header">Tip</div><div><div class="para">
							If you want to avoid specifying the profile version (with <code class="code">--version</code>) every time you invoke a profile command, you can change the default profile version using the <code class="code">fabric:version-set-default <em class="replaceable">Version</em></code> command.
						</div></div></div><div class="para">
							You can also check whether specific JARs are included in the patch, for example:
						</div><pre class="programlisting">JBossFuse:karaf@root&gt; list | grep -i activemq
[ 131] [Active     ] [Created     ] [       ] [   50] activemq-osgi (5.9.0.redhat-61037X)
[ 139] [Active     ] [Created     ] [       ] [   50] activemq-karaf (5.9.0.redhat-61037X)
[ 207] [Active     ] [            ] [       ] [   60] activemq-camel (5.9.0.redhat-61037X)</pre></li></ol></div></section></section></section></div><section class="appendix" id="ProfileEdit"><div class="titlepage"><div><div><h1 class="title">Appendix A. Editing Profiles with the Built-In Text Editor</h1></div><div><div class="abstract"><p class="title"><strong>Abstract</strong></p><div class="para">
					When you have a lot of changes and additions to make to a profile's configuration, it is usually more convenient to do this interactively, using the built-in text editor for profiles. The editor can be accessed by entering the <code class="code">profile-edit</code> command with no arguments except for the profile's name (and optionally, version); or adding the <code class="code">--pid</code> option for editing OSGi PID properties; or adding the <code class="code">--resource</code> option for editing general resources.
				</div></div></div></div></div><section class="section" id="ProfileEdit-AgentProps"><div class="titlepage"><div><div><h2 class="title">A.1. Editing Agent Properties</h2></div></div></div><section class="simplesect" id="topic-32318"><div class="titlepage"><div><div><h3 class="title">Overview</h3></div></div></div><div class="para">
				This section explains how to use the built-in text editor to modify a profile's <em class="firstterm">agent properties</em>, which are mainly used to define what bundles and features are deployed by the profile.
			</div></section><section class="simplesect" id="topic-32319"><div class="titlepage"><div><div><h3 class="title">Open the agent properties resource</h3></div></div></div><div class="para">
				To start editing a profile's agent properties using the built-in text editor, enter the following console command:
			</div><pre class="programlisting">JBossFuse:karaf@root&gt; profile-edit <em class="replaceable">Profile</em> [<em class="replaceable">Version</em>]</pre><div class="para">
				Where <code class="code"><em class="replaceable">Profile</em></code> is the name of the profile to edit and you can optionally specify the profile version, <em class="replaceable">Version</em>, as well. The text editor opens in the console window, showing the current profile name and version in the top-left corner of the Window. The bottom row of the editor screen summarizes the available editing commands and you can use the arrow keys to move about the screen.
			</div></section><section class="simplesect" id="topic-32320"><div class="titlepage"><div><div><h3 class="title">Specifying feature repository locations</h3></div></div></div><div class="para">
				To specify the location of a feature repository, add a line in the following format:
			</div><pre class="programlisting">repository.<em class="replaceable">ID</em>=<em class="replaceable">URL</em></pre><div class="para">
				Where <code class="code"><em class="replaceable">ID</em></code> is an arbitrary unique identifier and <code class="code"><em class="replaceable">URL</em></code> gives the location of a single feature repository (only one repository URL can be specified on a line).
			</div></section><section class="simplesect" id="topic-32321"><div class="titlepage"><div><div><h3 class="title">Specifying deployed features</h3></div></div></div><div class="para">
				To specify a feature to deploy (which must be available from one of the specified feature repositories), add a line in the following format:
			</div><pre class="programlisting">feature.<em class="replaceable">ID</em>=<em class="replaceable">FeatureName</em></pre><div class="para">
				Where <code class="code"><em class="replaceable">ID</em></code> is an arbitrary unique identifier and <code class="code"><em class="replaceable">FeatureName</em></code> is the name of a feature.
			</div></section><section class="simplesect" id="topic-32322"><div class="titlepage"><div><div><h3 class="title">Specifying deployed bundles</h3></div></div></div><div class="para">
				To specify a bundle to deploy, add a line in the following format:
			</div><pre class="programlisting">bundle.<em class="replaceable">ID</em>=<em class="replaceable">URL</em></pre><div class="para">
				Where <code class="code"><em class="replaceable">ID</em></code> is an arbitrary unique identifier and <code class="code"><em class="replaceable">URL</em></code> specifies the bundle's location.
			</div><div class="admonition note"><div class="admonition_header">Note</div><div><div class="para">
					A bundle entry can be used in combination with a <code class="code">blueprint:</code> (or <code class="code">spring:</code>) URL handler to deploy a Blueprint XML resource (or a Spring XML resource) as an OSGi bundle.
				</div></div></div></section><section class="simplesect" id="topic-32323"><div class="titlepage"><div><div><h3 class="title">Specifying bundle overrides</h3></div></div></div><div class="para">
				To specify a bundle override, add a line in the following format:
			</div><pre class="programlisting">override.<em class="replaceable">ID</em>=<em class="replaceable">URL</em></pre><div class="para">
				Where <code class="code"><em class="replaceable">ID</em></code> is an arbitrary unique identifier and <code class="code"><em class="replaceable">URL</em></code> specifies the bundle's location.
			</div><div class="admonition note"><div class="admonition_header">Note</div><div><div class="para">
					A bundle override is used to override a bundle installed by a feature, replacing it with a different version of the bundle. For example, this functionality is used by the patching system to install a patched bundle in a container.
				</div></div></div></section><section class="simplesect" id="topic-32325"><div class="titlepage"><div><div><h3 class="title">Specifying etc/config.properties properties</h3></div></div></div><div class="para">
				To specify Java system properties that affect the Apache Karaf container (analogous to editing <code class="code">etc/config.properties</code> in a standalone container), add a line in the following format:
			</div><pre class="programlisting">config.<em class="replaceable">Property</em>=<em class="replaceable">Value</em></pre></section><section class="simplesect" id="topic-32326"><div class="titlepage"><div><div><h3 class="title">Specifying etc/system.properties properties</h3></div></div></div><div class="para">
				To specify Java system properties that affect the bundles deployed in the container (analogous to editing <code class="code">etc/system.properties</code> in a standalone container), add a line in the following format:
			</div><pre class="programlisting">system.<em class="replaceable">Property</em>=<em class="replaceable">Value</em></pre><div class="para">
				If the system property, <code class="code"><em class="replaceable">Property</em></code>, is already set at the JVM level (for example, through the <code class="code">--jvm-opts</code> option to the <code class="code">fabric:container-create</code> command), the preceding <code class="code">fabric:profile-edit</code> command <span class="emphasis"><em>will not override the JVM level setting</em></span>. To override a JVM level setting, set the system property as follows:
			</div><pre class="programlisting">system.karaf.override.<em class="replaceable">Property</em>=<em class="replaceable">Value</em></pre></section><section class="simplesect" id="topic-32327"><div class="titlepage"><div><div><h3 class="title">Specifying libraries to add to Java runtime lib/</h3></div></div></div><div class="para">
				To specify a Java library to deploy (equivalent to adding a library to the <code class="code">lib/</code> directory of the underlying Java runtime), add a line in the following format:
			</div><div class="informalexample"><pre class="programlisting">lib.<em class="replaceable">ID</em>=<em class="replaceable">URL</em></pre></div><div class="para">
				Where <code class="code"><em class="replaceable">ID</em></code> is an arbitrary unique identifier and <code class="code"><em class="replaceable">URL</em></code> specifies the library's location.
			</div></section><section class="simplesect" id="topic-32328"><div class="titlepage"><div><div><h3 class="title">Specifying libraries to add to Java runtime lib/ext/</h3></div></div></div><div class="para">
				To specify a Java extension library to deploy (equivalent to adding a library to the <code class="code">lib/ext/</code> directory of the underlying Java runtime), add a line in the following format:
			</div><div class="informalexample"><pre class="programlisting">ext.<em class="replaceable">ID</em>=<em class="replaceable">URL</em></pre></div><div class="para">
				Where <code class="code"><em class="replaceable">ID</em></code> is an arbitrary unique identifier and <code class="code"><em class="replaceable">URL</em></code> specifies the extension library's location.
			</div></section><section class="simplesect" id="topic-32329"><div class="titlepage"><div><div><h3 class="title">Specifying libraries to add to Java runtime lib/endorsed/</h3></div></div></div><div class="para">
				To specify a Java endorsed library to deploy (equivalent to adding a library to the <code class="code">lib/endorsed/</code> directory of the underlying Java runtime), add a line in the following format:
			</div><div class="informalexample"><pre class="programlisting">endorsed.<em class="replaceable">ID</em>=<em class="replaceable">URL</em></pre></div><div class="para">
				Where <code class="code"><em class="replaceable">ID</em></code> is an arbitrary unique identifier and <code class="code"><em class="replaceable">URL</em></code> specifies the endorsed library's location.
			</div></section><section class="simplesect" id="topic-32330"><div class="titlepage"><div><div><h3 class="title">Example</h3></div></div></div><div class="para">
				To open the <code class="code">mq-client</code> profile's agent properties for editing, enter the following console command:
			</div><pre class="programlisting">JBossFuse:karaf@root&gt; profile-edit mq-client</pre><div class="para">
				The text editor starts up, and you should see the following screen in the console window:
			</div><pre class="programlisting">Profile:mq-client 1.0                                                                 L:1 C:1
#
# Copyright (C) Red Hat, Inc.
# http://redhat.com
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#    http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#

repository.activemq=mvn:org.apache.activemq/activemq-karaf/${version:activemq}/xml/features
repository.karaf-standard=mvn\:org.apache.karaf.assemblies.features/standard/${version:karaf}/
xml/features

     ^X Quit    ^S Save    ^Z Undo    ^R Redo    ^G Go To    ^F Find    ^N Next    ^P Previous</pre><div class="para">
				Type <code class="code">^X</code> to quit the text editor and get back to the console prompt.
			</div></section></section><section class="section" id="ProfileEdit-PIDProps"><div class="titlepage"><div><div><h2 class="title">A.2. Editing OSGi Config Admin Properties</h2></div></div></div><section class="simplesect" id="topic-32331"><div class="titlepage"><div><div><h3 class="title">Overview</h3></div></div></div><div class="para">
				This section explains how to use the built-in text editor to edit the property settings associated with a specific persistent ID.
			</div></section><section class="simplesect" id="topic-32332"><div class="titlepage"><div><div><h3 class="title">Persistent ID</h3></div></div></div><div class="para">
				In the context of the OSGi Config Admin service, a <em class="firstterm">persistent ID</em> (PID) refers to and identifies a set of related properties. In particular, when defining PID property settings in a profile, the properties associated with the <code class="code"><em class="replaceable">PID</em></code> persistent ID are defined in the <code class="code"><em class="replaceable">PID</em>.properties</code> resource.
			</div></section><section class="simplesect" id="topic-32333"><div class="titlepage"><div><div><h3 class="title">Open the Config Admin properties resource</h3></div></div></div><div class="para">
				To start editing the properties associated with the <code class="code"><em class="replaceable">PID</em></code> persistent ID, enter the following console command:
			</div><pre class="programlisting">JBossFuse:karaf@root&gt; profile-edit --pid <em class="replaceable">PID</em> <em class="replaceable">Profile</em> [<em class="replaceable">Version</em>]</pre><div class="admonition note"><div class="admonition_header">Note</div><div><div class="para">
					It is also possible to edit PID properties by specifying <code class="code">--resource <em class="replaceable">PID</em>.properties</code> in the <code class="code">profile-edit</code> command, instead of using the <code class="code">--pid <em class="replaceable">PID</em></code> option.
				</div></div></div></section><section class="simplesect" id="topic-32334"><div class="titlepage"><div><div><h3 class="title">Specifying OSGi config admin properties</h3></div></div></div><div class="para">
				The text editor opens, showing the contents of the specified profile's <code class="code"><em class="replaceable">PID</em>.properties</code> resource (which is actually stored in the ZooKeeper registry). To edit the properties, add, modify, or delete lines of the following form:
			</div><pre class="programlisting"><em class="replaceable">Property</em>=<em class="replaceable">Value</em></pre></section><section class="simplesect" id="topic-32335"><div class="titlepage"><div><div><h3 class="title">Example</h3></div></div></div><div class="para">
				To edit the properties for the <code class="code">io.fabric8.hadoop</code> PID in the <code class="code">hadoop-base</code> profile, enter the following console command:
			</div><pre class="programlisting">JBossFuse:karaf@root&gt; profile-edit --resource io.fabric8.hadoop.properties hadoop-base 1.0</pre><div class="para">
				The text editor starts up, and you should see the following screen in the console window:
			</div><pre class="programlisting">Profile:hadoop-base 1.0                                                               L:1 C:1
#
# Copyright (C) Red Hat, Inc.
# http://redhat.com
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#    http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#

fs.default.name=hdfs\://localhost\:9000
dfs.replication=1
mapred.job.tracker=localhost\:9001
dfs.name.dir=${karaf.data}/hadoop/dfs/name
dfs.http.address=0.0.0.0\:9002
dfs.data.dir=${karaf.data}/hadoop/dfs/data
dfs.name.edits.dir=${karaf.data}/hadoop/dfs/name

     ^X Quit    ^S Save    ^Z Undo    ^R Redo    ^G Go To    ^F Find    ^N Next    ^P Previous</pre><div class="para">
				You might notice that colon characters are escaped in this example (as in <code class="code">\:</code>). Strictly speaking, it is only necessary to escape a colon if it appears as part of a property name (left hand side of the equals sign), but the <code class="code">profile-edit</code> command automatically escapes all colons when it writes to a resource. When manually editing resources using the text editor, however, you do not need to escape colons in URLs appearing on the right hand side of the equals sign.
			</div><div class="para">
				Type <code class="code">^X</code> to quit the text editor and get back to the console prompt.
			</div></section></section><section class="section" id="ProfileEdit-OtherResources"><div class="titlepage"><div><div><h2 class="title">A.3. Editing Other Resources</h2></div></div></div><section class="simplesect" id="topic-32336"><div class="titlepage"><div><div><h3 class="title">Overview</h3></div></div></div><div class="para">
				In addition to agent properties and PID properties, the built-in text editor makes it possible for you edit <span class="emphasis"><em>any</em></span> resource associated with a profile. This is particularly useful, if you need to store additional configuration files in a profile. The extra configuration files can be stored as profile resources (which actually correspond to ZooKeeper nodes) and then can be accessed by your applications at run time.
			</div><div class="admonition note"><div class="admonition_header">Note</div><div><div class="para">
					The ZooKeeper registry is designed to work with small nodes only. If you try to store a massive configuration file as a profile resource, it will severely degrade the performance of the Fabric registry.
				</div></div></div></section><section class="simplesect" id="topic-32337"><div class="titlepage"><div><div><h3 class="title">Creating and editing an arbitrary resource</h3></div></div></div><div class="para">
				You can create and edit arbitrary profile resources using the following command syntax:
			</div><pre class="programlisting">JBossFuse:karaf@root&gt; profile-edit --resource <em class="replaceable">Resource</em> <em class="replaceable">Profile</em> [<em class="replaceable">Version</em>]</pre><div class="para">
				Where <code class="code"><em class="replaceable">Resource</em></code> is the name of the profile resource you want to edit. If <code class="code"><em class="replaceable">Resource</em></code> does not already exist, it will be created.
			</div></section><section class="simplesect" id="topic-32338"><div class="titlepage"><div><div><h3 class="title">broker.xml example</h3></div></div></div><div class="para">
				For example, the <code class="code">mq-base</code> profile has the <code class="code">broker.xml</code> resource, which stores the contents of an Apache ActiveMQ broker configuration file. To edit the <code class="code">broker.xml</code> resource, enter the following console command:
			</div><pre class="programlisting">JBossFuse:karaf@root&gt; profile-edit --resource broker.xml mq-base 1.0</pre><div class="para">
				The text editor starts up, and you should see the following screen in the console window:
			</div><pre class="programlisting">Profile:mq-base 1.0                                                                       L:1 C:1
&lt;!--
  Copyright (C) FuseSource, Inc.
  http://fusesource.com

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

     http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
  --&gt;
&lt;beans
  xmlns="http://www.springframework.org/schema/beans"
  xmlns:amq="http://activemq.apache.org/schema/core"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd
  http://activemq.apache.org/schema/core http://activemq.apache.org/schema/core/activemq-core.xsd"&gt;

    &lt;!-- Allows us to use system properties and fabric as variables in this configuration file --&gt;
    &lt;bean class="org.springframework.beans.factory.config.PropertyPlaceholderConfigurer"&gt;
        &lt;property name="properties"&gt;
            &lt;bean class="org.fusesource.mq.fabric.ConfigurationProperties"/&gt;
        &lt;/property&gt;

      ^X Quit    ^S Save    ^Z Undo    ^R Redo    ^G Go To    ^F Find    ^N Next    ^P Previous</pre><div class="para">
				Any changes you make to this file will take effect whenever the broker restarts.
			</div><div class="para">
				Type <code class="code">^X</code> to quit the text editor and get back to the console prompt.
			</div></section><section class="simplesect" id="topic-32339"><div class="titlepage"><div><div><h3 class="title">Referencing a profile resource</h3></div></div></div><div class="para">
				In order to use an arbitrary profile resource, you must be able to reference it. Because a profile resource is ultimately stored as a ZooKeeper node, you must reference it using a ZooKeeper URL. For example, the <code class="code">broker.xml</code> resource from the previous example is stored under the following ZooKeeper location:
			</div><pre class="programlisting">zk:/fabric/configs/versions/1.0/profiles/mq-base/broker.xml</pre><div class="para">
				In general, you can find version, <code class="code"><em class="replaceable">Version</em></code>, of the <code class="code"><em class="replaceable">Profile</em></code> profile's <code class="code"><em class="replaceable">Resource</em></code> resource at the following location:
			</div><pre class="programlisting">zk:/fabric/configs/versions/<em class="replaceable">Version</em>/profiles/<em class="replaceable">Profile</em>/<em class="replaceable">Resource</em></pre><div class="para">
				For example, the <code class="code">mq</code> profile's <code class="code">org.fusesource.mq.fabric.server-broker</code> PID defines the following properties, where the <code class="code">config</code> property references the <code class="code">broker.xml</code> resource:
			</div><pre class="programlisting">connectors=openwire
config=<span class="bold bold"><strong>zk\:/fabric/configs/versions/1.0/profiles/mq-base/broker.xml</strong></span>
group=default
standby.pool=default</pre></section></section><section class="section" id="ProfileEdit-Attributes"><div class="titlepage"><div><div><h2 class="title">A.4. Profile Attributes</h2></div></div></div><section class="simplesect" id="topic-32340"><div class="titlepage"><div><div><h3 class="title">Overview</h3></div></div></div><div class="para">
				In addition to the resources described in the other sections, a profile also has certain attributes that affect its behavior. <span class="emphasis"><em>You cannot edit profile attributes directly using the text editor.</em></span>
			</div><div class="para">
				For completeness, this section describes what the profile attributes are and what console commands you can use to modify them.
			</div></section><section class="simplesect" id="topic-32341"><div class="titlepage"><div><div><h3 class="title">parents attribute</h3></div></div></div><div class="para">
				The <code class="code">parents</code> attribute is a list of one or more parent profiles. This attribute can be set using the <code class="code">profile-change-parents</code> console command. For example, to assign the parent profiles <code class="code">camel</code> and <code class="code">cxf</code> to the <code class="code">my-camel-cxf-profile</code> profile, you would enter the following console command:
			</div><pre class="programlisting">JBossFuse:karaf@root&gt; profile-change-parents --version 1.0 my-camel-cxf-profile camel cxf</pre></section><section class="simplesect" id="topic-32342"><div class="titlepage"><div><div><h3 class="title">abstract attribute</h3></div></div></div><div class="para">
				When a profile's <code class="code">abstract</code> attribute is set to <code class="code">true</code>, the profile cannot be directly deployed to a container. This is useful for profiles that are only intended to be the parents of other profiles—for example, <code class="code">mq-base</code>. You can set the abstract attribute from the Management Console.
			</div></section><section class="simplesect" id="topic-32343"><div class="titlepage"><div><div><h3 class="title">locked attribute</h3></div></div></div><div class="para">
				A locked profile cannot be changed or edited until it is unlocked. You can lock or unlock a profile from the Management Console.
			</div></section><section class="simplesect" id="topic-32344"><div class="titlepage"><div><div><h3 class="title">hidden attribute</h3></div></div></div><div class="para">
				The <code class="code">hidden</code> attribute is a flag that is typically set on profiles that Fabric creates automatically (for example, to customize the setup of a registry server). By default, hidden profiles are not shown when you run the <code class="code">profile-list</code> command, but you can see them when you add the <code class="code">--hidden</code> flag, as follows:
			</div><pre class="programlisting">JBossFuse:karaf@root&gt; profile-list --hidden
...
fabric                                   1              karaf
<span class="bold bold"><strong>fabric-ensemble-0000 0 </strong></span>
<span class="bold bold"><strong>fabric-ensemble-0000-1 1 fabric-ensemble-0000</strong></span>
fmc                                      0              default
...</pre></section></section></section><section class="appendix" id="UrlHandlers"><div class="titlepage"><div><div><h1 class="title">Appendix B. Fabric URL Handlers</h1></div><div><div class="abstract"><p class="title"><strong>Abstract</strong></p><div class="para">
					The Fabric runtime provides a variety of URL handlers, which can be used in application code deployed in a Fabric-enabled container. These URLs are intended to be used in profile configuration files to locate configuration resources.
				</div></div></div></div></div><section class="section" id="topic-32429"><div class="titlepage"><div><div><h2 class="title">B.1. Profile URL handler</h2></div></div></div><div class="para">
				The profile URL is used to access resources stored under the current profile (or parent profile). It has the following format:
			</div><pre class="programlisting">profile:<em class="replaceable">ResourceName</em></pre><div class="para">
				A key characteristic of the profile URL is that the location of a resource can change dynamically at run time, as follows:
			</div><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><div class="para">
						The profile URL handler first tries to find the named resource, <code class="code"><em class="replaceable">ResourceName</em></code>, in the <span class="emphasis"><em>current version</em></span> of the <span class="emphasis"><em>current profile</em></span> (where the current version is a property of the container in which the profile is running).
					</div></li><li class="listitem"><div class="para">
						If the specified resource is not found in the current profile, the profile URL tries to find the resource in the current version of the <span class="emphasis"><em>parent profile</em></span>.
					</div></li></ol></div><div class="para">
				This behavior implies that whenever you change the version assigned to a container (for example, by invoking the <code class="code">fabric:container-upgrade</code> or <code class="code">fabric:container-rollback</code> console commands), the referenced resources are also, automatically, upgraded or rolled back.
			</div></section><section class="section" id="topic-32430"><div class="titlepage"><div><div><h2 class="title">B.2. Zk URL handler</h2></div></div></div><div class="para">
				You can reference the contents of a ZooKeeper node using the zk URL. The URL can be specified either as an absolute node:
			</div><pre class="programlisting">zk:/<em class="replaceable">PathToNode</em></pre><div class="para">
				Or you can reference configuration properties from a specific container using the following syntax:
			</div><pre class="programlisting">zk:<em class="replaceable">ContainerName</em>/<em class="replaceable">Property</em></pre><div class="para">
				The preceding syntax is effectively a short cut to the following URL reference:
			</div><pre class="programlisting">zk:/fabric/registry/containers/config/<em class="replaceable">ContainerName</em>/<em class="replaceable">Property</em></pre></section><section class="section" id="UrlHandlers-Vars-Blueprint"><div class="titlepage"><div><div><h2 class="title">B.3. Blueprint URL handler</h2></div></div></div><div class="para">
				The Blueprint URL handler enables you to deploy a Blueprint XML resource directly as an OSGi bundle, without needing to create any of the usual OSGi bundle packaging in advance. The <code class="code">blueprint:</code> scheme can be prefixed to any of the usual location URL handlers (for example, <code class="code">file:</code>, <code class="code">http:</code>, <code class="code">profile:</code>, <code class="code">zk:</code>).
			</div><div class="para">
				To use the Blueprint URL handler, create a <code class="code">bundle</code> entry in the agent properties (equivalent to the <code class="code">io.fabric8.agent</code> PID) in the following format:
			</div><pre class="programlisting">bundle.<em class="replaceable">ID</em>=blueprint:<em class="replaceable">LocationScheme</em>:<em class="replaceable">LocationOfBlueprintXML</em></pre><div class="para">
				For example, to activate the <code class="code">camel.xml</code> resource (Blueprint file) from the current profile, you would add the following <code class="code">bundle</code> entry:
			</div><pre class="programlisting">bundle.camel-fabric=blueprint:profile:camel.xml</pre><div class="admonition note"><div class="admonition_header">Note</div><div><div class="para">
					The Blueprint URL handler has an important side effect. If the referenced Blueprint resource is changed at run time, the Blueprint URL handler detects this change and automatically reloads the resource. This means, for example, that if you edit a deployed Camel route in a Blueprint resource, the route automatically gets updated in real time.
				</div></div></div></section><section class="section" id="UrlHandlers-Vars-Spring"><div class="titlepage"><div><div><h2 class="title">B.4. Spring URL handler</h2></div></div></div><div class="para">
				The Spring URL handler enables you to deploy a Spring XML resource directly as an OSGi bundle, without needing to create any of the usual OSGi bundle packaging in advance. The <code class="code">spring:</code> scheme can be prefixed to any of the usual location URL handlers (for example, <code class="code">file:</code>, <code class="code">http:</code>, <code class="code">profile:</code>, <code class="code">zk:</code>).
			</div><div class="para">
				To use the Spring URL handler, create a <code class="code">bundle</code> entry in the agent properties (equivalent to the <code class="code">io.fabric8.agent</code> PID) in the following format:
			</div><pre class="programlisting">bundle.<em class="replaceable">ID</em>=spring:<em class="replaceable">LocationScheme</em>:<em class="replaceable">LocationOfBlueprintXML</em></pre><div class="para">
				For example, to load the Spring resource, <code class="code">camel-spring.xml</code>, from the current profile, you could add the following entry to the profile's agent properties:
			</div><pre class="programlisting">bundle.spring-resource=spring:profile:camel-spring.xml</pre><div class="admonition note"><div class="admonition_header">Note</div><div><div class="para">
					If the referenced Spring resource is changed at run time, the Spring URL handler detects this change and automatically reloads the resource.
				</div></div></div></section></section><section class="appendix" id="Resolvers"><div class="titlepage"><div><div><h1 class="title">Appendix C. Profile Property Resolvers</h1></div><div><div class="abstract"><p class="title"><strong>Abstract</strong></p><div class="para">
					When defining properties for a profile, you can use a variable substitution mechanism, which has the general syntax <code class="code">${<em class="replaceable">ResourceReference</em>}</code>. This variable substitution mechanism can be used in <span class="emphasis"><em>any</em></span> profile resource, including the agent properties, PID properties, and other resources—for example, the <code class="code">mq-base</code> profile's <code class="code">broker.xml</code> resource references the <code class="code">${broker.name}</code> and <code class="code">${data}</code> variables.
				</div></div></div></div></div><section class="section" id="idm4490800"><div class="titlepage"><div><div><h2 class="title">C.1. Substituting system properties</h2></div></div></div><section class="simplesect" id="topic-32390"><div class="titlepage"><div><div><h3 class="title">Syntax</h3></div></div></div><div class="para">
				System properties can be substituted in a profile resource, using the following syntax:
			</div><pre class="programlisting">${<em class="replaceable">PropName</em>}</pre><div class="para">
				Where <code class="code"><em class="replaceable">PropName</em></code> can be the name of any Java system property. In particular, Java system properties can be defined in the following locations:
			</div><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><div class="para">
						The <code class="code">etc/system.properties</code> file, relative to the container's home directory.
					</div></li><li class="listitem"><div class="para">
						System property settings in the profile's agent properties.
					</div></li></ul></div><div class="para">
				Some of the more useful system properties defined in the <code class="code">etc/system.properties</code> file are, as follows:
			</div><div class="table" id="idp2164832"><p class="title"><strong>Table C.1. System Properties</strong></p><div class="table-contents"><table class="lt-4-cols lt-7-rows"><colgroup><col style="width: 50%; " class="c1"/><col style="width: 50%; " class="c2"/></colgroup><thead><tr><th>System Property</th><th>Description</th></tr></thead><tbody><tr><td><code class="code">${karaf.home}</code></td><td>The directory where Red Hat JBoss Fuse is installed.</td></tr><tr><td><code class="code">${karaf.data}</code></td><td>Location of the current container's data directory, which is usually <code class="code">${karaf.home}/data</code> for a main container or <code class="code">${karaf.home}/instances/<em class="replaceable">InstanceName</em>/data</code> for a child container.</td></tr><tr><td><code class="code">${karaf.name}</code></td><td>The name of the current container.</td></tr></tbody></table></div></div></section></section><section class="section" id="idp13339088"><div class="titlepage"><div><div><h2 class="title">C.2. Substituting environment variables</h2></div></div></div><section class="simplesect" id="topic-32391"><div class="titlepage"><div><div><h3 class="title">Syntax</h3></div></div></div><div class="para">
				You can substitute the value of a system environment variable using the environment property resolver, which has the following syntax:
			</div><pre class="programlisting">${env:<em class="replaceable">VarName</em>}</pre></section></section><section class="section" id="idp11800224"><div class="titlepage"><div><div><h2 class="title">C.3. Substituting container attributes</h2></div></div></div><section class="simplesect" id="topic-32392"><div class="titlepage"><div><div><h3 class="title">Syntax</h3></div></div></div><div class="para">
				You can substitute the value of a container attribute using the container attribute property resolver, which has the following syntax:
			</div><pre class="programlisting">${container:<em class="replaceable">Attribute</em>}</pre><div class="para">
				You can substitute any of the following container attributes:
			</div><div class="table" id="idp11765728"><p class="title"><strong>Table C.2. Container Attributes</strong></p><div class="table-contents"><table class="lt-4-cols lt-7-rows"><colgroup><col style="width: 50%; " class="c1"/><col style="width: 50%; " class="c2"/></colgroup><thead><tr><th>Attribute</th><th>Description</th></tr></thead><tbody><tr><td><code class="code">${container:resolver}</code></td><td>The effective <em class="firstterm">resolver policy</em> for the current container. Possible values are: <code class="code">localip</code>, <code class="code">localhostname</code>, <code class="code">publicip</code>, <code class="code">publichostname</code>, <code class="code">manualip</code>.</td></tr><tr><td><code class="code">${container:ip}</code></td><td>The effective IP address used by the current container, which has been selected by applying the resolver policy. This is the form of host address that is advertised to other containers and applications.</td></tr><tr><td><code class="code">${container:localip}</code></td><td>The numerical IP address of the current container, which is suitable for accessing the container on a LAN.</td></tr><tr><td><code class="code">${container:localhostname}</code></td><td>The host name of the current container, which is suitable for accessing the container on a LAN.</td></tr><tr><td><code class="code">${container:publicip}</code></td><td>The numerical IP address of the current container, which is suitable for accessing the container from a WAN (on the Internet).</td></tr><tr><td><code class="code">${container:publichostname}</code></td><td>The host name of the current container, which is suitable for accessing the container from a WAN (on the Internet).</td></tr><tr><td><code class="code">${container:manualip}</code></td><td>An IP address that is specified manually, by setting the value of the relevant node in the ZooKeeper registry.</td></tr><tr><td><code class="code">${container:bindaddress}</code></td><td> </td></tr><tr><td><code class="code">${container:sshurl}</code></td><td>The URL of the SSH service, which can be used to log on to the container console.</td></tr><tr><td><code class="code">${container:jmxurl}</code></td><td>The URL of the JMX service, which can be used to monitor the container.</td></tr><tr><td><code class="code">${container:jolokiaurl}</code></td><td>The URL of the Jolokia service, which is used by the Fuse Management Console to access the container.</td></tr><tr><td><code class="code">${container:httpurl}</code></td><td>The base URL of the container's default Jetty HTTP server.</td></tr><tr><td><code class="code">${container:domains}</code></td><td>List of JMX domains registered by the container.</td></tr><tr><td><code class="code">${container:processid}</code></td><td>Returns the process ID of the container process (on Linux-like and UNIX-like operating systems).</td></tr><tr><td><code class="code">${container:openshift}</code></td><td>A boolean flag that returns <code class="code">true</code>, if the container is running on OpenShift; otherwise, <code class="code">false</code>.</td></tr><tr><td><code class="code">${container:blueprintstatus}</code></td><td>The aggregate status of all the deployed Blueprint contexts. If all of the deployed contexts are ok, the status is <code class="code">ok</code>; if one or more deployed contexts have failed, the status is <code class="code">failed</code>.</td></tr><tr><td><code class="code">${container:springstatus}</code></td><td>The aggregate status of all the deployed Spring contexts. If all of the deployed contexts are ok, the status is <code class="code">ok</code>; if one or more deployed contexts have failed, the status is <code class="code">failed</code>.</td></tr><tr><td><code class="code">${container:provisionstatus}</code></td><td>Returns the container provision status.</td></tr><tr><td><code class="code">${container:provisionexception}</code></td><td>If the container provisioning has failed, this variable returns the provisioning exception.</td></tr><tr><td><code class="code">${container:provisionlist}</code></td><td>The list of provisioned artefacts in the container.</td></tr><tr><td><code class="code">${container:geolocation}</code></td><td>The geographic location of the container (which is obtained by making a Web request to a public service that gives the GPS coordinates of the container host).</td></tr></tbody></table></div></div></section></section><section class="section" id="idp53213952"><div class="titlepage"><div><div><h2 class="title">C.4. Substituting PID properties</h2></div></div></div><section class="simplesect" id="topic-32393"><div class="titlepage"><div><div><h3 class="title">Syntax</h3></div></div></div><div class="para">
				The profile property resolver is used to access PID properties from the current profile (or parent profile). It has the following format:
			</div><pre class="programlisting">${profile:<em class="replaceable">PID</em>/<em class="replaceable">Property</em>}</pre><div class="admonition note"><div class="admonition_header">Note</div><div><div class="para">
					This should not be confused with the syntax of a profile URL, which is used to access general resource files (not PID properties) and which is not resolved immediately (in contrast to the profile property resolver, which substitutes the corresponding property value as soon as the configuration file is read).
				</div></div></div></section><section class="simplesect" id="topic-32394"><div class="titlepage"><div><div><h3 class="title">Example using a profile property resolver</h3></div></div></div><div class="para">
				For example, the <code class="code">fabric</code> profile's <code class="code">io.fabric8.maven.properties</code> PID resource includes the following property setting:
			</div><pre class="programlisting">remoteRepositories=${profile:io.fabric8.agent/org.ops4j.pax.url.mvn.repositories}</pre><div class="para">
				So that the <code class="code">remoteRepositories</code> property is set to the value of the <code class="code">org.ops4j.pax.url.mvn.repositories</code> agent property (<code class="code">io.fabric8.agent</code> is the PID for the agent properties).
			</div></section></section><section class="section" id="idp10776320"><div class="titlepage"><div><div><h2 class="title">C.5. Substituting ZooKeeper node contents</h2></div></div></div><section class="simplesect" id="topic-32395"><div class="titlepage"><div><div><h3 class="title">Syntax</h3></div></div></div><div class="para">
				You can substitute the contents of a ZooKeeper node using the zk property resolver. The property resolver can be specified either as an absolute node:
			</div><pre class="programlisting">${zk:/<em class="replaceable">PathToNode</em>}</pre><div class="para">
				Or you can reference configuration properties from a specific container using the following syntax:
			</div><pre class="programlisting">${zk:<em class="replaceable">ContainerName</em>/<em class="replaceable">Property</em>}</pre><div class="para">
				The preceding syntax is effectively a short cut to the following property resolver:
			</div><pre class="programlisting">${zk:/fabric/registry/containers/config/<em class="replaceable">ContainerName</em>/<em class="replaceable">Property</em>}</pre></section><section class="simplesect" id="topic-32396"><div class="titlepage"><div><div><h3 class="title">Recursive variable substitution</h3></div></div></div><div class="para">
				It is also possible to use a variable within a variable (recursive substitution). For example, the <code class="code">dosgi</code> profile's <code class="code">io.fabric8.dosgi.properties</code> resource defines the following property:
			</div><pre class="programlisting">exportedAddress=${zk:${karaf.name}/ip}</pre></section><section class="simplesect" id="topic-32397"><div class="titlepage"><div><div><h3 class="title">How to reference the current version of a resource</h3></div></div></div><div class="para">
				A potential problem arises with ZooKeeper property resolver if you need to reference a ZooKeeper node that has a version number embedded in it. For example, suppose you want to reference the <code class="code">my-profile</code> profile's <code class="code">my-resource</code> resource, which can be done using the following ZooKeeper URL:
			</div><pre class="programlisting"> ${zk:/fabric/configs/versions/1.0/profiles/my-profile/my-resource}</pre><div class="para">
				Notice that the profile version number, <code class="code">1.0</code>, is embedded in this path. But if you decide to upgrade this profile to version <code class="code">1.1</code>, this means you must manually edit all occurrences of this ZooKeeper URL, changing the version number to <code class="code">1.1</code> in order to reference the upgraded resource. To avoid this extra work, and to ensure that the resolver always references the current version of the resource, you can use the following trick which exploits recursive variable substitution:
			</div><pre class="programlisting"> ${zk:/fabric/configs/versions/${zk:/fabric/configs/containers/${karaf.name}}/profiles/my-profile/my-resource}</pre><div class="para">
				This works because the <code class="code">/fabric/configs/containers/${karaf.name}</code> ZooKeeper node contains the current profile version deployed in the container.
			</div></section></section><section class="section" id="idp8698432"><div class="titlepage"><div><div><h2 class="title">C.6. Checksum property resolver</h2></div></div></div><section class="simplesect" id="topic-32398"><div class="titlepage"><div><div><h3 class="title">Syntax</h3></div></div></div><div class="para">
				The checksum property resolver can be used, if you want a resource to reload automatically at run time, whenever it is updated. The <code class="code">checksum:</code> scheme can be prefixed to any of the usual location URL handlers (for example, <code class="code">file:</code>, <code class="code">http:</code>, <code class="code">profile:</code>, <code class="code">zk:</code>).
			</div><div class="para">
				For example, the <code class="code">default</code> profile defines the following checksum property in the <code class="code">org.ops4j.pax.web</code> PID:
			</div><pre class="programlisting">org.ops4j.pax.web.config.checksum=${checksum:profile\:jetty.xml}</pre></section></section><section class="section" id="idp59537760"><div class="titlepage"><div><div><h2 class="title">C.7. Port property resolver</h2></div></div></div><section class="simplesect" id="topic-32399"><div class="titlepage"><div><div><h3 class="title">Syntax</h3></div></div></div><div class="para">
				The port property resolver is used to access the <em class="firstterm">port service</em>, which can automatically allocate an IP port within a specified range. It has the following syntax:
			</div><pre class="programlisting">${port:<em class="replaceable">Min</em>,<em class="replaceable">Max</em>}</pre><div class="para">
				Where <code class="code"><em class="replaceable">Min</em></code> and <code class="code"><em class="replaceable">Max</em></code> specify the minimum and maximum values of the allocated IP port.
			</div></section></section></section></div></div></div><script type="text/javascript">
                        current_book = 'Fabric_Guide';
                        current_version = '6.2';
                        current_product = 'Red_Hat_JBoss_Fuse';
                    

                        docs.init('../../../..', current_product, current_version, current_book);
                    </script></body></html>
